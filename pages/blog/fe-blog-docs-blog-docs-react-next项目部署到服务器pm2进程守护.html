<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>next项目部署到服务器pm2进程守护 - FrontendHub</title>
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/content.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="content-page">
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <a href="../../index.html" style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-code"></i>
                    <span>FrontendHub</span>
                </a>
            </div>
            <button class="nav-toggle" id="navToggle">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="nav-menu" id="navMenu">
                <li><a href="../../index.html">首页</a></li>
                <li><a href="../index.html#features">特色</a></li>
                <li><a href="../index.html#courses">课程</a></li>
                <li><a href="../index.html#resources">资源</a></li>
            </ul>
        </div>
    </nav>

    <!-- 面包屑导航 -->
    <div class="breadcrumb">
        <div class="container">
            <a href="../../index.html"><i class="fas fa-home"></i> 首页</a>
            <i class="fas fa-chevron-right"></i>
            <span>next项目部署到服务器pm2进程守护</span>
        </div>
    </div>

    <!-- 主要内容区 -->
    <main class="content-main">
        <div class="container">
            <div class="content-layout">
                <!-- 侧边栏目录 -->
                <aside class="sidebar">
                    <div class="sidebar-sticky">
                        <h3><i class="fas fa-list"></i> 目录</h3>
                        <nav class="toc" id="toc">
                            <!-- 目录将通过JavaScript自动生成 -->
                        </nav>
                    </div>
                </aside>

                <!-- 文章内容 -->
                <article class="article">
                    <header class="article-header">
                        <h1>next项目部署到服务器pm2进程守护</h1>
                        <div class="article-meta">
                            <span><i class="far fa-calendar"></i> 更新时间：2025-12-23</span>
                            <span><i class="far fa-clock"></i> 阅读时长：约 15 分钟</span>
                        </div>
                    </header>

                    <div class="article-content">
<div class="content__default"><h2 id="一、-npm-run-export导出文件上传到cdn"><a href="#一、-npm-run-export导出文件上传到cdn" class="header-anchor">#</a> 一、 <code>npm run export</code>导出文件上传到<code>CDN</code></h2> <blockquote><p>在项目中执行<code>npm run export</code>后导出<code>outCDN</code>文件上传到<code>CDN</code></p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// scripts/upload.js</span>

<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">OSS</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ali-oss'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'../outCDN'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> excludeFiles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'index.html'</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OSS</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">region</span><span class="token operator">:</span> <span class="token string">'oss-cn-shenzhen'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">accessKeyId</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
  <span class="token literal-property property">accessKeySecret</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
  <span class="token literal-property property">bucket</span><span class="token operator">:</span> <span class="token string">''</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 遍历文件夹中所有文件</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token parameter">filePath</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//根据文件路径读取文件，返回文件列表</span>
    fs<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>files</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token comment">//遍历读取到的文件列表</span>
            files<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//获取当前文件的绝对路径</span>
                <span class="token keyword">const</span> filedir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//根据文件路径获取文件信息，返回一个fs.Stats对象</span>
                fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>filedir<span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">eror<span class="token punctuation">,</span>stats</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>eror<span class="token punctuation">)</span><span class="token punctuation">{</span>
                        console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'获取文件stats失败'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                        <span class="token keyword">const</span> isFile <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//是文件</span>
                        <span class="token keyword">const</span> isDir <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//是文件夹</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>excludeFiles<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> isFile<span class="token punctuation">)</span><span class="token punctuation">{</span>
                            <span class="token keyword">const</span> fileKey <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filedir<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'outCDN/'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>

                            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                <span class="token comment">// object表示上传到OSS的Object名称，localfile表示本地文件或者文件路径</span>
                                <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>fileKey<span class="token punctuation">,</span>filedir<span class="token punctuation">)</span><span class="token punctuation">;</span>

                                console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'upload success: %j'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'upload failed: %j'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span>isDir<span class="token punctuation">)</span><span class="token punctuation">{</span>
                            <span class="token function">uploadFile</span><span class="token punctuation">(</span>filedir<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//递归，如果是文件夹，就继续遍历该文件夹下面的文件</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token function">uploadFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
</code></pre></div><h2 id="二、处理next-build后的文件"><a href="#二、处理next-build后的文件" class="header-anchor">#</a> 二、处理<code>next build</code>后的文件</h2> <blockquote><p>执行<code>next build</code>以后,把<code>.next</code>、<code>package.json</code>、<code>server.js</code>、<code>next.config.js</code>、<code>ecosystem.json</code> 拷贝到一个文件夹统一管理，最后部署这个文件夹下的内容即可</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// scripts/copyFiles.js</span>

<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span> <span class="token string">'fs'</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
    stat <span class="token operator">=</span> fs<span class="token punctuation">.</span>stat<span class="token punctuation">;</span>

<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> includeFiles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'package.json'</span><span class="token punctuation">,</span><span class="token string">'server.js'</span><span class="token punctuation">,</span><span class="token string">'next.config.js'</span><span class="token punctuation">,</span><span class="token string">'ecosystem.json'</span><span class="token punctuation">]</span>

<span class="token comment">/*
 * 复制目录中的所有文件包括子目录
 * @param{ String } 需要复制的目录
 * @param{ String } 复制到指定的目录
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">readDir</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">src<span class="token punctuation">,</span> dst</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 读取目录中的所有文件/目录</span>
    fs<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span> src<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">err<span class="token punctuation">,</span> paths</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> err <span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        paths<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">filename</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">var</span> _src <span class="token operator">=</span> src <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> filename<span class="token punctuation">,</span>
                _dst <span class="token operator">=</span> dst <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> filename<span class="token punctuation">,</span>
                readable<span class="token punctuation">,</span> writable<span class="token punctuation">;</span>

            <span class="token function">stat</span><span class="token punctuation">(</span> _src<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">err<span class="token punctuation">,</span> st</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span> err <span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 判断是否为文件</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span> st<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token comment">// 创建读取流</span>
                    readable <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span> _src <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 创建写入流</span>
                    writable <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span> _dst <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 通过管道来传输流</span>
                    readable<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span> writable <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 如果是目录则递归调用自身</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> st<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token function">copyDir</span><span class="token punctuation">(</span> _src<span class="token punctuation">,</span> _dst<span class="token punctuation">,</span> readDir <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 在复制目录前需要判断该目录是否存在，不存在需要先创建目录</span>
<span class="token keyword">const</span> <span class="token function-variable function">copyDir</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">src<span class="token punctuation">,</span> dst<span class="token punctuation">,</span> callback</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span> dst<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">exists</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 已存在</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> exists <span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">callback</span><span class="token punctuation">(</span> src<span class="token punctuation">,</span> dst <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 不存在</span>
        <span class="token keyword">else</span><span class="token punctuation">{</span>
            fs<span class="token punctuation">.</span><span class="token function">mkdir</span><span class="token punctuation">(</span> dst<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">callback</span><span class="token punctuation">(</span> src<span class="token punctuation">,</span> dst <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">copyFile</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  includeFiles<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'../'</span><span class="token operator">+</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'../deployBuildFiles'</span><span class="token punctuation">,</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'拷贝完成!'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 复制目录</span>
<span class="token function">copyDir</span><span class="token punctuation">(</span> <span class="token string">'.next'</span><span class="token punctuation">,</span> <span class="token string">'deployBuildFiles/.next'</span><span class="token punctuation">,</span> readDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 拷贝文件</span>
<span class="token function">copyFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="三、pm2之ecosystem部署项目"><a href="#三、pm2之ecosystem部署项目" class="header-anchor">#</a> 三、pm2之ecosystem部署项目</h2> <blockquote><p><code>PM2</code>部署应用流程，通过<code>pm2</code>的配置文件来部署
http://pm2.keymetrics.io/docs/usage/deployment/</p></blockquote> <h3 id="_3-1-配置部署脚本文件"><a href="#_3-1-配置部署脚本文件" class="header-anchor">#</a> 3.1 配置部署脚本文件</h3> <blockquote><p>在项目根目录添加<code>pm2</code>的部署脚本文件 <code>ecosystem.json</code></p></blockquote> <blockquote><p>部署文档详情：http://pm2.keymetrics.io/docs/usage/deployment/</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string-property property">"apps"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"goodsapp"</span><span class="token punctuation">,</span> <span class="token comment">//pm2运行的应用名称</span>
        <span class="token string-property property">"script"</span><span class="token operator">:</span> <span class="token string">"server.js"</span><span class="token punctuation">,</span><span class="token comment">//服务启动入口</span>
        <span class="token string-property property">"env"</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token string-property property">"COMON_VARIABLE"</span><span class="token operator">:</span> <span class="token string">"true"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"env_production"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string-property property">"NODE_ENV"</span><span class="token operator">:</span> <span class="token string">"production"</span><span class="token punctuation">,</span> <span class="token comment">//env</span>
            <span class="token string-property property">"HOST"</span><span class="token operator">:</span> <span class="token string">"localhost"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string-property property">"deploy"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// 最后这样使用 pm2 deploy ecosystem.json production</span>
      <span class="token string-property property">"production"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string-property property">"user"</span><span class="token operator">:</span> <span class="token string">"user_00"</span><span class="token punctuation">,</span><span class="token comment">// 服务器用户名</span>
          <span class="token string-property property">"host"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'192.68.1.201'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment">//服务器ip地址 可写多个</span>
          <span class="token string-property property">"ref"</span><span class="token operator">:</span> <span class="token string">"origin/master"</span><span class="token punctuation">,</span><span class="token comment">//从指定分支拉取代码</span>
          <span class="token string-property property">"repo"</span><span class="token operator">:</span> <span class="token string">"http://p.yesdat.com/diffusion/49/goodsh.git"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"path"</span><span class="token operator">:</span> <span class="token string">"/data/poetry/testDir/prev-goods.yesdat.com"</span><span class="token punctuation">,</span> <span class="token comment">//上传本地目录到服务器</span>
          <span class="token string-property property">"ssh_options"</span><span class="token operator">:</span> <span class="token string">"StrictHostKeyChecking=no"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"post-deploy"</span><span class="token operator">:</span> <span class="token string">"npm install --registry=https://registry.npm.taobao.org &amp;&amp; npm install &amp;&amp; pm2 startOrRestart ecosystem.json --env production"</span><span class="token punctuation">,</span><span class="token comment">//部署脚本</span>
          <span class="token string-property property">"env"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token string-property property">"NODE_ENV"</span><span class="token operator">:</span> <span class="token string">"production"</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>或者简单<code>scp</code>上传到服务器</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>scp -P36000  -r deployBuildFiles/.next user_00@192.168.1.201:/home/data/services/goods-prev.yesdat.com/
</code></pre></div><blockquote><p>更多详情 http://blog.poetries.top/2018/12/03/linux-scp</p></blockquote> <h3 id="_3-2-部署nginx配置规则"><a href="#_3-2-部署nginx配置规则" class="header-anchor">#</a> 3.2 部署Nginx配置规则</h3> <ul><li><a href="http://blog.poetries.top/2018/02/28/nginx-location-match-rules/" target="_blank" rel="noopener noreferrer">nginx之location的匹配规则<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://blog.poetries.top/2018/02/25/nginx-study/" target="_blank" rel="noopener noreferrer">Nginx学习篇<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <blockquote><p>在<code>nginx</code>安装目录下的<code>vhost</code>中新建一个<code>xx-3000.conf</code>的配置文件</p></blockquote> <ul><li>在Nginx目录<code>/etc/nginx</code>下执行 <code>sudo /usr/sbin/nginx -t</code> 检测配置文件是否成功</li></ul> <p><img src="https://s.poetries.top/gitee/2019/10/435.png" alt=""></p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> goodsapp</span> <span class="token punctuation">{</span> // <span class="token directive"><span class="token keyword">website项目的目录名称</span>
  server 127.0.0.1:3000</span><span class="token punctuation">;</span> // 服务器上的本地启动入口，端口对应项目中server.js中的端口
<span class="token punctuation">}</span>

// 配置server
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span> prev-goods.yesdat.com</span><span class="token punctuation">;</span> //指向的域名

    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forward-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$http_host</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Nginx-Proxy true</span><span class="token punctuation">;</span>

        <span class="token directive"><span class="token keyword">proxy_pass</span> http://goodsapp</span><span class="token punctuation">;</span> // 请求将会转发到goodsapp的node服务下
        <span class="token directive"><span class="token keyword">proxy_redirect</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    // 处理静态资源
    <span class="token directive"><span class="token keyword">location</span> ~* ^.+\.(jpg|jpeg|gif|png|ico|css|js|pdf|txt)</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">root</span> /data/goodsapp/static</span><span class="token punctuation">;</span> //请求转发到静态资源路径
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>更多配置参考 https://github.com/poetries/poetry-configure/blob/master/nginx.conf</p></blockquote> <h3 id="_3-3-本地项目根执行的命令"><a href="#_3-3-本地项目根执行的命令" class="header-anchor">#</a> 3.3 本地项目根执行的命令</h3> <ul><li><code>pm2 deploy ecosystem.json goodsapp setup</code> 初始化</li> <li><code>pm2 deploy ecosystem.json goodsapp</code> 部署</li></ul> <h3 id="_3-4-部署到阿里云"><a href="#_3-4-部署到阿里云" class="header-anchor">#</a> 3.4 部署到阿里云</h3> <p><strong>第一步：配置Nginx</strong></p> <blockquote><p>查看<code>Nginx</code>安装路径 <code>which nginx</code> 注意<code>/etc/nginx</code>和<code>/usr/local/nginx/</code>下的<code>nginx</code>区别</p></blockquote> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 切换到Nginx当前目录下</span>
/usr/local/nginx/conf/

<span class="token comment"># 创建vhost</span>
<span class="token function">mkdir</span> vhost

<span class="token comment"># 创建goodsapp-3001.conf，内容如下</span>

server <span class="token punctuation">{</span>
    listen <span class="token number">8080</span><span class="token punctuation">;</span> 
    server_name <span class="token number">39.108</span>.74.36<span class="token punctuation">;</span><span class="token comment"># 在ifconfig的拿到的ip地址或者是公网ip，这里填公网ip，如果是域名阿里云需要备案才可以正常访问</span>

    location / <span class="token punctuation">{</span>
        proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
        proxy_set_header X-Forward-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
        proxy_set_header Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>
        proxy_set_header X-Nginx-Proxy <span class="token boolean">true</span><span class="token punctuation">;</span>

        proxy_pass http://127.0.0.1:3001<span class="token punctuation">;</span><span class="token comment"># 把172.16.0.223：8080的请求转发代理到本机的3001端口</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># 在/usr/local/nginx/sbin/nginx/conf/nginx.conf下include创建的vhost文件</span>
include /etc/nginx/vhost/*.conf<span class="token punctuation">;</span> <span class="token comment"># 在文件最后include配置文件</span>

<span class="token comment"># 在/usr/local/nginx/sbin/nginx/conf/nginx.conf下执行检测配置文件</span>
<span class="token function">sudo</span> /usr/local/nginx/sbin/nginx -t

<span class="token comment"># 重新加载Nginx配置</span>
/usr/local/nginx/sbin/nginx -s reload
</code></pre></div><blockquote><p>一些注意事项</p></blockquote> <ul><li><code>server_name</code>可以是域名，也可以是<code>ip</code>。<code>ip</code>可以是本地，也可以是公网<code>ip</code></li></ul> <p>本机<code>ip</code></p> <p><img src="https://s.poetries.top/gitee/2019/10/437.png" alt=""></p> <p>公网<code>ip</code></p> <p><img src="https://s.poetries.top/gitee/2019/10/438.png" alt=""></p> <ul><li>阿里云防火墙规则设置</li></ul> <blockquote><p>这里访问了 <code>8080</code>需要在阿里云后台配置一下</p></blockquote> <p><img src="https://s.poetries.top/gitee/2019/10/436.png" alt=""></p> <p><strong>第二步：pm2部署到服务器</strong></p> <blockquote><p>首先在服务端全局安装<code>pm2</code>、<code>npm</code> <code>node</code>并且建立软链</p></blockquote> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i pm2 -g
</code></pre></div><p><strong>重要：请注意：</strong></p> <blockquote><p>一定要做建立软链这步，否则出现如下问题</p></blockquote> <p><img src="https://s.poetries.top/gitee/2019/10/439.png" alt=""> <img src="https://s.poetries.top/gitee/2019/10/440.png" alt=""></p> <blockquote><p>建立<code>npm</code> 软链</p></blockquote> <p><img src="https://s.poetries.top/gitee/2019/10/441.png" alt=""></p> <blockquote><p>建立<code>node</code> 软链</p></blockquote> <p><img src="https://s.poetries.top/gitee/2019/10/442.png" alt=""></p> <blockquote><p>建立<code>pm2</code> 软链</p></blockquote> <p><img src="https://s.poetries.top/gitee/2019/10/443.png" alt=""></p> <p><strong>正式部署</strong></p> <ul><li>根目录执行<code>pm2 deploy deploy-app.json production setup</code> 初始化服务端环境</li> <li>根目录执行<code>pm2 deploy deploy-app.json production --force</code> 输入服务端用户root密码，部署即可</li></ul> <blockquote><p>来到<code>/home/production</code>目录查看上传的文件</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token string-property property">"apps"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"goodsapp-prev"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"script"</span><span class="token operator">:</span> <span class="token string">"server.js"</span><span class="token punctuation">,</span># 根目录server<span class="token punctuation">.</span>js文件
          <span class="token string-property property">"env"</span><span class="token operator">:</span><span class="token punctuation">{</span>
              <span class="token string-property property">"COMON_VARIABLE"</span><span class="token operator">:</span> <span class="token string">"true"</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string-property property">"env_production"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token string-property property">"NODE_ENV"</span><span class="token operator">:</span> <span class="token string">"production"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">"deploy"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">"production"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string-property property">"user"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span><span class="token comment">//用户名</span>
            <span class="token string-property property">"host"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"39.108.74.36"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">//公网ip</span>
            <span class="token string-property property">"ref"</span><span class="token operator">:</span> <span class="token string">"origin/master"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"repo"</span><span class="token operator">:</span> <span class="token string">"https://gitee.com/Poetries1/goods-prev.yesdat.com.git"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"path"</span><span class="token operator">:</span> <span class="token string">"/home/production"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"ssh_options"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"StrictHostKeyChecking=no"</span><span class="token punctuation">,</span> <span class="token string">"PasswordAuthentication=no"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string-property property">"post-deploy"</span><span class="token operator">:</span> <span class="token string">"npm install &amp;&amp; pm2 startOrRestart deploy-app.json --env production"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"pre-deploy-local"</span><span class="token operator">:</span> <span class="token string">"echo 'Deploy Done!'"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"env"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token string-property property">"NODE_ENV"</span><span class="token operator">:</span> <span class="token string">"production"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><blockquote><p>更多配置信息 http://pm2.keymetrics.io/docs/usage/deployment/</p></blockquote> <ul><li><code>pm2 list</code>查看启动的项目</li></ul> <p><img src="https://s.poetries.top/gitee/2019/10/444.png" alt=""></p> <ul><li><code>pm2 logs</code>查看启动日志</li></ul> <p><img src="https://s.poetries.top/gitee/2019/10/445.png" alt=""></p> <blockquote><p>然后在浏览器访问<code>http://39.108.74.36:8080</code>（http://公网ip:端口）即可看到，到此部署结束</p></blockquote> <h3 id="_3-5-部署更多参考"><a href="#_3-5-部署更多参考" class="header-anchor">#</a> 3.5 部署更多参考</h3> <ul><li><a href="https://segmentfault.com/a/1190000012774650" target="_blank" rel="noopener noreferrer">next.js、nuxt.js等服务端渲染框架构建的项目部署到服务器，并用PM2守护程序<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://segmentfault.com/a/1190000010992618" target="_blank" rel="noopener noreferrer">学习 Next.js: 部署<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/zeit/next.js/wiki/Deployment-on-Nginx's-reverse-proxy" target="_blank" rel="noopener noreferrer">Deployment on Nginx's reverse proxy<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.cnblogs.com/neromaycry/p/7072872.html" target="_blank" rel="noopener noreferrer">将nodejs代码部署到阿里云服务器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.jianshu.com/p/630e2e1ca57f" target="_blank" rel="noopener noreferrer">Nginx从听说到学会<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <!----> <div class="readMore-wrapper"><span class="readMore">阅读全文</span></div>
                    </div>
                            <p>这是一个信息提示框。</p>
                        </div>

                        <div class="note warning">
                            <div class="note-title"><i class="fas fa-exclamation-triangle"></i> 注意</div>
                            <p>这是一个警告提示框。</p>
                        </div>

                        <div class="note success">
                            <div class="note-title"><i class="fas fa-check-circle"></i> 成功</div>
                            <p>这是一个成功提示框。</p>
                        </div>

                        <h2>代码示例</h2>
                        <pre><code class="language-javascript">// 示例代码
function example() {
    console.log('Hello, FrontendHub!');
}
</code></pre>
                    </div>

                    <!-- 文章底部导航 -->
                    <nav class="article-nav">
                        <a href="#" class="prev-article">
                            <i class="fas fa-chevron-left"></i>
                            <span>上一篇</span>
                        </a>
                        <a href="#" class="next-article">
                            <span>下一篇</span>
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </nav>
                </article>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4><i class="fas fa-code"></i> FrontendHub</h4>
                    <p>专注于前端技术学习与面试准备</p>
                </div>
                <div class="footer-section">
                    <h4>快速链接</h4>
                    <ul>
                        <li><a href="../../index.html">首页</a></li>
                        <li><a href="../index.html#courses">课程体系</a></li>
                        <li><a href="../index.html#resources">学习资源</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 FrontendHub. 用于个人学习使用.</p>
            </div>
        </div>
    </footer>

    <!-- 返回顶部按钮 -->
    <button class="back-to-top" id="backToTop">
        <i class="fas fa-arrow-up"></i>
    </button>

    <script src="../../js/main.js"></script>
    <script src="../../js/content.js"></script>
</body>
</html>

