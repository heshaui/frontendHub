<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小程序之登录 - FrontendHub</title>
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/content.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="content-page">
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <a href="../../index.html" style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-code"></i>
                    <span>FrontendHub</span>
                </a>
            </div>
            <button class="nav-toggle" id="navToggle">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="nav-menu" id="navMenu">
                <li><a href="../../index.html">首页</a></li>
                <li><a href="../index.html#features">特色</a></li>
                <li><a href="../index.html#courses">课程</a></li>
                <li><a href="../index.html#resources">资源</a></li>
            </ul>
        </div>
    </nav>

    <!-- 面包屑导航 -->
    <div class="breadcrumb">
        <div class="container">
            <a href="../../index.html"><i class="fas fa-home"></i> 首页</a>
            <i class="fas fa-chevron-right"></i>
            <span>小程序之登录</span>
        </div>
    </div>

    <!-- 主要内容区 -->
    <main class="content-main">
        <div class="container">
            <div class="content-layout">
                <!-- 侧边栏目录 -->
                <aside class="sidebar">
                    <div class="sidebar-sticky">
                        <h3><i class="fas fa-list"></i> 目录</h3>
                        <nav class="toc" id="toc">
                            <!-- 目录将通过JavaScript自动生成 -->
                        </nav>
                    </div>
                </aside>

                <!-- 文章内容 -->
                <article class="article">
                    <header class="article-header">
                        <h1>小程序之登录</h1>
                        <div class="article-meta">
                            <span><i class="far fa-calendar"></i> 更新时间：2025-12-23</span>
                            <span><i class="far fa-clock"></i> 阅读时长：约 15 分钟</span>
                        </div>
                    </header>

                    <div class="article-content">
<div class="content__default"><h2 id="一、登录流程"><a href="#一、登录流程" class="header-anchor">#</a> 一、登录流程</h2> <p><img src="https://s.poetries.top/gitee/2019/10/662.png" alt=""></p> <ul><li>小程序内通过<code>wx.login</code>接口获得<code>code</code></li> <li>将<code>code</code>传入后台，后台对微信服务器发起一个<code>https</code>请求换取<code>openid</code>、<code>session_key</code>(解密<code>encryptedData</code>、<code>iv</code>得到的)</li> <li>后台生成一个自身的<code>3rd_session</code>（以此为<code>key</code>值保持<code>openid</code>和<code>session_key</code>），返回给前端。PS:微信方的<code>openid</code>和<code>session_key</code>并没有发回给前端小程序</li> <li>小程序拿到<code>3rd_session</code>之后保持在本地</li> <li>小程序请求登录区内接口，通过<code>wx.checkSession</code>检查登录态，如果失效重新走上述登录流程，否则待上<code>3rd_session</code>到后台进行登录验证</li></ul> <blockquote><p>通过上面<code>wx.login</code>和<code>wx.getUserInfo</code>两个api拿到相应的信息,并通过上方接口传给自己的服务器.</p></blockquote> <p><strong>登录获取用户信息</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>wx<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
       <span class="token comment">//code:"fda41033Z0fdak3dfae01dffaaWXQA1vwQ4dfae0Akg3e0Z0k3E"</span>
       <span class="token comment">//errMsg:"login:ok"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code>wx<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
   <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>返回的信息</p> <p><img src="https://s.poetries.top/gitee/2019/10/663.png" alt=""></p> <p><strong>需要传输的信息有7个参数</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>appid  小程序唯一标识
secret  小程序的 app secret
js_code  <span class="token comment">//wx.login登录时获取的 code,用于后续获取session_key</span>

<span class="token comment">//下面两个参数用户服务器端签名校验用户信息的</span>
signature 使用 <span class="token function">sha1</span><span class="token punctuation">(</span> rawData <span class="token operator">+</span> sessionkey <span class="token punctuation">)</span> 得到字符串，用于校验用户信息。
rawData  不包括敏感信息的原始数据字符串，用于计算签名。

<span class="token comment">//下面两个参数是用于解密获取openId和UnionId的</span>
encryptedData  包括敏感数据在内的完整用户信息的加密数据
iv 加密算法的初始向量
</code></pre></div><ul><li>可精简为以下三个参数.</li> <li>其余的签名校验的参数可省略,而<code>appid</code>和<code>secret</code>可以直接写在服务器.</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>js_code <span class="token comment">//  wx.login登录时获取的 code,用于后续获取session_key</span>
encryptedData  包括敏感数据在内的完整用户信息的加密数据
iv 加密算法的初始向量
</code></pre></div><blockquote><p>服务端处理返回token、sessionId过程省略...</p></blockquote> <h2 id="二、登录态校验"><a href="#二、登录态校验" class="header-anchor">#</a> 二、登录态校验</h2> <blockquote><p>主要用到<code>checkSession</code></p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code>wx<span class="token punctuation">.</span><span class="token function">checkSession</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'warning wx.checkSession OK, but no viewerId'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'wx.checkSession failed:'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">complete</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        wx<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'wx.login success:'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 登录自有系统</span>
                <span class="token constant">API</span><span class="token punctuation">.</span>login<span class="token punctuation">.</span><span class="token function">wechat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    <span class="token literal-property property">js_code</span><span class="token operator">:</span> res<span class="token punctuation">.</span>code
                <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">d</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'private login response:'</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'private login success:'</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">let</span> viewerId <span class="token operator">=</span> d<span class="token punctuation">.</span>data<span class="token punctuation">.</span>user<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span>
                        _m<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>viewerId <span class="token operator">=</span> viewerId<span class="token punctuation">;</span>

                        wx<span class="token punctuation">.</span><span class="token function">setStorageSync</span><span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> viewerId<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        callback <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'get user_id error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
                    <span class="token literal-property property">ignoreError</span><span class="token operator">:</span> <span class="token boolean">true</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'wx.login failed:'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="三、完整登录代码示例"><a href="#三、完整登录代码示例" class="header-anchor">#</a> 三、完整登录代码示例</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token constant">CONFIG</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./config.js'</span><span class="token punctuation">)</span>
<span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">globalData</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token literal-property property">viewerId</span><span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token literal-property property">userInfo</span><span class="token operator">:</span><span class="token keyword">null</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">onLaunch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 注册当前用户</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">login</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> _m <span class="token operator">=</span> <span class="token keyword">this</span>
    
        <span class="token comment">// 开发环境重复使用就好</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>viewerId <span class="token operator">&amp;&amp;</span> <span class="token constant">CONFIG</span><span class="token punctuation">.</span><span class="token constant">IS_DEBUG</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            viewerId <span class="token operator">=</span> wx<span class="token punctuation">.</span><span class="token function">getStorageSync</span><span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		
        <span class="token punctuation">}</span>
    
        <span class="token comment">// 先检查是否有登录态，且获取过用户数据；否则触发一次登录</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>viewerId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            _m<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>viewerId <span class="token operator">=</span> viewerId<span class="token punctuation">;</span>
            callback <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            wx<span class="token punctuation">.</span><span class="token function">checkSession</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'warning wx.checkSession OK, but no viewerId'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'wx.checkSession failed:'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token function-variable function">complete</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    wx<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'wx.login success:'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// 登录自有系统</span>
                            <span class="token constant">API</span><span class="token punctuation">.</span>login<span class="token punctuation">.</span><span class="token function">wechat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                                <span class="token literal-property property">js_code</span><span class="token operator">:</span> res<span class="token punctuation">.</span>code
                            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">d</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'private login response:'</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'private login success:'</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
                                    <span class="token keyword">let</span> viewerId <span class="token operator">=</span> d<span class="token punctuation">.</span>data<span class="token punctuation">.</span>user<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span>
                                    _m<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>viewerId <span class="token operator">=</span> viewerId<span class="token punctuation">;</span>
    
                                    wx<span class="token punctuation">.</span><span class="token function">setStorageSync</span><span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> viewerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
                                    callback <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'get user_id error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
                                <span class="token literal-property property">ignoreError</span><span class="token operator">:</span> <span class="token boolean">true</span>
                            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'wx.login failed:'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">register</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">needTry<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token operator">!</span>callback <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token comment">// 如果曾经授权过，则不用再请求了</span>
            <span class="token comment">/*try {
                let registedTime = wx.getStorageSync('REGISTED.'+ this.globalData.viewerId);
                // 7天内授权过的不再请求，不再更新资料
                if (registedTime &amp;&amp; ((new Date).getTime()-registedTime) &lt; 604800000) {
                    callback();
                    return;
                }
            } catch (e) {}*/</span>
        
            wx<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        
                    <span class="token keyword">this</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>userInfo <span class="token operator">=</span> res<span class="token punctuation">.</span>userInfo<span class="token punctuation">;</span>
                    params<span class="token punctuation">.</span>owner <span class="token operator">=</span> <span class="token punctuation">{</span>
                        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>viewerId<span class="token punctuation">,</span>
        
                        <span class="token literal-property property">connected_profile</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                            <span class="token literal-property property">nickname</span> <span class="token operator">:</span> res<span class="token punctuation">.</span>userInfo<span class="token punctuation">.</span>nickName<span class="token operator">||</span><span class="token string">''</span><span class="token punctuation">,</span>  <span class="token comment">// 用户昵称</span>
                            <span class="token literal-property property">profile_pic_url</span><span class="token operator">:</span> res<span class="token punctuation">.</span>userInfo<span class="token punctuation">.</span>avatarUrl<span class="token operator">||</span><span class="token string">''</span><span class="token punctuation">,</span>  <span class="token comment">// 头像， avatarUrl</span>
                            <span class="token literal-property property">language</span> <span class="token operator">:</span> res<span class="token punctuation">.</span>userInfo<span class="token punctuation">.</span>language<span class="token operator">||</span><span class="token string">''</span><span class="token punctuation">,</span>  <span class="token comment">// 语言, "zh_TW"</span>
                            <span class="token literal-property property">gender</span> <span class="token operator">:</span> res<span class="token punctuation">.</span>userInfo<span class="token punctuation">.</span>gender<span class="token punctuation">,</span>
                            <span class="token literal-property property">geo</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                                <span class="token literal-property property">country</span>	<span class="token operator">:</span> res<span class="token punctuation">.</span>userInfo<span class="token punctuation">.</span>country<span class="token punctuation">,</span>
                                <span class="token literal-property property">province</span><span class="token operator">:</span> res<span class="token punctuation">.</span>userInfo<span class="token punctuation">.</span>province<span class="token punctuation">,</span>
                                <span class="token literal-property property">city</span>	<span class="token operator">:</span> res<span class="token punctuation">.</span>userInfo<span class="token punctuation">.</span>city
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token constant">API</span><span class="token punctuation">.</span>profile<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 静默注册</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                wx<span class="token punctuation">.</span><span class="token function">setStorageSync</span><span class="token punctuation">(</span><span class="token string">'USERINFO.'</span><span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>viewerId<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                wx<span class="token punctuation">.</span><span class="token function">setStorageSync</span><span class="token punctuation">(</span><span class="token string">'REGISTED.'</span><span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>viewerId<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        
                            <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
                        <span class="token literal-property property">ignoreError</span><span class="token operator">:</span> <span class="token boolean">true</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get user info failed: not authorized.'</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    
                    <span class="token comment">// 强制弹一次授权</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>needTry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        wx<span class="token punctuation">.</span><span class="token function">openSetting</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                            <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>authSetting<span class="token punctuation">[</span><span class="token string">'scope.userInfo'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    wx<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                                        <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token constant">LANG</span><span class="token punctuation">.</span>AuthorizeSuccess<span class="token punctuation">,</span>
                                        <span class="token literal-property property">duration</span><span class="token operator">:</span> <span class="token constant">CONFIG</span><span class="token punctuation">.</span><span class="token constant">SHOWTOAST_DURATION</span><span class="token punctuation">,</span>
                                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span><span class="token punctuation">,</span>
                            <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'user not permit to authorize.'</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token literal-property property">withCredentials</span><span class="token operator">:</span> <span class="token boolean">false</span>	<span class="token comment">// 不包含openid 等敏感信息</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">init</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token comment">// 塞入常规环境数据</span>
            <span class="token keyword">let</span> pageInstance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCurrentPageInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                context<span class="token punctuation">,</span> screenWidth<span class="token punctuation">,</span> screenHeight<span class="token punctuation">;</span>

            <span class="token comment">/*if (this.globalData.device.system_info) {
                screenWidth = this.globalData.device.system_info.screen_width;
                screenHeight = this.globalData.device.system_info.screen_height;
            } else {
                let systemInfo = wx.getSystemInfoSync();
                if (systemInfo) {
                    screenWidth = systemInfo.screenWidth;
                    screenHeight = systemInfo.screenHeight;
                }
            }*/</span>
            context <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token constant">LANG</span>				<span class="token operator">:</span> <span class="token constant">LANG</span><span class="token punctuation">,</span>
                <span class="token constant">CDN</span>					<span class="token operator">:</span> <span class="token constant">CONFIG</span><span class="token punctuation">.</span><span class="token constant">CDN_HOST</span><span class="token punctuation">,</span>
                <span class="token literal-property property">isNoContent</span>			<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                <span class="token literal-property property">HashtagType</span>			<span class="token operator">:</span> <span class="token constant">CONFIG</span><span class="token punctuation">.</span>HashtagType<span class="token punctuation">,</span>
                <span class="token literal-property property">VerbType</span>			<span class="token operator">:</span> <span class="token constant">CONFIG</span><span class="token punctuation">.</span>VerbType<span class="token punctuation">,</span>
                <span class="token literal-property property">GridImageWidthMode</span>	<span class="token operator">:</span> <span class="token constant">CONFIG</span><span class="token punctuation">.</span>GridImageWidthMode<span class="token punctuation">,</span>
                <span class="token constant">STICKER_MAKER_ENABLED</span><span class="token operator">:</span> <span class="token constant">CONFIG</span><span class="token punctuation">.</span><span class="token constant">STICKER_MAKER_ENABLED</span><span class="token punctuation">,</span>
                <span class="token constant">UGC_ENABLED</span>			<span class="token operator">:</span> <span class="token constant">CONFIG</span><span class="token punctuation">.</span><span class="token constant">UGC_ENABLED</span><span class="token punctuation">,</span>
                <span class="token constant">UGC_IMAGE_COUNT_LIMIT</span><span class="token operator">:</span> <span class="token constant">CONFIG</span><span class="token punctuation">.</span><span class="token constant">UGC_IMAGE_COUNT_LIMIT</span><span class="token punctuation">,</span>
                <span class="token literal-property property">ReviewStateText</span>		<span class="token operator">:</span> <span class="token constant">CONFIG</span><span class="token punctuation">.</span>ReviewStateText<span class="token punctuation">,</span>

                <span class="token literal-property property">networkType</span>			<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>device<span class="token punctuation">.</span>network <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>device<span class="token punctuation">.</span>network<span class="token punctuation">.</span>network_type <span class="token operator">:</span> NetworkType<span class="token punctuation">.</span><span class="token constant">UNKNOWN</span><span class="token punctuation">,</span>

                <span class="token constant">IS_DEV</span>				<span class="token operator">:</span> <span class="token constant">CONFIG</span><span class="token punctuation">.</span><span class="token constant">IS_DEV</span><span class="token punctuation">,</span>
                <span class="token constant">IS_SHOW_CONSOLE</span>		<span class="token operator">:</span> <span class="token constant">CONFIG</span><span class="token punctuation">.</span><span class="token constant">IS_SHOW_CONSOLE</span><span class="token punctuation">,</span>
                <span class="token constant">DEBUG_DATA</span>			<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

                <span class="token comment">// 全部配置都放开读</span>
                <span class="token constant">CONFIG</span>				<span class="token operator">:</span> <span class="token constant">CONFIG</span><span class="token punctuation">,</span>

                <span class="token literal-property property">videoPlayStatus</span>		<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                
                <span class="token constant">CURRENT_PAGE</span>		<span class="token operator">:</span> pageInstance<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token constant">PAGE</span><span class="token punctuation">,</span>

                <span class="token literal-property property">hideVideo</span>			<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token comment">// 因为小程序中video不能被任何元素遮挡，所以增加此变量，用于一些浮层展示时，隐藏视频</span>
                
                <span class="token literal-property property">updated_time</span>		<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 页面上次更新时间</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            pageInstance<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token literal-property property">context</span><span class="token operator">:</span> context
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendLaunchEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            callback <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div></div> <!----> <div class="readMore-wrapper"><span class="readMore">阅读全文</span></div>
                    </div>
                            <p>这是一个信息提示框。</p>
                        </div>

                        <div class="note warning">
                            <div class="note-title"><i class="fas fa-exclamation-triangle"></i> 注意</div>
                            <p>这是一个警告提示框。</p>
                        </div>

                        <div class="note success">
                            <div class="note-title"><i class="fas fa-check-circle"></i> 成功</div>
                            <p>这是一个成功提示框。</p>
                        </div>

                        <h2>代码示例</h2>
                        <pre><code class="language-javascript">// 示例代码
function example() {
    console.log('Hello, FrontendHub!');
}
</code></pre>
                    </div>

                    <!-- 文章底部导航 -->
                    <nav class="article-nav">
                        <a href="#" class="prev-article">
                            <i class="fas fa-chevron-left"></i>
                            <span>上一篇</span>
                        </a>
                        <a href="#" class="next-article">
                            <span>下一篇</span>
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </nav>
                </article>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4><i class="fas fa-code"></i> FrontendHub</h4>
                    <p>专注于前端技术学习与面试准备</p>
                </div>
                <div class="footer-section">
                    <h4>快速链接</h4>
                    <ul>
                        <li><a href="../../index.html">首页</a></li>
                        <li><a href="../index.html#courses">课程体系</a></li>
                        <li><a href="../index.html#resources">学习资源</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 FrontendHub. 用于个人学习使用.</p>
            </div>
        </div>
    </footer>

    <!-- 返回顶部按钮 -->
    <button class="back-to-top" id="backToTop">
        <i class="fas fa-arrow-up"></i>
    </button>

    <script src="../../js/main.js"></script>
    <script src="../../js/content.js"></script>
</body>
</html>

