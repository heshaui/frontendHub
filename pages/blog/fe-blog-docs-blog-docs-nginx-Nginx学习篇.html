<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nginx学习篇 - FrontendHub</title>
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/content.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="content-page">
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <a href="../../index.html" style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-code"></i>
                    <span>FrontendHub</span>
                </a>
            </div>
            <button class="nav-toggle" id="navToggle">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="nav-menu" id="navMenu">
                <li><a href="../../index.html">首页</a></li>
                <li><a href="../index.html#features">特色</a></li>
                <li><a href="../index.html#courses">课程</a></li>
                <li><a href="../index.html#resources">资源</a></li>
            </ul>
        </div>
    </nav>

    <!-- 面包屑导航 -->
    <div class="breadcrumb">
        <div class="container">
            <a href="../../index.html"><i class="fas fa-home"></i> 首页</a>
            <i class="fas fa-chevron-right"></i>
            <span>Nginx学习篇</span>
        </div>
    </div>

    <!-- 主要内容区 -->
    <main class="content-main">
        <div class="container">
            <div class="content-layout">
                <!-- 侧边栏目录 -->
                <aside class="sidebar">
                    <div class="sidebar-sticky">
                        <h3><i class="fas fa-list"></i> 目录</h3>
                        <nav class="toc" id="toc">
                            <!-- 目录将通过JavaScript自动生成 -->
                        </nav>
                    </div>
                </aside>

                <!-- 文章内容 -->
                <article class="article">
                    <header class="article-header">
                        <h1>Nginx学习篇</h1>
                        <div class="article-meta">
                            <span><i class="far fa-calendar"></i> 更新时间：2025-12-23</span>
                            <span><i class="far fa-clock"></i> 阅读时长：约 15 分钟</span>
                        </div>
                    </header>

                    <div class="article-content">
<div class="content__default"><blockquote><p>Nginx 配置文件在线生成: https://nginxconfig.io/</p></blockquote> <blockquote><p><code>Nginx</code> 是一款面向性能设计的 <code>HTTP</code> 服务器，能反向代理 <code>HTTP</code>，<code>HTTPS</code> 和邮件相关(<code>SMTP</code>，<code>POP3</code>，<code>IMAP</code>)的协议链接。并且提供了负载均衡以及 <code>HTTP</code> 缓存。它的设计充分使用异步事件模型，削减上下文调度的开销，提高服务器并发能力。采用了模块化设计，提供了丰富模块的第三方模块。</p></blockquote> <ul><li>所以关于 `Nginx，有这些标签：「异步」「事件」「模块化」「高性能」「高并发」「反向代理」「负载均衡」</li></ul> <h2 id="一、安装"><a href="#一、安装" class="header-anchor">#</a> 一、安装</h2> <h3 id="_1-1-安装依赖"><a href="#_1-1-安装依赖" class="header-anchor">#</a> 1.1 安装依赖</h3> <blockquote><p><code>prce</code>(重定向支持)和<code>openssl</code>(<code>https</code>支持，如果不需要<code>https</code>可以不安装)</p></blockquote> <div class="language-bash extra-class"><pre class="language-bash"><code>yum <span class="token function">install</span> -y pcre-devel 
yum -y <span class="token function">install</span> gcc <span class="token function">make</span> gcc-c++ <span class="token function">wget</span>
yum -y <span class="token function">install</span> openssl openssl-devel 
</code></pre></div><p><code>CentOS 6.5</code> 我安装的时候是选择的“基本服务器”，默认这两个包都没安装全，所以这两个都运行安装即可</p> <h3 id="_1-2-下载"><a href="#_1-2-下载" class="header-anchor">#</a> 1.2 下载</h3> <p><a href="http://nginx.org/download/" target="_blank" rel="noopener noreferrer">nginx的所有版本在这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">wget</span> http://nginx.org/download/nginx-1.13.3.tar.gz
<span class="token function">wget</span> http://nginx.org/download/nginx-1.13.7.tar.gz

<span class="token comment"># 如果没有安装wget</span>
<span class="token comment"># 下载已编译版本</span>
$ yum <span class="token function">install</span> <span class="token function">wget</span>

<span class="token comment"># 解压压缩包</span>
<span class="token function">tar</span> zxf nginx-1.13.3.tar.gz
</code></pre></div><h3 id="_1-3-编译安装"><a href="#_1-3-编译安装" class="header-anchor">#</a> 1.3 编译安装</h3> <p>然后进入目录编译安装，<a href="#configure%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E">configure参数说明</a></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> nginx-1.11.5
./configure


<span class="token punctuation">..</span><span class="token punctuation">..</span>
Configuration summary
  + using system PCRE library
  + OpenSSL library is not used
  + using system zlib library

  nginx path prefix: <span class="token string">"/usr/local/nginx"</span>
  nginx binary file: <span class="token string">"/usr/local/nginx/sbin/nginx"</span>
  nginx modules path: <span class="token string">"/usr/local/nginx/modules"</span>
  nginx configuration prefix: <span class="token string">"/usr/local/nginx/conf"</span>
  nginx configuration file: <span class="token string">"/usr/local/nginx/conf/nginx.conf"</span>
  nginx pid file: <span class="token string">"/usr/local/nginx/logs/nginx.pid"</span>
  nginx error log file: <span class="token string">"/usr/local/nginx/logs/error.log"</span>
  nginx http access log file: <span class="token string">"/usr/local/nginx/logs/access.log"</span>
  nginx http client request body temporary files: <span class="token string">"client_body_temp"</span>
  nginx http proxy temporary files: <span class="token string">"proxy_temp"</span>
  nginx http fastcgi temporary files: <span class="token string">"fastcgi_temp"</span>
  nginx http uwsgi temporary files: <span class="token string">"uwsgi_temp"</span>
  nginx http scgi temporary files: <span class="token string">"scgi_temp"</span>
</code></pre></div><blockquote><p>安装报错误的话比如：<code>“C compiler cc is not found”</code>，这个就是缺少编译环境，安装一下就可以了 <code>yum -y install gcc make gcc-c++ openssl-devel</code></p></blockquote> <p>如果没有<code>error</code>信息，就可以执行下边的安装了：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">make</span>
<span class="token function">make</span> <span class="token function">install</span>
</code></pre></div><h3 id="_1-4-nginx测试"><a href="#_1-4-nginx测试" class="header-anchor">#</a> 1.4 nginx测试</h3> <ul><li>运行下面命令会出现两个结果，一般情况<code>nginx</code>会安装在<code>/usr/local/nginx</code>目录中</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /usr/local/nginx/sbin/
./nginx -t

<span class="token comment"># nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok</span>
<span class="token comment"># nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful</span>
</code></pre></div><h3 id="_1-5-设置全局nginx命令"><a href="#_1-5-设置全局nginx命令" class="header-anchor">#</a> 1.5 设置全局nginx命令</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">vi</span> ~/.bash_profile
</code></pre></div><p>将下面内容添加到 <code>~/.bash_profile</code> 文件中</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token environment constant">$HOME</span>/bin:/usr/local/nginx/sbin/
<span class="token builtin class-name">export</span> <span class="token environment constant">PATH</span>
</code></pre></div><p>运行命令 <strong><code>source ~/.bash_profile</code></strong> 让配置立即生效。你就可以全局运行 <code>nginx</code> 命令了。</p> <h2 id="二、开机自启动"><a href="#二、开机自启动" class="header-anchor">#</a> 二、开机自启动</h2> <p><strong>开机自启动方法一</strong></p> <ul><li>编辑 <strong><code>vi /lib/systemd/system/nginx.service</code></strong> 文件，没有创建一个 <strong><code>touch nginx.service</code></strong> - 然后将如下内容根据具体情况进行修改后，添加到<code>nginx.service</code>文件中：</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>nginx
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target remote-fs.target nss-lookup.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>

<span class="token assign-left variable">Type</span><span class="token operator">=</span>forking
<span class="token assign-left variable">PIDFile</span><span class="token operator">=</span>/var/run/nginx.pid
<span class="token assign-left variable">ExecStartPre</span><span class="token operator">=</span>/usr/local/nginx/sbin/nginx -t -c /usr/local/nginx/conf/nginx.conf
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf
<span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/bin/kill -s HUP <span class="token variable">$MAINPID</span>
<span class="token assign-left variable">ExecStop</span><span class="token operator">=</span>/bin/kill -s QUIT <span class="token variable">$MAINPID</span>
<span class="token assign-left variable">PrivateTmp</span><span class="token operator">=</span>true

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>[Unit]:服务的说明  
Description:描述服务  
After:描述服务类别  
[Service]服务运行参数的设置  
Type=forking是后台运行的形式  
ExecStart为服务的具体运行命令  
ExecReload为重启命令  
ExecStop为停止命令  
PrivateTmp=True表示给服务分配独立的临时空间  
注意：[Service]的启动、重启、停止命令全部要求使用绝对路径  
[Install]运行级别下服务安装的相关设置，可设置为多用户，即系统运行级别为3  
</code></pre></div><p>保存退出。</p> <p>设置开机启动，使配置生效：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>systemctl <span class="token builtin class-name">enable</span> nginx.service
<span class="token comment"># 输出下面内容表示成功了</span>
Created symlink from /etc/systemd/system/multi-user.target.wants/nginx.service to /usr/lib/systemd/system/nginx.service.
</code></pre></div><p><strong>开机自启动方法二</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">vi</span> /etc/rc.local

<span class="token comment"># 在 rc.local 文件中，添加下面这条命令</span>
/usr/local/nginx/sbin/nginx start
</code></pre></div><ul><li>如果开机后发现自启动脚本没有执行，你要去确认一下<code>rc.local</code>这个文件的访问权限是否是可执行的，因为<code>rc.local</code>默认是不可执行的。修改<code>rc.local</code>访问权限，增加可执行权限：</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">chmod</span> +x /etc/rc.d/rc.local
</code></pre></div><h2 id="三、运维"><a href="#三、运维" class="header-anchor">#</a> 三、运维</h2> <h3 id="_3-1-服务管理"><a href="#_3-1-服务管理" class="header-anchor">#</a> 3.1 服务管理</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 启动</span>
/usr/local/nginx/sbin/nginx

<span class="token comment"># 重启</span>
/usr/local/nginx/sbin/nginx -s reload

<span class="token comment"># 关闭进程</span>
/usr/local/nginx/sbin/nginx -s stop

<span class="token comment"># 平滑关闭nginx</span>
/usr/local/nginx/sbin/nginx -s quit

<span class="token comment"># 查看nginx的安装状态，</span>
/usr/local/nginx/sbin/nginx -V 
</code></pre></div><p><strong>关闭防火墙，或者添加防火墙规则就可以测试了</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">service</span> iptables stop
</code></pre></div><p>或者编辑配置文件：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">vi</span> /etc/sysconfig/iptables
</code></pre></div><p>添加这样一条开放80端口的规则后保存：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>-A INPUT -m state --state NEW -m tcp -p tcp --dport <span class="token number">80</span> -j ACCEPT
</code></pre></div><p>重启服务即可:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">service</span> iptables restart
<span class="token comment"># 命令进行查看目前nat</span>
iptables -t nat -L
</code></pre></div><h3 id="_3-2-重启服务防火墙报错解决"><a href="#_3-2-重启服务防火墙报错解决" class="header-anchor">#</a> 3.2 重启服务防火墙报错解决</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">service</span> iptables restart
<span class="token comment"># Redirecting to /bin/systemctl restart  iptables.service</span>
<span class="token comment"># Failed to restart iptables.service: Unit iptables.service failed to load: No such file or directory.</span>
</code></pre></div><ul><li>在<code>CentOS 7</code>或<code>RHEL 7</code>或<code>Fedora</code>中防火墙由 <strong><code>firewalld</code></strong> 来管理，当然你可以还原传统的管理方式。或则使用新的命令进行管理。
假如采用传统请执行一下命令</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 传统命令</span>
systemctl stop firewalld
systemctl mask firewalld
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 安装命令</span>
yum <span class="token function">install</span> iptables-services

systemctl <span class="token builtin class-name">enable</span> iptables 
<span class="token function">service</span> iptables restart
</code></pre></div><h2 id="四、nginx卸载"><a href="#四、nginx卸载" class="header-anchor">#</a> 四、nginx卸载</h2> <ul><li>如果通过<code>yum</code>安装，使用下面命令安装。</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>yum remove nginx
</code></pre></div><ul><li>编译安装，删除<code>/usr/local/nginx</code>目录即可</li> <li>如果配置了自启动脚本，也需要删除。</li></ul> <h2 id="五、参数说明"><a href="#五、参数说明" class="header-anchor">#</a> 五、参数说明</h2> <table><thead><tr><th>参数</th> <th>说明</th></tr></thead> <tbody><tr><td>--prefix=<code>&lt;path&gt;</code></td> <td>Nginx安装路径。如果没有指定，默认为 /usr/local/nginx。</td></tr> <tr><td>--sbin-path=<code>&lt;path&gt;</code></td> <td>Nginx可执行文件安装路径。只能安装时指定，如果没有指定，默认为<code>&lt;prefix&gt;</code>/sbin/nginx。</td></tr> <tr><td>--conf-path=<code>&lt;path&gt;</code></td> <td>在没有给定-c选项下默认的nginx.conf的路径。如果没有指定，默认为<code>&lt;prefix&gt;</code>/conf/nginx.conf。</td></tr> <tr><td>--pid-path=<code>&lt;path&gt;</code></td> <td>在nginx.conf中没有指定pid指令的情况下，默认的nginx.pid的路径。如果没有指定，默认为 <code>&lt;prefix&gt;</code>/logs/nginx.pid。</td></tr> <tr><td>--lock-path=<code>&lt;path&gt;</code></td> <td>nginx.lock文件的路径。</td></tr> <tr><td>--error-log-path=<code>&lt;path&gt;</code></td> <td>在nginx.conf中没有指定error_log指令的情况下，默认的错误日志的路径。如果没有指定，默认为 <code>&lt;prefix&gt;</code>/- logs/error.log。</td></tr> <tr><td>--http-log-path=<code>&lt;path&gt;</code></td> <td>在nginx.conf中没有指定access_log指令的情况下，默认的访问日志的路径。如果没有指定，默认为 <code>&lt;prefix&gt;</code>/- logs/access.log。</td></tr> <tr><td>--user=<code>&lt;user&gt;</code></td> <td>在nginx.conf中没有指定user指令的情况下，默认的nginx使用的用户。如果没有指定，默认为 nobody。</td></tr> <tr><td>--group=<code>&lt;group&gt;</code></td> <td>在nginx.conf中没有指定user指令的情况下，默认的nginx使用的组。如果没有指定，默认为 nobody。</td></tr> <tr><td>--builddir=DIR</td> <td>指定编译的目录</td></tr> <tr><td>--with-rtsig_module</td> <td>启用 rtsig 模块</td></tr> <tr><td>--with-select_module --without-select_module</td> <td>允许或不允许开启SELECT模式，如果 configure 没有找到更合适的模式，比如：kqueue(sun os),epoll (linux kenel 2.6+), rtsig(- 实时信号)或者/dev/poll(一种类似select的模式，底层实现与SELECT基本相 同，都是采用轮训方法) SELECT模式将是默认安装模式</td></tr> <tr><td>--with-poll_module --without-poll_module</td> <td>Whether or not to enable the poll module. This module is enabled by, default if a more suitable method such as kqueue, epoll, rtsig or /dev/poll is not discovered by configure.</td></tr> <tr><td>--with-http_ssl_module</td> <td>Enable ngx_http_ssl_module. Enables SSL support and the ability to handle HTTPS requests. Requires OpenSSL. On Debian, this is libssl-dev. 开启HTTP SSL模块，使NGINX可以支持HTTPS请求。这个模块需要已经安装了OPENSSL，在DEBIAN上是libssl</td></tr> <tr><td>--with-http_realip_module</td> <td>启用 ngx_http_realip_module</td></tr> <tr><td>--with-http_addition_module</td> <td>启用 ngx_http_addition_module</td></tr> <tr><td>--with-http_sub_module</td> <td>启用 ngx_http_sub_module</td></tr> <tr><td>--with-http_dav_module</td> <td>启用 ngx_http_dav_module</td></tr> <tr><td>--with-http_flv_module</td> <td>启用 ngx_http_flv_module</td></tr> <tr><td>--with-http_stub_status_module</td> <td>启用 "server status" 页</td></tr> <tr><td>--without-http_charset_module</td> <td>禁用 ngx_http_charset_module</td></tr> <tr><td>--without-http_gzip_module</td> <td>禁用 ngx_http_gzip_module. 如果启用，需要 zlib 。</td></tr> <tr><td>--without-http_ssi_module</td> <td>禁用 ngx_http_ssi_module</td></tr> <tr><td>--without-http_userid_module</td> <td>禁用 ngx_http_userid_module</td></tr> <tr><td>--without-http_access_module</td> <td>禁用 ngx_http_access_module</td></tr> <tr><td>--without-http_auth_basic_module</td> <td>禁用 ngx_http_auth_basic_module</td></tr> <tr><td>--without-http_autoindex_module</td> <td>禁用 ngx_http_autoindex_module</td></tr> <tr><td>--without-http_geo_module</td> <td>禁用 ngx_http_geo_module</td></tr> <tr><td>--without-http_map_module</td> <td>禁用 ngx_http_map_module</td></tr> <tr><td>--without-http_referer_module</td> <td>禁用 ngx_http_referer_module</td></tr> <tr><td>--without-http_rewrite_module</td> <td>禁用 ngx_http_rewrite_module. 如果启用需要 PCRE 。</td></tr> <tr><td>--without-http_proxy_module</td> <td>禁用 ngx_http_proxy_module</td></tr> <tr><td>--without-http_fastcgi_module</td> <td>禁用 ngx_http_fastcgi_module</td></tr> <tr><td>--without-http_memcached_module</td> <td>禁用 ngx_http_memcached_module</td></tr> <tr><td>--without-http_limit_zone_module</td> <td>禁用 ngx_http_limit_zone_module</td></tr> <tr><td>--without-http_empty_gif_module</td> <td>禁用 ngx_http_empty_gif_module</td></tr> <tr><td>--without-http_browser_module</td> <td>禁用 ngx_http_browser_module</td></tr> <tr><td>--without-http_upstream_ip_hash_module</td> <td>禁用 ngx_http_upstream_ip_hash_module</td></tr> <tr><td>--with-http_perl_module</td> <td>启用 ngx_http_perl_module</td></tr> <tr><td>--with-perl_modules_path=PATH</td> <td>指定 perl 模块的路径</td></tr> <tr><td>--with-perl=PATH</td> <td>指定 perl 执行文件的路径</td></tr> <tr><td>--http-log-path=PATH</td> <td>Set path to the http access log</td></tr> <tr><td>--http-client-body-temp-path=PATH</td> <td>Set path to the http client request body temporary files</td></tr> <tr><td>--http-proxy-temp-path=PATH</td> <td>Set path to the http proxy temporary files</td></tr> <tr><td>--http-fastcgi-temp-path=PATH</td> <td>Set path to the http fastcgi temporary files</td></tr> <tr><td>--without-http</td> <td>禁用 HTTP server</td></tr> <tr><td>--with-mail</td> <td>启用 IMAP4/POP3/SMTP 代理模块</td></tr> <tr><td>--with-mail_ssl_module</td> <td>启用 ngx_mail_ssl_module</td></tr> <tr><td>--with-cc=PATH</td> <td>指定 C 编译器的路径</td></tr> <tr><td>--with-cpp=PATH</td> <td>指定 C 预处理器的路径</td></tr> <tr><td>--with-cc-opt=OPTIONS</td> <td>Additional parameters which will be added to the variable CFLAGS. With the use of the system library PCRE in FreeBSD, it is necessary to indicate --with-cc-opt="-I /usr/local/include". If we are using select() and it is necessary to increase the number of file descriptors, then this also can be assigned here: --with-cc-opt="-D FD_SETSIZE=2048".</td></tr> <tr><td>--with-ld-opt=OPTIONS</td> <td>Additional parameters passed to the linker. With the use of the system library PCRE in - FreeBSD, it is necessary to indicate --with-ld-opt="-L /usr/local/lib".</td></tr> <tr><td>--with-cpu-opt=CPU</td> <td>为特定的 CPU 编译，有效的值包括：pentium, pentiumpro, pentium3, pentium4, athlon, opteron, amd64, sparc32, sparc64, ppc64</td></tr> <tr><td>--without-pcre</td> <td>禁止 PCRE 库的使用。同时也会禁止 HTTP rewrite 模块。在 "location" 配置指令中的正则表达式也需要 PCRE 。</td></tr> <tr><td>--with-pcre=DIR</td> <td>指定 PCRE 库的源代码的路径。</td></tr> <tr><td>--with-pcre-opt=OPTIONS</td> <td>Set additional options for PCRE building.</td></tr> <tr><td>--with-md5=DIR</td> <td>Set path to md5 library sources.</td></tr> <tr><td>--with-md5-opt=OPTIONS</td> <td>Set additional options for md5 building.</td></tr> <tr><td>--with-md5-asm</td> <td>Use md5 assembler sources.</td></tr> <tr><td>--with-sha1=DIR</td> <td>Set path to sha1 library sources.</td></tr> <tr><td>--with-sha1-opt=OPTIONS</td> <td>Set additional options for sha1 building.</td></tr> <tr><td>--with-sha1-asm</td> <td>Use sha1 assembler sources.</td></tr> <tr><td>--with-zlib=DIR</td> <td>Set path to zlib library sources.</td></tr> <tr><td>--with-zlib-opt=OPTIONS</td> <td>Set additional options for zlib building.</td></tr> <tr><td>--with-zlib-asm=CPU</td> <td>Use zlib assembler sources optimized for specified CPU, valid values are: pentium, pentiumpro</td></tr> <tr><td>--with-openssl=DIR</td> <td>Set path to OpenSSL library sources</td></tr> <tr><td>--with-openssl-opt=OPTIONS</td> <td>Set additional options for OpenSSL building</td></tr> <tr><td>--with-debug</td> <td>启用调试日志</td></tr> <tr><td>--add-module=PATH</td> <td>Add in a third-party module found in directory PATH</td></tr></tbody></table> <h2 id="六、配置"><a href="#六、配置" class="header-anchor">#</a> 六、配置</h2> <ul><li>在<code>Centos</code> 默认配置文件在 <strong><code>/usr/local/nginx-1.5.1/conf/nginx.conf</code></strong> 我们要在这里配置一些文件。<code>nginx.conf</code>是主配置文件，由若干个部分组成，每个大括号<code>{}</code>表示一个部分。每一行指令都由分号结束<code>;</code>，标志着一行的结束。</li></ul> <h3 id="_6-1-常用正则"><a href="#_6-1-常用正则" class="header-anchor">#</a> 6.1 常用正则</h3> <table><thead><tr><th>正则</th> <th>说明</th> <th>正则</th> <th>说明</th></tr></thead> <tbody><tr><td><code>.</code></td> <td>匹配除换行符以外的任意字符</td> <td><code>$</code></td> <td>匹配字符串的结束</td></tr> <tr><td><code>?</code></td> <td>重复0次或1次</td> <td><code>{n}</code></td> <td>重复n次</td></tr> <tr><td><code>+</code></td> <td>重复1次或更多次</td> <td><code>{n,}</code></td> <td>重复n次或更多次</td></tr> <tr><td><code>*</code></td> <td>重复0次或更多次</td> <td><code>[c]</code></td> <td>匹配单个字符c</td></tr> <tr><td><code>\d</code></td> <td>匹配数字</td> <td><code>[a-z]</code></td> <td>匹配a-z小写字母的任意一个</td></tr> <tr><td><code>^</code></td> <td>匹配字符串的开始</td> <td>-</td> <td>-</td></tr></tbody></table> <h3 id="_6-2-全局变量"><a href="#_6-2-全局变量" class="header-anchor">#</a> 6.2 全局变量</h3> <table><thead><tr><th>变量</th> <th>说明</th> <th>变量</th> <th>说明</th></tr></thead> <tbody><tr><td><code>$args</code></td> <td>这个变量等于请求行中的参数，同<code>$query_string</code></td> <td><code>$remote_port</code></td> <td>客户端的端口。</td></tr> <tr><td><code>$content_length</code></td> <td>请求头中的<code>Content-length</code>字段。</td> <td><code>$remote_user</code></td> <td>已经经过<code>Auth Basic Module</code>验证的用户名。</td></tr> <tr><td><code>$content_type</code></td> <td>请求头中的<code>Content-Type</code>字段。</td> <td><code>$request_filename</code></td> <td>当前请求的文件路径，由<code>root</code>或<code>alias</code>指令与<code>URI</code>请求生成。</td></tr> <tr><td><code>$document_root</code></td> <td>当前请求在<code>root</code>指令中指定的值。</td> <td><code>$scheme</code></td> <td><code>HTTP</code>方法（如<code>http</code>，<code>https</code>）。</td></tr> <tr><td><code>$host</code></td> <td>请求主机头字段，否则为服务器名称。</td> <td><code>$server_protocol</code></td> <td>请求使用的协议，通常是<code>HTTP/1.0</code>或<code>HTTP/1.1</code>。</td></tr> <tr><td><code>$http_user_agent</code></td> <td>客户端<code>agent</code>信息</td> <td><code>$server_addr</code></td> <td>服务器地址，在完成一次系统调用后可以确定这个值。</td></tr> <tr><td><code>$http_cookie</code></td> <td>客户端<code>cookie</code>信息</td> <td><code>$server_name</code></td> <td>服务器名称。</td></tr> <tr><td><code>$limit_rate</code></td> <td>这个变量可以限制连接速率。</td> <td><code>$server_port</code></td> <td>请求到达服务器的端口号。</td></tr> <tr><td><code>$request_method</code></td> <td>客户端请求的动作，通常为<code>GET</code>或<code>POST</code>。</td> <td><code>$request_uri</code></td> <td>包含请求参数的原始<code>URI</code>，不包含主机名，如：<code>/foo/bar.php?arg=baz</code>。</td></tr> <tr><td><code>$remote_addr</code></td> <td>客户端的IP地址。</td> <td><code>$uri</code></td> <td>不带请求参数的当前<code>URI</code>，<code>$uri</code>不包含主机名，如<code>/foo/bar.html</code>。</td></tr> <tr><td><code>$document_uri</code></td> <td>与<code>$uri</code>相同。</td> <td>-</td> <td>-</td></tr></tbody></table> <p>例如请求：<code>http://localhost:3000/test1/test2/test.php</code></p> <div class="language- extra-class"><pre class="language-text"><code>$host：localhost  
$server_port：3000  
$request_uri：/test1/test2/test.php  
$document_uri：/test1/test2/test.php  
$document_root：/var/www/html  
$request_filename：/var/www/html/test1/test2/test.php  
</code></pre></div><h3 id="_6-3-符号参考"><a href="#_6-3-符号参考" class="header-anchor">#</a> 6.3 符号参考</h3> <table><thead><tr><th>符号</th> <th>说明</th> <th>符号</th> <th>说明</th> <th>符号</th> <th>说明</th></tr></thead> <tbody><tr><td><code>k</code>,<code>K</code></td> <td>千字节</td> <td><code>m</code>,<code>M</code></td> <td>兆字节</td> <td><code>ms</code></td> <td>毫秒</td></tr> <tr><td><code>s</code></td> <td>秒</td> <td><code>m</code></td> <td>分钟</td> <td><code>h</code></td> <td>小时</td></tr> <tr><td><code>d</code></td> <td>日</td> <td><code>w</code></td> <td>周</td> <td><code>M</code></td> <td>一个月, <code>30</code>天</td></tr></tbody></table> <ul><li>例如，"8k"，"1m" 代表字节数计量。</li> <li>例如，"1h 30m"，"1y 6M"。代表 "1小时 30分"，"1年零6个月"。</li></ul> <h3 id="_6-4-配置文件"><a href="#_6-4-配置文件" class="header-anchor">#</a> 6.4 配置文件</h3> <ul><li><code>nginx</code> 的配置系统由一个主配置文件和其他一些辅助的配置文件构成。这些配置文件均是纯文本文件，全部位于 <code>nginx</code> 安装目录下的 <code>conf</code> 目录下。</li> <li>指令由 <code>nginx</code> 的各个模块提供，不同的模块会提供不同的指令来实现配置。
指令除了 <code>Key-Value</code> 的形式，还有作用域指令。</li> <li><code>nginx.conf</code> 中的配置信息，根据其逻辑上的意义，对它们进行了分类，也就是分成了多个作用域，或者称之为配置指令上下文。不同的作用域含有一个或者多个配置项。</li></ul> <blockquote><p>下面的这些上下文指令是用的比较多：</p></blockquote> <table><thead><tr><th><code>Directive</code></th> <th><code>Description</code></th> <th><code>Contains Directive</code></th></tr></thead> <tbody><tr><td><code>main</code></td> <td><code>nginx</code> 在运行时与具体业务功能（比如 <code>http</code> 服务或者 <code>email</code>服务代理）无关的一些参数，比如工作进程数，运行的身份等。</td> <td><code>user</code>, <code>worker_processes</code>, <code>error_log</code>, <code>events</code>, <code>http</code>, <code>mail</code></td></tr> <tr><td><code>http</code></td> <td>与提供 <code>http</code> 服务相关的一些配置参数。例如：是否使用 <code>keepalive</code>啊，是否使用<code>gzip</code> 进行压缩等。</td> <td><code>server</code></td></tr> <tr><td><code>server</code></td> <td><code>http</code> 服务上支持若干虚拟主机。每个虚拟主机一个对应的 <code>server</code> 配置项，配置项里面包含该虚拟主机相关的配置。在提供 <code>mail</code> 服务的代理时，也可以建立若干 <code>server.</code> 每个 <code>server</code> 通过监听的地址来区分。</td> <td><code>listen</code>, <code>server_name</code>,<code>access_log</code>, <code>location</code>, <code>protocol</code>, <code>proxy</code>, <code>smtp_auth</code>, <code>xclient</code></td></tr> <tr><td><code>location</code></td> <td><code>http</code> 服务中，某些特定的 <code>URL</code> 对应的一系列配置项。</td> <td><code>index</code>, <code>root</code></td></tr> <tr><td><code>mail</code></td> <td>实现<code>email</code>相关的 <code>SMTP/IMAP/POP3</code> 代理时，共享的一些配置项（因为可能实现多个代理，工作在多个监听地址上）。</td> <td><code>server</code>,<code>http</code>, <code>imap_capabilities</code></td></tr> <tr><td><code>include</code></td> <td>以便增强配置文件的可读性，使得部分配置文件可以重新使用。</td> <td>-</td></tr> <tr><td><code>valid_referers</code></td> <td>用来校验<code>Http</code>请求头<code>Referer</code>是否有效。</td> <td>-</td></tr> <tr><td><code>try_files</code></td> <td>用在<code>server</code>部分，不过最常见的还是用在<code>location</code>部分，它会按照给定的参数顺序进行尝试，第一个被匹配到的将会被使用。</td> <td>-</td></tr> <tr><td><code>if</code></td> <td>当在<code>location</code>块中使用<code>if</code>指令，在某些情况下它并不按照预期运行，一般来说避免使用<code>if</code>指令。</td> <td>-</td></tr></tbody></table> <ul><li>例如我们再 <strong><code>nginx.conf</code></strong> 里面引用两个配置 <code>vhost/example.com.conf</code>和 <code>vhost/gitlab.com.conf</code> 它们都被放在一个我自己新建的目录 <code>vhost</code>下面。<code>nginx.conf</code> 配置如下：</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">worker_processes</span>  <span class="token number">1</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">events</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">worker_connections</span>  <span class="token number">1024</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">include</span>       mime.types</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">default_type</span>  application/octet-stream</span><span class="token punctuation">;</span>

    <span class="token comment">#log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span>
    <span class="token comment">#                  '$status $body_bytes_sent "$http_referer" '</span>
    <span class="token comment">#                  '"$http_user_agent" "$http_x_forwarded_for"';</span>

    <span class="token comment">#access_log  logs/access.log  main;</span>

    <span class="token directive"><span class="token keyword">sendfile</span>        <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token comment">#tcp_nopush     on;</span>

    <span class="token comment">#keepalive_timeout  0;</span>
    <span class="token directive"><span class="token keyword">keepalive_timeout</span>  <span class="token number">65</span></span><span class="token punctuation">;</span>

    <span class="token comment">#gzip  on;</span>
    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">server_name</span>  localhost</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
            <span class="token directive"><span class="token keyword">root</span>   html</span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">index</span>  index.html index.htm</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token directive"><span class="token keyword">error_page</span>   <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span>  /50x.html</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">location</span> = /50x.html</span> <span class="token punctuation">{</span>
            <span class="token directive"><span class="token keyword">root</span>   html</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token directive"><span class="token keyword">include</span>  vhost/example.com.conf</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">include</span>  vhost/gitlab.com.conf</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>简单的配置: <code>example.com.conf</code></li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token comment">#侦听的80端口</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  baidu.com app.baidu.com</span><span class="token punctuation">;</span> <span class="token comment"># 这里指定域名</span>
    <span class="token directive"><span class="token keyword">index</span>        index.html index.htm</span><span class="token punctuation">;</span>    <span class="token comment"># 这里指定默认入口页面</span>
    <span class="token directive"><span class="token keyword">root</span> /home/www/app.baidu.com</span><span class="token punctuation">;</span>         <span class="token comment"># 这里指定目录</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_6-5-内置预定义变量"><a href="#_6-5-内置预定义变量" class="header-anchor">#</a> 6.5 内置预定义变量</h3> <ul><li><code>Nginx</code>提供了许多预定义的变量，也可以通过使用<code>set</code>来设置变量。你可以在<code>if</code>中使用预定义变量，也可以将它们传递给代理服务器。以下是一些常见的预定义变量，<a href="http://nginx.org/en/docs/varindex.html" target="_blank" rel="noopener noreferrer">更多详见<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <table><thead><tr><th>变量名称</th> <th>值</th></tr></thead> <tbody><tr><td><code>$args_name</code></td> <td>在请求中的<code>name</code>参数</td></tr> <tr><td><code>$args</code>  `</td> <td>所有请求参数</td></tr> <tr><td><code>$query_string</code></td> <td><code>$args</code>的别名</td></tr> <tr><td><code>$content_length</code></td> <td>请求头<code>Content-Length</code>的值</td></tr> <tr><td><code>$content_type</code></td> <td>请求头<code>Content-Type</code>的值</td></tr> <tr><td><code>$host</code></td> <td>如果当前有<code>Host</code>，则为请求头<code>Host</code>的值；如果没有这个头，那么该值等于匹配该请求的<code>server_name</code>的值</td></tr> <tr><td><code>$remote_addr</code></td> <td>客户端的<code>IP</code>地址</td></tr> <tr><td><code>$request</code></td> <td>完整的请求，从客户端收到，包括<code>Http</code>请求方法、<code>URI</code>、<code>Http</code>协议、头、请求体</td></tr> <tr><td><code>$request_uri</code></td> <td>完整请求的<code>URI</code>，从客户端来的请求，包括参数</td></tr> <tr><td><code>$scheme</code></td> <td>当前请求的协议</td></tr> <tr><td><code>$uri</code></td> <td>当前请求的标准化<code>URI</code></td></tr></tbody></table> <h3 id="_6-6-反向代理"><a href="#_6-6-反向代理" class="header-anchor">#</a> 6.6 反向代理</h3> <ul><li>反向代理是一个<code>Web</code>服务器，它接受客户端的连接请求，然后将请求转发给上游服务器，并将从服务器得到的结果返回给连接的客户端。下面简单的反向代理的例子：</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>  
  <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>                                                        
  <span class="token directive"><span class="token keyword">server_name</span>  localhost</span><span class="token punctuation">;</span>                                              
  <span class="token directive"><span class="token keyword">client_max_body_size</span> <span class="token number">1024M</span></span><span class="token punctuation">;</span>  <span class="token comment"># 允许客户端请求的最大单文件字节数</span>

  <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span>                         http://localhost:8080</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> Host              <span class="token variable">$host</span>:<span class="token variable">$server_port</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For   <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span> <span class="token comment"># HTTP的请求端真实的IP</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Proto <span class="token variable">$scheme</span></span><span class="token punctuation">;</span>      <span class="token comment"># 为了正确地识别实际用户发出的协议是 http 还是 https</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>复杂的配置: <code>gitlab.com.conf</code>。</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token comment">#侦听的80端口</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  git.example.cn</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span>   http://localhost:3000</span><span class="token punctuation">;</span>
        <span class="token comment">#以下是一些反向代理的配置可删除</span>
        <span class="token directive"><span class="token keyword">proxy_redirect</span>             <span class="token boolean">off</span></span><span class="token punctuation">;</span>
        <span class="token comment">#后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span>           Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">client_max_body_size</span>       <span class="token number">10m</span></span><span class="token punctuation">;</span> <span class="token comment">#允许客户端请求的最大单文件字节数</span>
        <span class="token directive"><span class="token keyword">client_body_buffer_size</span>    <span class="token number">128k</span></span><span class="token punctuation">;</span> <span class="token comment">#缓冲区代理缓冲用户端请求的最大字节数</span>
        <span class="token directive"><span class="token keyword">proxy_connect_timeout</span>      <span class="token number">300</span></span><span class="token punctuation">;</span> <span class="token comment">#nginx跟后端服务器连接超时时间(代理连接超时)</span>
        <span class="token directive"><span class="token keyword">proxy_send_timeout</span>         <span class="token number">300</span></span><span class="token punctuation">;</span> <span class="token comment">#后端服务器数据回传时间(代理发送超时)</span>
        <span class="token directive"><span class="token keyword">proxy_read_timeout</span>         <span class="token number">300</span></span><span class="token punctuation">;</span> <span class="token comment">#连接成功后，后端服务器响应时间(代理接收超时)</span>
        <span class="token directive"><span class="token keyword">proxy_buffer_size</span>          <span class="token number">4k</span></span><span class="token punctuation">;</span> <span class="token comment">#设置代理服务器（nginx）保存用户头信息的缓冲区大小</span>
        <span class="token directive"><span class="token keyword">proxy_buffers</span>              <span class="token number">4</span> <span class="token number">32k</span></span><span class="token punctuation">;</span> <span class="token comment">#proxy_buffers缓冲区，网页平均在32k以下的话，这样设置</span>
        <span class="token directive"><span class="token keyword">proxy_busy_buffers_size</span>    <span class="token number">64k</span></span><span class="token punctuation">;</span> <span class="token comment">#高负荷下缓冲大小（proxy_buffers*2）</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>代理到上游服务器的配置中，最重要的是<code>proxy_pass</code>指令。以下是代理模块中的一些常用指令：</li></ul> <table><thead><tr><th>指令</th> <th>说明</th></tr></thead> <tbody><tr><td><code>proxy_connect_timeout</code></td> <td><code>Nginx</code>从接受请求至连接到上游服务器的最长等待时间</td></tr> <tr><td><code>proxy_send_timeout</code></td> <td>后端服务器数据回传时间(代理发送超时)</td></tr> <tr><td><code>proxy_read_timeout</code></td> <td>连接成功后，后端服务器响应时间(代理接收超时)</td></tr> <tr><td><code>proxy_cookie_domain</code></td> <td>替代从上游服务器来的<code>Set-Cookie</code>头的<code>domain</code>属性</td></tr> <tr><td><code>proxy_cookie_path</code></td> <td>替代从上游服务器来的<code>Set-Cookie</code>头的<code>path</code>属性</td></tr> <tr><td><code>proxy_buffer_size</code></td> <td>设置代理服务器（<code>nginx</code>）保存用户头信息的缓冲区大小</td></tr> <tr><td><code>proxy_buffers</code></td> <td><code>proxy_buffers</code>缓冲区，网页平均在多少k以下</td></tr> <tr><td><code>proxy_set_header</code></td> <td>重写发送到上游服务器头的内容，也可以通过将某个头部的值设置为空字符串，而不发送某个头部的方法实现</td></tr> <tr><td><code>proxy_ignore_headers</code></td> <td>这个指令禁止处理来自代理服务器的应答。</td></tr> <tr><td><code>proxy_intercept_errors</code></td> <td>使<code>nginx</code>阻止<code>HTTP</code>应答代码为<code>400</code>或者更高的应答。</td></tr></tbody></table> <h3 id="_6-7-负载均衡"><a href="#_6-7-负载均衡" class="header-anchor">#</a> 6.7 负载均衡</h3> <ul><li><code>upstream</code>指令启用一个新的配置区段，在该区段定义一组上游服务器。这些服务器可能被设置不同的权重，也可能出于对服务器进行维护，标记为<code>down</code>。</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> gitlab</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">ip_hash</span></span><span class="token punctuation">;</span>
    <span class="token comment"># upstream的负载均衡，weight是权重，可以根据机器配置定义权重。weigth参数表示权值，权值越高被分配到的几率越大。</span>
    <span class="token directive"><span class="token keyword">server</span> 192.168.122.11:8081</span> <span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:82 weight=3</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:83 weight=3 down</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:84 weight=3</span><span class="token punctuation">;</span> <span class="token directive"><span class="token keyword">max_fails=3</span>  fail_timeout=20s</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:85 weight=4</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">keepalive</span> <span class="token number">32</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token comment">#侦听的80端口</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  git.example.cn</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span>   http://gitlab</span><span class="token punctuation">;</span>    <span class="token comment">#在这里设置一个代理，和upstream的名字一样</span>
        <span class="token comment">#以下是一些反向代理的配置可删除</span>
        <span class="token directive"><span class="token keyword">proxy_redirect</span>             <span class="token boolean">off</span></span><span class="token punctuation">;</span>
        <span class="token comment">#后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span>           Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span>           X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span>           X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">client_max_body_size</span>       <span class="token number">10m</span></span><span class="token punctuation">;</span>  <span class="token comment">#允许客户端请求的最大单文件字节数</span>
        <span class="token directive"><span class="token keyword">client_body_buffer_size</span>    <span class="token number">128k</span></span><span class="token punctuation">;</span> <span class="token comment">#缓冲区代理缓冲用户端请求的最大字节数</span>
        <span class="token directive"><span class="token keyword">proxy_connect_timeout</span>      <span class="token number">300</span></span><span class="token punctuation">;</span>  <span class="token comment">#nginx跟后端服务器连接超时时间(代理连接超时)</span>
        <span class="token directive"><span class="token keyword">proxy_send_timeout</span>         <span class="token number">300</span></span><span class="token punctuation">;</span>  <span class="token comment">#后端服务器数据回传时间(代理发送超时)</span>
        <span class="token directive"><span class="token keyword">proxy_read_timeout</span>         <span class="token number">300</span></span><span class="token punctuation">;</span>  <span class="token comment">#连接成功后，后端服务器响应时间(代理接收超时)</span>
        <span class="token directive"><span class="token keyword">proxy_buffer_size</span>          <span class="token number">4k</span></span><span class="token punctuation">;</span> <span class="token comment">#设置代理服务器（nginx）保存用户头信息的缓冲区大小</span>
        <span class="token directive"><span class="token keyword">proxy_buffers</span>              <span class="token number">4</span> <span class="token number">32k</span></span><span class="token punctuation">;</span><span class="token comment"># 缓冲区，网页平均在32k以下的话，这样设置</span>
        <span class="token directive"><span class="token keyword">proxy_busy_buffers_size</span>    <span class="token number">64k</span></span><span class="token punctuation">;</span> <span class="token comment">#高负荷下缓冲大小（proxy_buffers*2）</span>
        <span class="token directive"><span class="token keyword">proxy_temp_file_write_size</span> <span class="token number">64k</span></span><span class="token punctuation">;</span> <span class="token comment">#设定缓存文件夹大小，大于这个值，将从upstream服务器传</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器<code>down</code>掉，能自动剔除。</li></ul> <p><strong>负载均衡：</strong></p> <ul><li><code>upstream</code>模块能够使用3种负载均衡算法：轮询、IP哈希、最少连接数。</li></ul> <p><strong>轮询：</strong></p> <ul><li>默认情况下使用轮询算法，不需要配置指令来激活它，它是基于在队列中谁是下一个的原理确保访问均匀地分布到每个上游服务器；</li></ul> <p><strong>IP哈希：</strong></p> <ul><li>通过<code>ip_hash</code>指令来激活，Nginx通过IPv4地址的前3个字节或者整个IPv6地址作为哈希键来实现，同一个IP地址总是能被映射到同一个上游服务器；</li></ul> <p><strong>最少连接数：</strong></p> <ul><li>通过<code>least_conn</code>指令来激活，该算法通过选择一个活跃数最少的上游服务器进行连接。如果上游服务器处理能力不同，可以通过给<code>server</code>配置<code>weight</code>权重来说明，该算法将考虑到不同服务器的加权最少连接数。</li></ul> <h4 id="_6-7-1-rr"><a href="#_6-7-1-rr" class="header-anchor">#</a> 6.7.1 RR</h4> <p><strong>简单配置</strong></p> <blockquote><p>这里我配置了2台服务器，当然实际上是一台，只是端口不一样而已，而8081的服务器是不存在的，也就是说访问不到，但是我们访问 <code>http://localhost</code> 的时候，也不会有问题，会默认跳转到<code>http://localhost:8080</code>具体是因为Nginx会自动判断服务器的状态，如果服务器处于不能访问（服务器挂了），就不会跳转到这台服务器，所以也避免了一台服务器挂了影响使用的情况，由于Nginx默认是RR策略，所以我们不需要其他更多的设置</p></blockquote> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> test</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">server</span> localhost:8080</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> localhost:8081</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">81</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  localhost</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">client_max_body_size</span> <span class="token number">1024M</span></span><span class="token punctuation">;</span>
 
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://test</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span>:<span class="token variable">$server_port</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>负载均衡的核心代码为</strong></p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> test</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">server</span> localhost:8080</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> localhost:8081</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_6-7-2-权重"><a href="#_6-7-2-权重" class="header-anchor">#</a> 6.7.2 权重</h4> <ul><li>指定轮询几率，<code>weight</code>和访问比率成正比，用于后端服务器性能不均的情况。 例如</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> test</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">server</span> localhost:8080 weight=9</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> localhost:8081 weight=1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>那么10次一般只会有<code>1</code>次会访问到<code>8081</code>，而有<code>9</code>次会访问到<code>8080</code></li></ul> <h4 id="_6-7-3-ip-hash"><a href="#_6-7-3-ip-hash" class="header-anchor">#</a> 6.7.3 ip_hash</h4> <blockquote><p>上面的2种方式都有一个问题，那就是下一个请求来的时候请求可能分发到另外一个服务器，当我们的程序不是无状态的时候（采用了<code>session</code>保存数据），这时候就有一个很大的很问题了，比如把登录信息保存到了<code>session</code>中，那么跳转到另外一台服务器的时候就需要重新登录了，所以很多时候我们需要一个客户只访问一个服务器，那么就需要用<code>iphash</code>了，<code>iphash</code>的每个请求按访问<code>ip</code>的<code>hash</code>结果分配，这样每个访客固定访问一个后端服务器，可以解决<code>session</code>的问题。</p></blockquote> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> test</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">ip_hash</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> localhost:8080</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> localhost:8081</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_6-7-4-fair"><a href="#_6-7-4-fair" class="header-anchor">#</a> 6.7.4 fair</h4> <ul><li>这是个第三方模块，按后端服务器的响应时间来分配请求，响应时间短的优先分配。</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> backend</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">fair</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> localhost:8080</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> localhost:8081</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_6-7-5-url-hash"><a href="#_6-7-5-url-hash" class="header-anchor">#</a> 6.7.5 url_hash</h4> <blockquote><p>这是个第三方模块，按访问<code>url</code>的<code>hash</code>结果来分配请求，使每个<code>url</code>定向到同一个后端服务器，后端服务器为缓存时比较有效。 在<code>upstream</code>中加入<code>hash</code>语句，<code>server</code>语句中不能写入<code>weight</code>等其他的参数，<code>hash_method</code>是使用的<code>hash</code>算法</p></blockquote> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> backend</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">hash</span> <span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">hash_method</span> crc32</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> localhost:8080</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> localhost:8081</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>以上<code>5</code>种负载均衡各自适用不同情况下使用，所以可以根据实际情况选择使用哪种策略模式，不过<code>fair</code>和<code>url_hash</code>需要安装第三方模块才能使用</li></ul> <p><strong>server指令可选参数：</strong></p> <ul><li><code>weight</code>：设置一个服务器的访问权重，数值越高，收到的请求也越多；</li> <li><code>fail_timeout</code>：在这个指定的时间内服务器必须提供响应，如果在这个时间内没有收到响应，那么服务器将会被标记为<code>down</code>状态；</li> <li><code>max_fails</code>：设置在<code>fail_timeout</code>时间之内尝试对一个服务器连接的最大次数，如果超过这个次数，那么服务器将会被标记为<code>down</code>;</li> <li><code>down</code>：标记一个服务器不再接受任何请求；</li> <li><code>backup</code>：一旦其他服务器宕机，那么有该标记的机器将会接收请求。</li></ul> <p><strong>keepalive指令：</strong></p> <ul><li><code>Nginx</code>服务器将会为每一个<code>worker</code>进行保持同上游服务器的连接。</li></ul> <h3 id="_6-8-屏蔽ip"><a href="#_6-8-屏蔽ip" class="header-anchor">#</a> 6.8 屏蔽ip</h3> <ul><li>在<code>nginx</code>的配置文件<code>nginx.conf</code>中加入如下配置，可以放到<code>http</code>, <code>server</code>, <code>location</code>, <code>limit_except</code>语句块，需要注意相对路径，本例当中<code>nginx.conf</code>，<code>blocksip.conf</code>在同一个目录中。</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">include</span> blockip.conf</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>在<code>blockip.conf</code>里面输入内容，如：</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">deny</span> 165.91.122.67</span><span class="token punctuation">;</span>

<span class="token directive"><span class="token keyword">deny</span> IP</span><span class="token punctuation">;</span>   <span class="token comment"># 屏蔽单个ip访问</span>
<span class="token directive"><span class="token keyword">allow</span> IP</span><span class="token punctuation">;</span>  <span class="token comment"># 允许单个ip访问</span>
<span class="token directive"><span class="token keyword">deny</span> all</span><span class="token punctuation">;</span>  <span class="token comment"># 屏蔽所有ip访问</span>
<span class="token directive"><span class="token keyword">allow</span> all</span><span class="token punctuation">;</span> <span class="token comment"># 允许所有ip访问</span>
<span class="token directive"><span class="token keyword">deny</span> 123.0.0.0/8   <span class="token comment"># 屏蔽整个段即从123.0.0.1到123.255.255.254访问的命令</span>
deny 124.45.0.0/16 <span class="token comment"># 屏蔽IP段即从123.45.0.1到123.45.255.254访问的命令</span>
deny 123.45.6.0/24 <span class="token comment"># 屏蔽IP段即从123.45.6.1到123.45.6.254访问的命令</span>

<span class="token comment"># 如果你想实现这样的应用，除了几个IP外，其他全部拒绝</span>
allow 1.1.1.1</span><span class="token punctuation">;</span> 
<span class="token directive"><span class="token keyword">allow</span> 1.1.1.2</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">deny</span> all</span><span class="token punctuation">;</span> 
</code></pre></div><h2 id="七、第三方模块安装方法"><a href="#七、第三方模块安装方法" class="header-anchor">#</a> 七、第三方模块安装方法</h2> <div class="language- extra-class"><pre class="language-text"><code>./configure --prefix=/你的安装目录  --add-module=/第三方模块目录
</code></pre></div><h2 id="八、重定向"><a href="#八、重定向" class="header-anchor">#</a> 八、重定向</h2> <ul><li><code>permanent</code> 永久性重定向。请求日志中的状态码为301</li> <li><code>redirect</code> 临时重定向。请求日志中的状态码为302</li></ul> <h3 id="_8-1-重定向整个网站"><a href="#_8-1-重定向整个网站" class="header-anchor">#</a> 8.1 重定向整个网站</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">server_name</span> old-site.com
    return <span class="token number">301</span> <span class="token variable">$scheme</span>://new-site.com<span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_8-2-重定向单页"><a href="#_8-2-重定向单页" class="header-anchor">#</a> 8.2 重定向单页</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">location</span> = /oldpage.html</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">return</span> <span class="token number">301</span> http://example.org/newpage.html</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_8-3-重定向整个子路径"><a href="#_8-3-重定向整个子路径" class="header-anchor">#</a> 8.3 重定向整个子路径</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> /old-site</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">rewrite</span> ^/old-site/(.*) http://example.org/new-site/<span class="token variable">$1</span> permanent</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="九、性能"><a href="#九、性能" class="header-anchor">#</a> 九、性能</h2> <h3 id="_9-1-内容缓存"><a href="#_9-1-内容缓存" class="header-anchor">#</a> 9.1 内容缓存</h3> <ul><li>允许浏览器基本上永久地缓存静态内容。 <code>Nginx</code>将为您设置<code>Expires</code>和<code>Cache-Control</code>头信息。</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> /static</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">root</span> /data</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">expires</span> max</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>如果要求浏览器永远不会缓存响应（例如用于跟踪请求），请使用<code>-1</code>。</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> = /empty.gif</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">empty_gif</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">expires</span> -1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_9-2-gzip压缩"><a href="#_9-2-gzip压缩" class="header-anchor">#</a> 9.2 Gzip压缩</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">gzip</span>  <span class="token boolean">on</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">gzip_buffers</span> <span class="token number">16</span> <span class="token number">8k</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">gzip_comp_level</span> <span class="token number">6</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">gzip_http_version</span> 1.1</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">gzip_min_length</span> <span class="token number">256</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">gzip_proxied</span> any</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">gzip_vary</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">gzip_types</span>
    text/xml application/xml application/atom+xml application/rss+xml application/xhtml+xml image/svg+xml
    text/javascript application/javascript application/x-javascript
    text/x-json application/json application/x-web-app-manifest+json
    text/css text/plain text/x-component
    font/opentype application/x-font-ttf application/vnd.ms-fontobject
    image/x-icon</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">gzip_disable</span>  <span class="token string">"msie6"</span></span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_9-3-打开文件缓存"><a href="#_9-3-打开文件缓存" class="header-anchor">#</a> 9.3 打开文件缓存</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">open_file_cache</span> max=1000 inactive=20s</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">open_file_cache_valid</span> <span class="token number">30s</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">open_file_cache_min_uses</span> <span class="token number">2</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">open_file_cache_errors</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_9-4-ssl缓存"><a href="#_9-4-ssl缓存" class="header-anchor">#</a> 9.4 SSL缓存</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">ssl_session_cache</span> shared:SSL:10m</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">ssl_session_timeout</span> <span class="token number">10m</span></span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_9-5-上游keepalive"><a href="#_9-5-上游keepalive" class="header-anchor">#</a> 9.5 上游Keepalive</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> backend</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8080</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">keepalive</span> <span class="token number">32</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    ...
    <span class="token directive"><span class="token keyword">location</span> /api/</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://backend</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_http_version</span> 1.1</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Connection <span class="token string">""</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_9-6-监控"><a href="#_9-6-监控" class="header-anchor">#</a> 9.6 监控</h3> <ul><li>使用<code>ngxtop</code>实时解析<code>nginx</code>访问日志，并且将处理结果输出到终端，功能类似于系统命令<code>top</code>。所有示例都读取<code>nginx</code>配置文件的访问日志位置和格式。如果要指定访问日志文件和/或日志格式，请使用-f和-a选项。</li> <li>注意：在<code>nginx</code>配置中<code>/usr/local/nginx/conf/nginx.conf</code>日志文件必须是绝对路径。</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 安装 ngxtop</span>
pip <span class="token function">install</span> ngxtop

<span class="token comment"># 实时状态</span>
ngxtop
<span class="token comment"># 状态为404的前10个请求的路径：</span>
ngxtop <span class="token function">top</span> request_path --filter <span class="token string">'status == 404'</span>

<span class="token comment"># 发送总字节数最多的前10个请求</span>
ngxtop --order-by <span class="token string">'avg(bytes_sent) * count'</span>

<span class="token comment"># 排名前十位的IP，例如，谁攻击你最多</span>
ngxtop --group-by remote_addr

<span class="token comment"># 打印具有4xx或5xx状态的请求，以及status和http referer</span>
ngxtop -i <span class="token string">'status &gt;= 400'</span> print request status http_referer

<span class="token comment"># 由200个请求路径响应发送的平均正文字节以'foo'开始：</span>
ngxtop avg bytes_sent --filter <span class="token string">'status == 200 and request_path.startswith("foo")'</span>

<span class="token comment"># 使用“common”日志格式从远程机器分析apache访问日志</span>
<span class="token function">ssh</span> remote <span class="token function">tail</span> -f /var/log/apache2/access.log <span class="token operator">|</span> ngxtop -f common
</code></pre></div><h2 id="十、常见使用场景"><a href="#十、常见使用场景" class="header-anchor">#</a> 十、常见使用场景</h2> <h3 id="_10-1-跨域问题"><a href="#_10-1-跨域问题" class="header-anchor">#</a> 10.1 跨域问题</h3> <ul><li>在工作中，有时候会遇到一些接口不支持跨域，这时候可以简单的添加<code>add_headers</code>来支持<code>cors</code>跨域。配置如下：</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">server_name</span> api.xxx.com</span><span class="token punctuation">;</span>
    
  <span class="token directive"><span class="token keyword">add_header</span> <span class="token string">'Access-Control-Allow-Origin'</span> <span class="token string">'*'</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">add_header</span> <span class="token string">'Access-Control-Allow-Credentials'</span> <span class="token string">'true'</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">add_header</span> <span class="token string">'Access-Control-Allow-Methods'</span> <span class="token string">'GET,POST,HEAD'</span></span><span class="token punctuation">;</span>

  <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> http://127.0.0.1:3000</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> Host  <span class="token variable">$http_host</span></span><span class="token punctuation">;</span>    
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><ul><li>上面更改头信息，还有一种，使用 <a href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html" target="_blank" rel="noopener noreferrer">rewrite<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 指令重定向URI来解决跨域问题。</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> test</span> <span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8080</span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">server</span> localhost:8081</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">server_name</span> api.xxx.com</span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span> 
    <span class="token directive"><span class="token keyword">root</span>  html</span><span class="token punctuation">;</span>                   <span class="token comment">#去请求../html文件夹里的文件</span>
    <span class="token directive"><span class="token keyword">index</span>  index.html index.htm</span><span class="token punctuation">;</span>  <span class="token comment">#首页响应地址</span>
  <span class="token punctuation">}</span>
  <span class="token comment"># 用于拦截请求，匹配任何以 /api/开头的地址，</span>
  <span class="token comment"># 匹配符合以后，停止往下搜索正则。</span>
  <span class="token directive"><span class="token keyword">location</span> ^~/api/</span><span class="token punctuation">{</span> 
    <span class="token comment"># 代表重写拦截进来的请求，并且只能对域名后边的除去传递的参数外的字符串起作用，</span>
    <span class="token comment"># 例如www.a.com/proxy/api/msg?meth=1&amp;par=2重写，只对/proxy/api/msg重写。</span>
    <span class="token comment"># rewrite后面的参数是一个简单的正则 ^/api/(.*)$，</span>
    <span class="token comment"># $1代表正则中的第一个()，$2代表第二个()的值，以此类推。</span>
    <span class="token directive"><span class="token keyword">rewrite</span> ^/api/(.*)$ /<span class="token variable">$1</span> break</span><span class="token punctuation">;</span>
    
    <span class="token comment"># 把请求代理到其他主机 </span>
    <span class="token comment"># 其中 http://www.b.com/ 写法和 http://www.b.com写法的区别如下</span>
    <span class="token comment"># 如果你的请求地址是他 http://server/html/test.jsp</span>
    <span class="token comment"># 配置一： http://www.b.com/ 后面有“/” </span>
    <span class="token comment">#         将反向代理成 http://www.b.com/html/test.jsp 访问</span>
    <span class="token comment"># 配置一： http://www.b.com 后面没有有“/” </span>
    <span class="token comment">#         将反向代理成 http://www.b.com/test.jsp 访问</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> http://test</span><span class="token punctuation">;</span>

    <span class="token comment"># 如果 proxy_pass  URL 是 http://a.xx.com/platform/ 这种情况</span>
    <span class="token comment"># proxy_cookie_path应该设置成 /platform/ / (注意两个斜杠之间有空格)。</span>
    <span class="token directive"><span class="token keyword">proxy_cookie_path</span> /platfrom/ /</span><span class="token punctuation">;</span>

    <span class="token comment"># http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass_header</span>
    <span class="token comment"># 设置 Cookie 头通过</span>
    <span class="token directive"><span class="token keyword">proxy_pass_header</span> Set-Cookie</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_10-2-跳转到带www的域上面"><a href="#_10-2-跳转到带www的域上面" class="header-anchor">#</a> 10.2 跳转到带www的域上面</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token comment"># 配置正常的带www的域名</span>
    <span class="token directive"><span class="token keyword">server_name</span> www.wangchujiang.com</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">root</span> /home/www/wabg/download</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ /index.html =404</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token comment"># 这个要放到下面，</span>
    <span class="token comment"># 将不带www的 wangchujiang.com 永久性重定向到  https://www.wangchujiang.com</span>
    <span class="token directive"><span class="token keyword">server_name</span> wangchujiang.com</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">rewrite</span> ^(.*) https://www.wangchujiang.com<span class="token variable">$1</span> permanent</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_10-3-代理转发"><a href="#_10-3-代理转发" class="header-anchor">#</a> 10.3 代理转发</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> server-api</span><span class="token punctuation">{</span>
    <span class="token comment"># api 代理服务地址</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:3110</span><span class="token punctuation">;</span>    
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">upstream</span> server-resource</span><span class="token punctuation">{</span>
    <span class="token comment"># 静态资源 代理服务地址</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:3120</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">3111</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  localhost</span><span class="token punctuation">;</span>      <span class="token comment"># 这里指定域名</span>
    <span class="token directive"><span class="token keyword">root</span> /home/www/server-statics</span><span class="token punctuation">;</span>
    <span class="token comment"># 匹配 api 路由的反向代理到API服务</span>
    <span class="token directive"><span class="token keyword">location</span> ^~/api/</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">rewrite</span> ^/(.*)$ /<span class="token variable">$1</span> break</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://server-api</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment"># 假设这里验证码也在API服务中</span>
    <span class="token directive"><span class="token keyword">location</span> ^~/captcha</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">rewrite</span> ^/(.*)$ /<span class="token variable">$1</span> break</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://server-api</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment"># 假设你的图片资源全部在另外一个服务上面</span>
    <span class="token directive"><span class="token keyword">location</span> ^~/img/</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">rewrite</span> ^/(.*)$ /<span class="token variable">$1</span> break</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://server-resource</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment"># 路由在前端，后端没有真实路由，在路由不存在的 404状态的页面返回 /index.html</span>
    <span class="token comment"># 这个方式使用场景，你在写React或者Vue项目的时候，没有真实路由</span>
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ /index.html =404</span><span class="token punctuation">;</span>
        <span class="token comment">#                               ^ 空格很重要</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_10-4-代理转发连接替换"><a href="#_10-4-代理转发连接替换" class="header-anchor">#</a> 10.4 代理转发连接替换</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> ^~/api/upload</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">rewrite</span> ^/(.*)$ /wfs/v1/upload break</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> http://wfs-api</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_10-5-ssl配置"><a href="#_10-5-ssl配置" class="header-anchor">#</a> 10.5 ssl配置</h3> <ul><li><p>超文本传输安全协议（缩写：HTTPS，英语：Hypertext Transfer Protocol Secure）是超文本传输协议和SSL/TLS的组合，用以提供加密通讯及对网络服务器身份的鉴定。HTTPS连接经常被用于万维网上的交易支付和企业信息系统中敏感信息的传输。HTTPS不应与在RFC 2660中定义的安全超文本传输协议（S-HTTP）相混。HTTPS 目前已经是所有注重隐私和安全的网站的首选，随着技术的不断发展，HTTPS 网站已不再是大型网站的专利，所有普通的个人站长和博客均可以自己动手搭建一个安全的加密的网站。</p></li> <li><p>创建<code>SSL</code>证书，如果你购买的证书，就可以直接下载</p></li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">mkdir</span> /etc/nginx/ssl
<span class="token comment"># 创建了有效期100年，加密强度为RSA2048的SSL密钥key和X509证书文件。</span>
<span class="token function">sudo</span> openssl req -x509 -nodes -days <span class="token number">36500</span> -newkey rsa:2048 -keyout /etc/nginx/ssl/nginx.key -out /etc/nginx/ssl/nginx.crt
<span class="token comment"># 上面命令，会有下面需要填写内容</span>
Country Name <span class="token punctuation">(</span><span class="token number">2</span> letter code<span class="token punctuation">)</span> <span class="token punctuation">[</span>AU<span class="token punctuation">]</span>:US
State or Province Name <span class="token punctuation">(</span>full name<span class="token punctuation">)</span> <span class="token punctuation">[</span>Some-State<span class="token punctuation">]</span>:New York
Locality Name <span class="token punctuation">(</span>eg, city<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>:New York City
Organization Name <span class="token punctuation">(</span>eg, company<span class="token punctuation">)</span> <span class="token punctuation">[</span>Internet Widgits Pty Ltd<span class="token punctuation">]</span>:Bouncy Castles, Inc.
Organizational Unit Name <span class="token punctuation">(</span>eg, section<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>:Ministry of Water Slides
Common Name <span class="token punctuation">(</span>e.g. server FQDN or YOUR name<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>:your_domain.com
Email Address <span class="token punctuation">[</span><span class="token punctuation">]</span>:admin@your_domain.com
</code></pre></div><ul><li>创建自签证书</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>首先，创建证书和私钥的目录
<span class="token comment"># mkdir -p /etc/nginx/cert</span>
<span class="token comment"># cd /etc/nginx/cert</span>
创建服务器私钥，命令会让你输入一个口令：
<span class="token comment"># openssl genrsa -des3 -out nginx.key 2048</span>
创建签名请求的证书（CSR）：
<span class="token comment"># openssl req -new -key nginx.key -out nginx.csr</span>
在加载SSL支持的Nginx并使用上述私钥时除去必须的口令：
<span class="token comment"># cp nginx.key nginx.key.org</span>
<span class="token comment"># openssl rsa -in nginx.key.org -out nginx.key</span>
最后标记证书使用上述私钥和CSR：
<span class="token comment"># openssl x509 -req -days 365 -in nginx.csr -signkey nginx.key -out nginx.crt</span>
</code></pre></div><p>查看目前nginx编译选项</p> <div class="language- extra-class"><pre class="language-text"><code>sbin/nginx -V
</code></pre></div><p>输出下面内容</p> <div class="language- extra-class"><pre class="language-text"><code>nginx version: nginx/1.7.8
built by gcc 4.4.7 20120313 (Red Hat 4.4.7-4) (GCC)
TLS SNI support enabled
configure arguments: --prefix=/usr/local/nginx-1.7.8 --with-http_ssl_module --with-http_spdy_module --with-http_stub_status_module --with-pcre
</code></pre></div><p>如果依赖的模块不存在，可以进入安装目录，输入下面命令重新编译安装。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./configure --prefix<span class="token operator">=</span>/usr/local/nginx --with-http_stub_status_module --with-http_ssl_module
</code></pre></div><p>运行完成之后还需要<code>make</code> (不用make install)</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 备份nginx的二进制文件</span>
<span class="token function">cp</span> -rf /usr/local/nginx/sbin/nginx　 /usr/local/nginx/sbin/nginx.bak
<span class="token comment"># 覆盖nginx的二进制文件</span>
<span class="token function">cp</span> -rf objs/nginx   /usr/local/nginx/sbin/
</code></pre></div><p>HTTPS server</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">443</span> ssl</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  localhost</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">ssl_certificate</span> /etc/nginx/ssl/nginx.crt</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_certificate_key</span> /etc/nginx/ssl/nginx.key</span><span class="token punctuation">;</span>
    <span class="token comment"># 禁止在header中出现服务器版本，防止黑客利用版本漏洞攻击</span>
    <span class="token directive"><span class="token keyword">server_tokens</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
    <span class="token comment"># 设置ssl/tls会话缓存的类型和大小。如果设置了这个参数一般是shared，buildin可能会参数内存碎片，默认是none，和off差不多，停用缓存。如shared:SSL:10m表示我所有的nginx工作进程共享ssl会话缓存，官网介绍说1M可以存放约4000个sessions。 </span>
    <span class="token directive"><span class="token keyword">ssl_session_cache</span>    shared:SSL:1m</span><span class="token punctuation">;</span> 

    <span class="token comment"># 客户端可以重用会话缓存中ssl参数的过期时间，内网系统默认5分钟太短了，可以设成30m即30分钟甚至4h。</span>
    <span class="token directive"><span class="token keyword">ssl_session_timeout</span>  <span class="token number">5m</span></span><span class="token punctuation">;</span> 

    <span class="token comment"># 选择加密套件，不同的浏览器所支持的套件（和顺序）可能会不同。</span>
    <span class="token comment"># 这里指定的是OpenSSL库能够识别的写法，你可以通过 openssl -v cipher 'RC4:HIGH:!aNULL:!MD5'（后面是你所指定的套件加密算法） 来看所支持算法。</span>
    <span class="token directive"><span class="token keyword">ssl_ciphers</span>  HIGH:!aNULL:!MD5</span><span class="token punctuation">;</span>

    <span class="token comment"># 设置协商加密算法时，优先使用我们服务端的加密套件，而不是客户端浏览器的加密套件。</span>
    <span class="token directive"><span class="token keyword">ssl_prefer_server_ciphers</span>  <span class="token boolean">on</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">root</span>   html</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">index</span>  index.html index.htm</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_10-6-强制将http重定向到https"><a href="#_10-6-强制将http重定向到https" class="header-anchor">#</a> 10.6 强制将http重定向到https</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  example.com</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">rewrite</span> ^ https://<span class="token variable">$http_host</span><span class="token variable">$request_uri?</span> permanent</span><span class="token punctuation">;</span>    <span class="token comment"># 强制将http重定向到https</span>
    <span class="token comment"># 在错误页面和“服务器”响应头字段中启用或禁用发射nginx版本。 防止黑客利用版本漏洞攻击</span>
    <span class="token directive"><span class="token keyword">server_tokens</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_10-7-两个虚拟主机"><a href="#_10-7-两个虚拟主机" class="header-anchor">#</a> 10.7 两个虚拟主机</h3> <ul><li>纯静态<code>-html</code> 支持</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">listen</span>          <span class="token number">80</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">server_name</span>     www.domain1.com</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">access_log</span>      logs/domain1.access.log main</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
            <span class="token directive"><span class="token keyword">index</span> index.html</span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">root</span>  /var/www/domain1.com/htdocs</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">listen</span>          <span class="token number">80</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">server_name</span>     www.domain2.com</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">access_log</span>      logs/domain2.access.log main</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
            <span class="token directive"><span class="token keyword">index</span> index.html</span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">root</span>  /var/www/domain2.com/htdocs</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_10-8-虚拟主机标准配置"><a href="#_10-8-虚拟主机标准配置" class="header-anchor">#</a> 10.8 虚拟主机标准配置</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span>          <span class="token number">80</span> default</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>     _ *</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">access_log</span>      logs/default.access.log main</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
       <span class="token directive"><span class="token keyword">index</span> index.html</span><span class="token punctuation">;</span>
       <span class="token directive"><span class="token keyword">root</span>  /var/www/default/htdocs</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_10-9-防盗链"><a href="#_10-9-防盗链" class="header-anchor">#</a> 10.9 防盗链</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> ~* \.(gif|jpg|png|swf|flv)$</span> <span class="token punctuation">{</span>
   <span class="token directive"><span class="token keyword">root</span> html
   valid_referers none blocked *.nginxcn.com</span><span class="token punctuation">;</span>
   <span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$invalid_referer</span>)</span> <span class="token punctuation">{</span>
     rewrite ^/ www.nginx.cn
     <span class="token comment">#return 404;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_10-10虚拟目录配置"><a href="#_10-10虚拟目录配置" class="header-anchor">#</a> 10.10虚拟目录配置</h3> <p>alias指定的目录是准确的，root是指定目录的上级目录，并且该上级目录要含有location指定名称的同名目录。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> /img/</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">alias</span> /var/www/image/</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment"># 访问/img/目录里面的文件时，ningx会自动去/var/www/image/目录找文件</span>
<span class="token directive"><span class="token keyword">location</span> /img/</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">root</span> /var/www/image</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment"># 访问/img/目录下的文件时，nginx会去/var/www/image/img/目录下找文件。]</span>
</code></pre></div><h3 id="_10-11-防盗图配置"><a href="#_10-11-防盗图配置" class="header-anchor">#</a> 10.11 防盗图配置</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> ~ \/public\/(css|js|img)\/.*\.(js|css|gif|jpg|jpeg|png|bmp|swf)</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">valid_referers</span> none blocked *.jslite.io</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$invalid_referer</span>)</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">rewrite</span> ^/  http://wangchujiang.com/piratesp.png</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_10-12-屏蔽-git等文件"><a href="#_10-12-屏蔽-git等文件" class="header-anchor">#</a> 10.12 屏蔽.git等文件</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> ~ (.git|.gitattributes|.gitignore|.svn)</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">deny</span> all</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="域名路径加不加需要都能正常访问"><a href="#域名路径加不加需要都能正常访问" class="header-anchor">#</a> 域名路径加不加需要都能正常访问</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>http://wangchujiang.com/api/index.php?a<span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span><span class="token assign-left variable">name</span><span class="token operator">=</span>wcj
                                  ^ 有后缀

http://wangchujiang.com/api/index?a<span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span><span class="token assign-left variable">name</span><span class="token operator">=</span>wcj
                                 ^ 没有后缀
</code></pre></div><ul><li><code>nginx rewrite</code>规则如下：</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">rewrite</span> ^/(.*)/$ /index.php?/<span class="token variable">$1</span> permanent</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">if</span> (!-d <span class="token variable">$request_filename</span>)</span><span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">set</span> <span class="token variable">$rule_1</span> 1<span class="token variable">$rule_1</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">if</span> (!-f <span class="token variable">$request_filename</span>)</span><span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">set</span> <span class="token variable">$rule_1</span> 2<span class="token variable">$rule_1</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$rule_1</span> = <span class="token string">"21"</span>)</span><span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">rewrite</span> ^/ /index.php last</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="十一、错误问题"><a href="#十一、错误问题" class="header-anchor">#</a> 十一、错误问题</h2> <div class="language-bash extra-class"><pre class="language-bash"><code>The plain HTTP request was sent to HTTPS port
</code></pre></div><ul><li>解决办法，<code>fastcgi_param HTTPS $https if_not_empty</code> 添加这条规则，</li></ul> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">443</span> ssl</span><span class="token punctuation">;</span> <span class="token comment"># 注意这条规则</span>
    <span class="token directive"><span class="token keyword">server_name</span>  my.domain.com</span><span class="token punctuation">;</span>
    
    <span class="token directive"><span class="token keyword">fastcgi_param</span> HTTPS <span class="token variable">$https</span> if_not_empty</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">fastcgi_param</span> HTTPS <span class="token boolean">on</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">ssl_certificate</span> /etc/ssl/certs/your.pem</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_certificate_key</span> /etc/ssl/private/your.key</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token comment"># Your config here...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="十二、精品文章参考"><a href="#十二、精品文章参考" class="header-anchor">#</a> 十二、精品文章参考</h2> <ul><li><a href="https://my.oschina.net/u/3341316/blog/877206" target="_blank" rel="noopener noreferrer">负载均衡原理的解析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://blog.githuber.cn/posts/73" target="_blank" rel="noopener noreferrer">Nginx泛域名解析，实现多个二级域名 <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.nginx.com/blog/inside-nginx-how-we-designed-for-performance-scale/" target="_blank" rel="noopener noreferrer">深入 NGINX: 我们如何设计性能和扩展<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.nginx.com/blog/inside-nginx-how-we-designed-for-performance-scale/" target="_blank" rel="noopener noreferrer">Inside NGINX: How We Designed for Performance &amp; Scale<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://tengine.taobao.org/book/index.html" target="_blank" rel="noopener noreferrer">Nginx开发从入门到精通<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://os.51cto.com/art/201703/535326.htm#topx" target="_blank" rel="noopener noreferrer">Nginx的优化与防盗链<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://segmentfault.com/a/1190000009769143" target="_blank" rel="noopener noreferrer">实战开发一个Nginx扩展 (Nginx Module)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://my.oschina.net/xshuai/blog/917097" target="_blank" rel="noopener noreferrer">Nginx+Keepalived(双机热备)搭建高可用负载均衡环境(HA)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://www.huxd.org/articles/2017/07/24/1500890692329.html" target="_blank" rel="noopener noreferrer">Nginx 平滑升级<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://mp.weixin.qq.com/s?__biz=MzIxNzg5ODE0OA==&amp;mid=2247483708&amp;idx=1&amp;sn=90b0b1dccd9c337922a0588245277666&amp;chksm=97f38cf7a08405e1928e0b46d923d630e529e7db8ac7ca2a91310a075986f8bcb2cee5b4953d#rd" target="_blank" rel="noopener noreferrer">Nginx最新模块—ngx_http_mirror_module分析可以做版本发布前的预先验证，进行流量放大后的压测等等<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <!----> <div class="readMore-wrapper"><span class="readMore">阅读全文</span></div>
                    </div>
                            <p>这是一个信息提示框。</p>
                        </div>

                        <div class="note warning">
                            <div class="note-title"><i class="fas fa-exclamation-triangle"></i> 注意</div>
                            <p>这是一个警告提示框。</p>
                        </div>

                        <div class="note success">
                            <div class="note-title"><i class="fas fa-check-circle"></i> 成功</div>
                            <p>这是一个成功提示框。</p>
                        </div>

                        <h2>代码示例</h2>
                        <pre><code class="language-javascript">// 示例代码
function example() {
    console.log('Hello, FrontendHub!');
}
</code></pre>
                    </div>

                    <!-- 文章底部导航 -->
                    <nav class="article-nav">
                        <a href="#" class="prev-article">
                            <i class="fas fa-chevron-left"></i>
                            <span>上一篇</span>
                        </a>
                        <a href="#" class="next-article">
                            <span>下一篇</span>
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </nav>
                </article>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4><i class="fas fa-code"></i> FrontendHub</h4>
                    <p>专注于前端技术学习与面试准备</p>
                </div>
                <div class="footer-section">
                    <h4>快速链接</h4>
                    <ul>
                        <li><a href="../../index.html">首页</a></li>
                        <li><a href="../index.html#courses">课程体系</a></li>
                        <li><a href="../index.html#resources">学习资源</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 FrontendHub. 用于个人学习使用.</p>
            </div>
        </div>
    </footer>

    <!-- 返回顶部按钮 -->
    <button class="back-to-top" id="backToTop">
        <i class="fas fa-arrow-up"></i>
    </button>

    <script src="../../js/main.js"></script>
    <script src="../../js/content.js"></script>
</body>
</html>

