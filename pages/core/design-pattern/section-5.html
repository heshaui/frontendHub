<!-- Section: # 五、其他模式 -->
<div class="section-content" data-section-id="五、其他模式">
<h2 id="五、其他模式"><a href="#五、其他模式" class="header-anchor">#</a> 五、其他模式</h2>
<h3 id="mvc、mvp、mvvm"><a href="#mvc、mvp、mvvm" class="header-anchor">#</a> MVC、MVP、MVVM</h3>
<blockquote><p>在下文中，如果某些内容和你看的某本书或者某个帖子上的不一样，不要惊慌，多看几本书，多打开几个帖子，你会发现每个都不一样，所以模式具体是如何表现并不重要，重要的是，了解这三个模式主要的目的和思想是什么：</p></blockquote>
<ul><li><code>MVC</code> 模式： 从大锅烩时代进化，引入了分层的概念，但是层与层之间耦合明显，维护起来不容易；</li> <li><code>MVP</code> 模式： 在 MVC 基础上进一步解耦，视图层和模型层完全隔离，交互只能通过管理层来进行，问题是更新视图需要管理层手动来进行；</li> <li><code>MVVM</code> 模式： 引入双向绑定机制，帮助实现一些更新视图层和模型层的工作，让开发者可以更专注于业务逻辑，相比于之前的模式，可以使用更少的代码量完成更复杂的交互；
MVC、MVP、MVVM 模式是我们经常遇到的概念，其中 MVVM 是最常用到的，在实际项目中往往没有严格按照模式的定义来设计的系统，开发中也不一定要纠结自己用的到底是哪个模式，合适的才是最好的。</li></ul>
<p><strong>1. MVC （Model View Controller）</strong></p>
<blockquote><p><code>MVC</code> 模式将程序分为三个部分：模型（<code>Model</code>）、视图（<code>View</code>）、控制器（<code>Controller</code>）。</p></blockquote>
<ul><li><code>Model</code> 模型层： 业务数据的处理和存储，数据更新后更新；</li> <li><code>View</code> 视图层： 人机交互接口，一般为展示给用户的界面；</li> <li><code>Controller</code> 控制器层 ： 负责连接 <code>Model</code> 层和 <code>View</code> 层，接受并处理 <code>View</code> 层触发的事件，并在 <code>Model</code> 层的数据状态变动时更新 <code>View</code> 层；</li> <li><code>MVC</code> 模式的目的是通过引入 <code>Controller</code> 层来将 <code>Model</code> 层和 <code>View</code> 层分离，分层的引入是原来大锅烩方式的改进，使得系统在可维护性和可读性上有了进步。</li> <li><code>MVC</code> 模式提出已经有四十余年，<code>MVC</code> 模式在各个书、各个教程、<code>WIKI</code> 的解释有各种版本，甚至 <code>MVC</code> 模式在不同系统中的具体表现也不同，这里只介绍典型 <code>MVC</code> 模式的思路。</li></ul>
<blockquote><p>典型思路是 <code>View</code> 层通过事件通知到 <code>Controller</code> 层，<code>Controller</code> 层经过对事件的处理完成相关业务逻辑，要求 <code>Model</code> 层改变数据状态，<code>Model</code> 层再将新数据更新到 <code>View</code>层。示意图如下：</p></blockquote>
<p><img alt="" src="https://s.poetries.top/gitee/2020/07/115.png"></p>
<blockquote><p>在实际操作时，用户可以直接对 <code>View</code> 层的 <code>UI</code> 进行操作，以通过事件通知 <code>Controller</code> 层，经过处理后修改 <code>Model</code> 层的数据，<code>Model</code> 层使用最新数据更新 <code>View</code>。示意图如下：</p></blockquote>
<p><img alt="" src="https://s.poetries.top/gitee/2020/07/116.png"></p>
<p>用户也可以直接触发 <code>Controller</code> 去更新 <code>Model</code> 层状态，再更新 View 层：</p>
<p><img alt="" src="https://s.poetries.top/gitee/2020/07/117.png"></p>
<blockquote><p>某些场景下，<code>View</code> 层直接采用观察者/发布订阅模式监听 <code>Model</code> 层的变化，这样 <code>View</code>层和 <code>Model</code> 层相互持有、相互操作，导致紧密耦合，在可维护性上有待提升。由此，<code>MVP</code> 模式应运而生 。</p></blockquote>
<p><strong>2. MVP （Model View Presenter）</strong></p>
<blockquote><p><code>MVP</code> 模式将程序分为三个部分：模型（<code>Model</code>）、视图（<code>View</code>）、管理层（<code>Presenter</code>）。</p></blockquote>
<ul><li><code>Model</code> 模型层： 只负责存储数据，与 <code>View</code> 呈现无关，也与 <code>UI</code> 处理逻辑无关，发生更新也不用主动通知 <code>View</code>；</li> <li><code>View</code> 视图层： 人机交互接口，一般为展示给用户的界面；</li> <li><code>Presenter</code> 管理层 ： 负责连接 <code>Model</code> 层和 <code>View</code> 层，处理 <code>View</code> 层的事件，负责获取数据并将获取的数据经过处理后更新 <code>View</code>；</li> <li><code>MVC</code> 模式的 <code>View</code> 层和 <code>Model</code> 层存在耦合，为了解决这个问题，<code>MVP</code> 模式将 <code>View</code> 层和 <code>Model</code> 层解耦，之间的交互只能通过 <code>Presenter</code> 层，实际上，<code>MVP</code> 模式的目的就是将 <code>View</code> 层和 Model 层完全解耦，使得对 <code>View</code> 层的修改不会影响到 <code>Model</code> 层，而对 <code>Model</code> 层的数据改动也不会影响到<code>View</code> 层。</li></ul>
<blockquote><p>典型流程是 <code>View</code> 层触发的事件传递到 <code>Presenter</code> 层中处理，<code>Presenter</code> 层去操作 <code>Model</code> 层，并且将数据返回给 <code>View</code>层，这个过程中，<code>View</code> 层和 <code>Model</code> 层没有直接联系。而 <code>View</code> 层不部署业务逻辑，除了展示数据和触发事件之外，其它时间都在等着 <code>Presenter</code> 层来更新自己，被称为「被动视图」。</p></blockquote>
<p>示意图如下：</p>
<p><img alt="" src="https://s.poetries.top/gitee/2020/07/118.png"></p>
<blockquote><p>在实际操作时，用户可以直接对 <code>View</code> 层的 <code>UI</code> 进行操作，<code>View</code> 层通知 <code>Presenter</code> 层，<code>Presenter</code> 层操作 <code>Model</code> 层的数据，<code>Presenter</code> 层获取到数据之后更新 <code>View</code>。示意图如下：</p></blockquote>
<p><img alt="" src="https://s.poetries.top/gitee/2020/07/119.png"></p>
<ul><li>由于 <code>Presenter</code> 层负责了数据获取、数据处理、交互逻辑、<code>UI</code> 效果等等功能，所以 <code>Presenter</code> 层就变得强大起来，相应的，<code>Model</code> 层只负责数据存储，而 <code>View</code> 层只负责视图，<code>Model</code> 和 <code>View</code> 层的责任纯粹而单一，如果我们需要添加或修改功能模块，只需要修改 <code>Presenter</code> 层就够了。由于 <code>Presenter</code> 层需要调用 <code>View</code> 层的方法更新视图，<code>Presenter</code> 层直接持有 <code>View</code> 层导致了 <code>Presenter</code> 对 <code>View</code> 的依赖。</li></ul>
<blockquote><p>正如上所说，更新视图需要 <code>Presenter</code> 层直接持有 <code>View</code> 层，并通过调用 <code>View</code> 层中的方法来实现，还是需要一系列复杂操作，有没有什么机制自动去更新视图而不用我们手动去更新呢，所以，<code>MVVM</code> 模式应运而生。</p></blockquote>
<p><strong>3. MVVM （Model View ViewModel）</strong></p>
<blockquote><p><code>MVVM</code> 模式将程序分为三个部分：模型（<code>Model</code>）、视图（<code>View</code>）、视图模型（<code>View-Model</code>）。</p></blockquote>
<p>和 <code>MVP</code> 模式类似，<code>Model</code> 层和 <code>View</code> 层也被隔离开，彻底解耦，<code>ViewModel</code> 层相当于 <code>Presenter</code> 层，负责绑定 <code>Model</code> 层和 <code>View</code> 层，相比于 <code>MVP</code> 增加了双向绑定机制。</p>
<p>结构图如下：</p>
<p><img alt="" src="https://s.poetries.top/gitee/2020/07/120.png"></p>
<blockquote><p><code>MVVM</code> 模式的特征是 <code>ViewModel</code> 层和 <code>View</code> 层采用双向绑定的形式（Binding），<code>View</code> 层的变动，将自动反映在 <code>ViewModel</code> 层，反之亦然。</p></blockquote>
<ul><li>但是双向绑定给调试和错误定位带来困难，<code>View</code> 层的异常可能是 <code>View</code> 的代码有问题，也有可能是 <code>Model</code> 层的问题。数据绑定使得一个位置的 <code>Bug</code> 被传递到别的位置，要定位原始出问题的地方就变得不那么容易了。</li> <li>对简单<code>UI</code> 来说，实现 <code>MVVM</code> 模式的开销是不必要的，而对于大型应用来说，引入 MVVM 模式则会节约大量手动更新视图的复杂过程，是否使用，还是看使用场景。</li> <li><code>Vue</code> 的双向绑定机制应该算是比较有 <code>MVVM</code> 模式的影子，但 <code>Vue</code> 文档 里面是这么描述：</li></ul>
<p><img alt="" src="https://s.poetries.top/gitee/2020/07/121.png"></p>
<blockquote><p>这是为什么呢，因为 <code>MVVM</code> 模式要求 <code>Model</code> 层和 <code>View</code> 层完全解耦，但是由于 <code>Vue</code> 还提供了 <code>ref</code> 这样的 <code>API</code>，使得 <code>Model</code> 也可以直接持有 <code>View</code>：</p></blockquote>
<p><img alt="" src="https://s.poetries.top/gitee/2020/07/122.png"></p>
<p>但是大多数帖子都说直接称呼 <code>Vue</code> 为 <code>MVVM</code> 框架，可见这些模式的划分也不是那么严格。</p>
<h3 id="模块模式"><a href="#模块模式" class="header-anchor">#</a> 模块模式</h3>
<blockquote><p>模块是任何健壮的应用程序体系结构不可或缺的一部分，特点是有助于保持应用项目的代码单元既能清晰地分离又有组织，下面我们来看看各种不同的模块模式解决方案。</p></blockquote>
<p><strong>1. 模块模式</strong> <strong>1.1 命名空间模式</strong></p>
<blockquote><p>命名空间模式是一个简单的模拟模块的方法，即创建一个全局对象，然后将变量和方法添加到这个全局对象中，这个全局对象是作为命名空间一样的角色。</p></blockquote>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token constant">MYNS</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token constant">MYNS</span><span class="token punctuation">.</span>param1 <span class="token operator">=</span> <span class="token string">'hello'</span>
<span class="token constant">MYNS</span><span class="token punctuation">.</span>param2 <span class="token operator">=</span> <span class="token string">'world'</span>
<span class="token constant">MYNS</span><span class="token punctuation">.</span>param3 <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">prop</span><span class="token operator">:</span> <span class="token string">'name'</span> <span class="token punctuation">}</span>

<span class="token constant">MYNS</span><span class="token punctuation">.</span><span class="token function-variable function">method1</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>这种方式可以隐藏系统中的变量冲突，但是也有一些缺点，比如：</p>
<ul><li>命名空间如果比较复杂，调用可能就会变成 MYNS.param.prop.data... 长长一溜，使用不便且增加代码量；</li> <li>变量嵌套关系越多，属性解析的性能消耗就越多；</li> <li>安全性不佳，所有的成员都可以被访问到；</li></ul>
<p><strong>1.2 模块模式</strong></p>
<blockquote><p>除了命名空间模式，也可以使用闭包的特性来模拟实现私有成员的功能来提升安全性，这里可以通过 IIFE 快速创建一个闭包，将要隐藏的变量和方法放在闭包中，这就是模块模式。</p></blockquote>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> myModule <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> privateProp <span class="token operator">=</span> <span class="token string">''</span>      	<span class="token comment">// 私有变量</span>
    <span class="token keyword">var</span> <span class="token function-variable function">privateMethod</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 私有方法</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>privateProp<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">publicProp</span><span class="token operator">:</span> <span class="token string">'foo'</span><span class="token punctuation">,</span>              <span class="token comment">// 公有变量</span>
        <span class="token function-variable function">publicMethod</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">prop</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 共有方法</span>
            privateProp <span class="token operator">=</span> prop
            <span class="token function">privateMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

myModule<span class="token punctuation">.</span><span class="token function">publicMethod</span><span class="token punctuation">(</span><span class="token string">'new prop'</span><span class="token punctuation">)</span> <span class="token comment">// 输出：new prop</span>
myModule<span class="token punctuation">.</span>privateProp              <span class="token comment">// Uncaught TypeError: myModule.privateMethod is not a function</span>
myModule<span class="token punctuation">.</span>privateProp              <span class="token comment">// undefined</span>
</code></pre></div>
<ul><li>这里的私有变量和私有方法，在闭包外面无法访问到，称为私有成员。而闭包返回的方法因为作用域的原因可以访问到私有成员，所以称为特权方法。</li> <li>值得一提的是，在模块模式创建时，可以将参数传递到闭包中，以更自由地创建模块，也可以方便地将全局变量传入模块中，导入全局变量有助于加速即时函数中的全局符号解析的速度，因为导入的变量成了该函数的局部变量。</li></ul>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> myModule <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">opt<span class="token punctuation">,</span> global</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
</code></pre></div>
<p><strong>1.3 揭示模块模式</strong></p>
<blockquote><p>在上面的模块模式例子上稍加改动，可以得到揭示模块模式（Reveal Module Pattern），又叫暴露模块模式，在私有域中定义我们所有的函数和变量，并且返回一个匿名对象，把想要暴露出来的私有成员赋值给这个对象，使这些私有成员公开化。</p></blockquote>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> myModule <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> privateProp <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">var</span> <span class="token function-variable function">printProp</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>privateProp<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">function</span> <span class="token function">setProp</span><span class="token punctuation">(</span><span class="token parameter">prop</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        privateProp <span class="token operator">=</span> prop
        <span class="token function">printProp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">print</span><span class="token operator">:</span> printProp<span class="token punctuation">,</span>
        <span class="token literal-property property">set</span><span class="token operator">:</span> setProp
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

myModule<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'new prop'</span><span class="token punctuation">)</span>          <span class="token comment">// 输出：new prop</span>
myModule<span class="token punctuation">.</span><span class="token function">setProp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token comment">// Uncaught TypeError: myModule.setProp is not a function</span>
myModule<span class="token punctuation">.</span>privateProp              <span class="token comment">// undefined</span>
</code></pre></div>
<p>揭示模块暴露出来的私有成员可以在被重命名后公开访问，也增强了可读性。</p>
<p><strong>2. ES6 module</strong></p>
<blockquote><p>继社区提出的 <code>CommonJS</code> 和 <code>AMD</code> 之类的方案之后，从 <code>ES6</code> 开始，J<code>avaScript</code> 就支持原生模块（<code>module</code>）了，下面我们一起来简单看一下 <code>ES6</code> 的 <code>module</code></p></blockquote>
<p><code>ES6</code> 的 <code>module</code> 功能主要由两个命令组成 <code>export</code>、<code>import</code>，<code>export</code> 用于规定模块对外暴露的接口，<code>import</code> 用于输入其他模块提供的接口，简单来说就是一个作为输出、一个作为输入。</p>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1.js</span>

<span class="token comment">// 写法一</span>
<span class="token keyword">export</span> <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token string">'a'</span> 

<span class="token comment">// 写法二</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token string">'b'</span>        
<span class="token keyword">export</span> <span class="token punctuation">{</span> b <span class="token punctuation">}</span>

<span class="token comment">// 写法三</span>
<span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token string">'c'</span>        
<span class="token keyword">export</span> <span class="token punctuation">{</span> c <span class="token keyword">as</span> e <span class="token punctuation">}</span>
</code></pre></div>
<p>引入时：</p>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 2.js</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> a <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./1.js'</span>       <span class="token comment">// 写法一</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> b <span class="token keyword">as</span> f <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./1.js'</span>  <span class="token comment">// 写法二</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> e <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./1.js'</span>       <span class="token comment">// 写法二</span>
</code></pre></div>
<blockquote><p>从前面的例子可以看出，使用 <code>import</code> 时，用户需要知道所要加载的变量名或函数名，否则无法加载，<code>export default</code> 方式提供了模块默认输出的形式，给用户提供了方便：</p></blockquote>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 3.js</span>

<span class="token comment">// 写法一</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 写法二</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> foo

<span class="token comment">// 写法三</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>add <span class="token keyword">as</span> <span class="token keyword">default</span><span class="token punctuation">}</span>

<span class="token comment">// 写法四</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token number">42</span>      
</code></pre></div>
<p>引入时：</p>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 4.js</span>

<span class="token keyword">import</span> bar <span class="token keyword">from</span> <span class="token string">'./3.js'</span>                   <span class="token comment">// 写法一</span>
<span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    
<span class="token comment">// 输出：foo</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">default</span> <span class="token keyword">as</span> bar <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./3.js'</span>    <span class="token comment">// 写法二</span>
<span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    
<span class="token comment">// 输出：foo</span>
</code></pre></div>
<blockquote><p>值得一提的是 <code>export</code>、<code>import</code> 都必须写在模块顶层，如果处于块级作用域内，就会报错，因为处于条件代码块之中，就没法做静态优化了，违背了 <code>ES6</code> 模块的设计初衷。</p></blockquote>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token string">'bar'</span>    <span class="token comment">// SyntaxError</span>
<span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div>
<h3 id="链模式"><a href="#链模式" class="header-anchor">#</a> 链模式</h3>
<blockquote><p>通常情况下，通过对构造函数使用 <code>new</code> 会返回一个绑定到 <code>this</code> 上的新实例，所以我们可以在 <code>new</code> 出来的对象上直接用 . 访问其属性和方法。如果在普通函数中也返回当前实例，那么我们就可以使用 . 在单行代码中一次性连续调用多个方法，就好像它们被链接在一起一样，这就是链式调用，又称链模式。</p></blockquote>
<blockquote><p>之前建造者模式、组合模式等文章已经用到了链模式，日常使用的 jQuery、Promise 等也使用了链模式，我们对使用形式已经很熟悉了，下面一起来看看链模式的原理。</p></blockquote>
<p><strong>1. 什么是链模式</strong> <strong>1.1 链模式的实现</strong></p>
<p>在 jQuery 时代，下面这样的用法我们很熟悉了：</p>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 使用链模式</span>
<span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'active'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token string">'100px'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'color'</span><span class="token punctuation">,</span> <span class="token string">'red'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ... </span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div>
<blockquote><p>这就是很典型的链模式，对 jQuery 选择器选择的元素从上到下依次进行一系列操作，如果不使用链模式，则代码如下：</p></blockquote>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 不使用链模式</span>
<span class="token keyword">var</span> divEls <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span>
divEls<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
divEls<span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'active'</span><span class="token punctuation">)</span>
divEls<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token string">'100px'</span><span class="token punctuation">)</span>
divEls<span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'color'</span><span class="token punctuation">,</span> <span class="token string">'red'</span><span class="token punctuation">)</span>
divEls<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ... </span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div>
<ul><li>可以看到不使用链模式，代码量多了，代码结构也复杂了不少。链模式是 jQuery 的一个重要特性，也是 jQuery 深受大家喜爱，并且经久不衰的原因之一。</li> <li>链模式和一般的函数调用的区别在于：链模式一般会在调用完方法之后返回一个对象，有时则直接返回 this ，因此又可以继续调用这个对象上的其他方法，这样可以对同一个对象连续执行多个方法。</li></ul>
<p>比如这里我们可以自己实现一个链模式：</p>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/* 四边形 */</span>
<span class="token keyword">var</span> rectangle <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>  <span class="token comment">// 长</span>
    <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>   <span class="token comment">// 宽</span>
    <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>   <span class="token comment">// 颜色</span>
    
    <span class="token function-variable function">getSize</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">length: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, width: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, color: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> <span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    
    <span class="token comment">/* 设置长度 */</span>
    <span class="token function-variable function">setLength</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">length</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> length
        <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    
    <span class="token comment">/* 设置宽度 */</span>
    <span class="token function-variable function">setWidth</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">width</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> width
        <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    
    <span class="token comment">/* 设置颜色 */</span>
    <span class="token function-variable function">setColor</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">color</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token operator">=</span> color
        <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> rect <span class="token operator">=</span> rectangle
  <span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span><span class="token string">'100px'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setWidth</span><span class="token punctuation">(</span><span class="token string">'80px'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span><span class="token string">'blue'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 输出：length: 100px, width: 80px, color: blue</span>
</code></pre></div>
<blockquote><p>由于所有对象都会继承其原型对象的属性和方法，所以我们可以让原型方法都返回该原型的实例对象，这样就可以对那些方法进行链式调用了：</p></blockquote>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/* 四边形 */</span>
<span class="token keyword">function</span> <span class="token function">Rectangle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token keyword">null</span>   <span class="token comment">// 长</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token keyword">null</span>    <span class="token comment">// 宽</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token keyword">null</span>    <span class="token comment">// 颜色</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 设置长度 */</span>
<span class="token class-name">Rectangle</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">setLength</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">length</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> length
    <span class="token keyword">return</span> <span class="token keyword">this</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 设置宽度 */</span>
<span class="token class-name">Rectangle</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">setWidth</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">width</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> width
    <span class="token keyword">return</span> <span class="token keyword">this</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 设置颜色 */</span>
<span class="token class-name">Rectangle</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">setColor</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">color</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token operator">=</span> color
    <span class="token keyword">return</span> <span class="token keyword">this</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> rect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rectangle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span><span class="token string">'100px'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setWidth</span><span class="token punctuation">(</span><span class="token string">'80px'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span><span class="token string">'blue'</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rect<span class="token punctuation">)</span>

<span class="token comment">// 输出：{length: "100px", width: "80px", color: "blue"}</span>
使用 Class 语法改造一下：

<span class="token comment">/* 四边形 */</span>
<span class="token keyword">class</span> <span class="token class-name">Rectangle</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token keyword">null</span>   <span class="token comment">// 长</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token keyword">null</span>    <span class="token comment">// 宽</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token keyword">null</span>    <span class="token comment">// 颜色</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/* 设置长度 */</span>
    <span class="token function">setLength</span><span class="token punctuation">(</span><span class="token parameter">length</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> length
        <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/* 设置宽度 */</span>
    <span class="token function">setWidth</span><span class="token punctuation">(</span><span class="token parameter">width</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> width
        <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/* 设置颜色 */</span>
    <span class="token function">setColor</span><span class="token punctuation">(</span><span class="token parameter">color</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token operator">=</span> color
        <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> rect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rectangle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span><span class="token string">'100px'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setWidth</span><span class="token punctuation">(</span><span class="token string">'80px'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span><span class="token string">'blue'</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rect<span class="token punctuation">)</span>

<span class="token comment">// 输出：{length: "100px", width: "80px", color: "blue"}</span>
</code></pre></div>
<p><strong>1.2 链模式不一定必须返回 this</strong></p>
<blockquote><p>不一定在方法中 <code>return this</code>，也可以返回其他对象，这样后面的方法可以对这个新对象进行其他操作。比如在 <code>Promise</code> 的实现中，每次 <code>then</code> 方法返回的就不是 <code>this</code>，而是一个新的 <code>Promise</code>，只不过其外观一样，所以我们可以不断 <code>then</code> 下去。后面的每一个 <code>then</code> 都不是从最初的 <code>Promise</code>实例点出来的，而是从前一个 <code>then</code> 返回的新的 <code>Promise</code> 实例点出来的。</p></blockquote>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> prom1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Promise 1 resolved'</span><span class="token punctuation">)</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> prom2 <span class="token operator">=</span> prom1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Then method'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>prom1 <span class="token operator">===</span> prom2<span class="token punctuation">)</span>

<span class="token comment">// 输出： false</span>
</code></pre></div>
<blockquote><p>jQuery 中有一个有意思的方法 <code>end()</code> ，是将匹配的元素还原为之前一次的状态，此时返回的也不是 <code>this</code>，然后可以在返回的之前一次匹配的状态后继续进行链模式：</p></blockquote>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// html: &lt;p&gt;&lt;span&gt;Hello&lt;/span&gt;,how are you?&lt;/p&gt;</span>

<span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"p"</span><span class="token punctuation">)</span>            <span class="token comment">// 选择所有 p 标签</span>
  <span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">"span"</span><span class="token punctuation">)</span>         <span class="token comment">// 选择了 p 标签下的 span 标签</span>
  <span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'color'</span><span class="token punctuation">,</span> <span class="token string">'red'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token comment">// 返回之前匹配的 p 标签</span>
  <span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'color'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">)</span>
</code></pre></div>
<blockquote><p>事实上，某些原生的方法就可以使用链模式，以数组操作为例，比如我们想查看一个数组中奇数的平方和：</p></blockquote>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>
  <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">num</span> <span class="token operator">=&gt;</span> num <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">num</span> <span class="token operator">=&gt;</span> num <span class="token operator">*</span> num<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pre<span class="token punctuation">,</span> curr</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> pre <span class="token operator">+</span> curr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment">// 输出 35</span>
</code></pre></div>
<blockquote><p>那么这里为什么可以使用链模式呢，是因为 <code>filter</code>、<code>map</code>、r<code>educe</code> 这些数组方法返回的仍然是数组，因此可以继续在后面调用数组的方法。</p></blockquote>
<p>注意，并不是所有数组方法都返回数组，比如 <code>push</code> 的时候返回的是新数组的 <code>length</code> 属性。</p>
<p><strong>2. 实战使用链模式</strong></p>
<blockquote><p>有时候 JavaScript 原生提供的方法不太好用，比如我们希望创建下面这样一个 DOM 树结构：</p></blockquote>
<div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>data-list<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>data-item<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>li-item 1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>data-item<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>li-item 2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>data-item<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>li-item 3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre></div>
<blockquote><p>如果使用原生方法，由于 <code>setAttribute</code> 等方法并没有返回原对象，而 <code>appendChild</code> 方法返回的却是，我们需要：</p></blockquote>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> ul <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">)</span>
ul<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'data-list'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> li1 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> li2 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> li3 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span>

li1<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'data-item'</span><span class="token punctuation">)</span>
li2<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'data-item'</span><span class="token punctuation">)</span>
li3<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'data-item'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> text1 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span><span class="token string">'li-item 1'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> text2 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span><span class="token string">'li-item 2'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> text3 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span><span class="token string">'li-item 3'</span><span class="token punctuation">)</span>

li1<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>text1<span class="token punctuation">)</span>
li2<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>text2<span class="token punctuation">)</span>
li3<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>text3<span class="token punctuation">)</span>

ul<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>li1<span class="token punctuation">)</span>
ul<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>li2<span class="token punctuation">)</span>
ul<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>li3<span class="token punctuation">)</span>
</code></pre></div>
<p>太不直观了，步骤零散且可维护性差。</p>
<p>这里我们可以彻底使用链模式来改造一下原生方法：</p>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">createElement</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">tag</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> tag <span class="token operator">===</span> <span class="token string">'text'</span>
      <span class="token operator">?</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span>
      <span class="token operator">:</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token class-name">HTMLElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_setAttribute</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span>
<span class="token punctuation">}</span>

<span class="token class-name">HTMLElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_appendChild</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">child</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span>
<span class="token punctuation">}</span>

<span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">_setAttribute</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'data-list'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">_appendChild</span><span class="token punctuation">(</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">_setAttribute</span><span class="token punctuation">(</span><span class="token string">'class'</span><span class="token punctuation">,</span> <span class="token string">'data-item'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">_appendChild</span><span class="token punctuation">(</span><span class="token string">'text'</span><span class="token punctuation">,</span> <span class="token string">'li-item 1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">_appendChild</span><span class="token punctuation">(</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">_setAttribute</span><span class="token punctuation">(</span><span class="token string">'class'</span><span class="token punctuation">,</span> <span class="token string">'data-item'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">_appendChild</span><span class="token punctuation">(</span><span class="token string">'text'</span><span class="token punctuation">,</span> <span class="token string">'li-item 2'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">_appendChild</span><span class="token punctuation">(</span>
    <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">_setAttribute</span><span class="token punctuation">(</span><span class="token string">'class'</span><span class="token punctuation">,</span> <span class="token string">'data-item'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">_appendChild</span><span class="token punctuation">(</span><span class="token string">'text'</span><span class="token punctuation">,</span> <span class="token string">'li-item 3'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div>
<blockquote><p>这样就比较彻底地使用了链模式来生成 <code>DOM</code> 结构树了，你可能感觉有点奇怪，但是如果你使用过 <code>vue-cli3</code>，那么你可能对这个配置方式很熟悉。</p></blockquote>
<p><strong>3. 源码中的链模式</strong> <strong>3.1 jQuery 中的链模式</strong> <strong>1. jQuery 构造函数</strong></p>
<p>jQuery 方法看似复杂，可以简写如下：</p>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">jQuery</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">selector<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// jQuery 方法返回的是 jQuery.fn.init 所 new 出来的对象</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">jQuery<span class="token punctuation">.</span>fn<span class="token punctuation">.</span>init</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> context<span class="token punctuation">,</span> rootjQuery<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

jQuery<span class="token punctuation">.</span>fn <span class="token operator">=</span> jQuery<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">constructor</span><span class="token operator">:</span> jQuery<span class="token punctuation">,</span>
    <span class="token comment">// jQuery 对象的构造函数</span>
    <span class="token function-variable function">init</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">selector<span class="token punctuation">,</span> context<span class="token punctuation">,</span> rootjQuery</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ... 一顿匹配操作，返回一个拼装好的伪数组的自身实例</span>
        <span class="token comment">// 是 jQuery.fn.init 的实例，也就是我们常用的 jQuery 对象</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">selector</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token function-variable function">eq</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">end</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">map</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">last</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">first</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// ... 其他方法</span>
<span class="token punctuation">}</span>

<span class="token comment">// jQuery.fn.init 的实例都拥有 jQuery.fn 相应的方法</span>
jQuery<span class="token punctuation">.</span>fn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>prototype <span class="token operator">=</span> jQuery<span class="token punctuation">.</span>fn
<span class="token comment">// 此处源码位于 src/core.js</span>
</code></pre></div>
<blockquote><p><code>return new jQuery.fn.init(...)</code> 这句看似复杂，其实也就是下面的这个 <code>init</code> 方法，这个方法最后返回的是我们常用的 <code>jQuery</code> 对象，下面还有一句 <code>jQuery.fn.init.prototype = jQuery.fn</code>，因此最上面的 <code>jQuery</code> 方法返回的 <code>new</code> 出来的 <code>jQuery.fn.init</code> 实例将继承 <code>j</code>Query.fn` 上的方法：</p></blockquote>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"&lt;p/&gt;"</span><span class="token punctuation">)</span>
$<span class="token punctuation">.</span>fn <span class="token operator">===</span> p<span class="token punctuation">.</span>__proto__   <span class="token comment">// true</span>
</code></pre></div>
<blockquote><p>因此返回出来的实例也将继承 <code>eq</code>、<code>end</code>、<code>map</code>、<code>last</code> 等 <code>jQuery.fn</code> 上的方法。</p></blockquote>
<p><strong>2. jQuery 实例方法</strong></p>
<blockquote><p>下面我们一起看看，<code>show</code>、<code>hide</code>、<code>toggle</code> 这些方法是如何实现链模式的呢 ：</p></blockquote>
<div class="language-js extra-class"><pre class="language-js"><code>jQuery<span class="token punctuation">.</span>fn<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">show</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> elem
        
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ... </span>
            elem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span>elem<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">===</span> <span class="token string">'none'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                elem<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'block'</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">hide</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">toggle</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div>
<blockquote><p>这里首先使用了一个方法 <code>jQuery.fn.extend()</code>，简单看一下这个方法做啥的：</p></blockquote>
<div class="language-js extra-class"><pre class="language-js"><code>jQuery<span class="token punctuation">.</span>extend <span class="token operator">=</span> jQuery<span class="token punctuation">.</span>fn<span class="token punctuation">.</span><span class="token function-variable function">extend</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ... 一系列啰啰嗦嗦的判断</span>
  
    <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> options<span class="token punctuation">[</span> name <span class="token punctuation">]</span>  <span class="token comment">// 此处 this === jQuery.fn</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 此处源码位于 src/core.js</span>
</code></pre></div>
<ul><li>这个方法就是把传参的对象的值赋值给 <code>jQuery.fn</code>，因为这时候这个方法是通过上下文对象 <code>jQuery.fn.extend()</code> 方式来调用，属于隐式绑定。（对 <code>this</code> 绑定规则的同学参看本专栏第 2 篇文章）</li> <li>以 <code>show</code> 方法为例，此时这个方法被赋到 <code>jQuery.fn</code> 对象上，而通过上文我们知道，<code>jQuery.fn.init.prototype = jQuery.fn</code>，而 <code>jQuery.fn.init</code> 这个方法是作为构造函数被 <code>jQuery</code> 函数 <code>new</code> 出来并返回，因此 show 方法此时可以被 <code>jQuery.fn.init</code> 实例访问到，也就可以被 <code>$('selector')</code> 访问到，因此此时我们已经可以： <code>$('p').show()</code> 了。</li> <li>那么我们再回头来看看 <code>show</code> 方法的实现，<code>show</code> 方法将匹配的元素的 <code>display</code> 置为 <code>block</code>之后返回了 <code>this</code>。注意了，此时的 <code>this</code> 也是隐式绑定，而且是通过 <code>$('p')</code> 点出来的，因此返回的值就是 <code>$('p')</code> 的引用。</li> <li>经过以上步骤，我们知道 <code>show</code> 方法返回的仍然是 <code>$('p')</code> 的引用，我们可以继续在之后点出来其他 <code>jQuery.fn</code> 对象上的方法，<code>css</code>、<code>hide</code>、<code>toggle</code>、<code>addClass</code>on<code>等等方法同理，至此，</code>jQuery` 的链模式就形成了。</li></ul>
<p><strong>3.2 Underscore 中的链模式</strong></p>
<ul><li>如果你用过 <code>Underscore</code>，那么你可能知道 <code>Underscore</code> 提供的一个链模式实现 <code>_.chain</code>。通过这个方法，可以方便地使用 <code>Underscore</code> 提供的一些方法链模式地对数据进行处理。另外，<code>Lodash</code> 的 <code>chain</code> 实现和 <code>Underscore</code> 的基本一样，可以自行去 <code>Lodash</code> 的 GitHub 仓库阅读。</li> <li>比如这里我们需要对一个用户对象数组进行一系列操作，首先按年龄排序，去掉年龄为奇数的人，再将这些用户的名字列成数组：</li></ul>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> users <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token string-property property">'name'</span><span class="token operator">:</span> <span class="token string">'barney'</span><span class="token punctuation">,</span> <span class="token string-property property">'age'</span><span class="token operator">:</span> <span class="token number">26</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token string-property property">'name'</span><span class="token operator">:</span> <span class="token string">'fred'</span><span class="token punctuation">,</span> <span class="token string-property property">'age'</span><span class="token operator">:</span> <span class="token number">21</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token string-property property">'name'</span><span class="token operator">:</span> <span class="token string">'pebbles'</span><span class="token punctuation">,</span> <span class="token string-property property">'age'</span><span class="token operator">:</span> <span class="token number">28</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token string-property property">'name'</span><span class="token operator">:</span> <span class="token string">'negolas'</span><span class="token punctuation">,</span> <span class="token string-property property">'age'</span><span class="token operator">:</span> <span class="token number">23</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

_<span class="token punctuation">.</span><span class="token function">chain</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">sortBy</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=&gt;</span> user<span class="token punctuation">.</span>age <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=&gt;</span> user<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 输出： ["barney", "pebbles"]</span>
</code></pre></div>
<blockquote><p>经过 <code>_.chain</code> 方法处理后，就可以使用 <code>Underscore</code> 提供的其他方法对这个数据进行操作，下面一起来看看源码是如何实现链模式。</p></blockquote>
<blockquote><p>首先是 <code>_.chain</code> 方法：</p></blockquote>
<div class="language-js extra-class"><pre class="language-js"><code>_<span class="token punctuation">.</span><span class="token function-variable function">chain</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> instance <span class="token operator">=</span> <span class="token function">_</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>  <span class="token comment">// 获得一个经 underscore 包裹后的实例</span>
    instance<span class="token punctuation">.</span>_chain <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">// 标记是否使用链式操作</span>
    <span class="token keyword">return</span> instance
<span class="token punctuation">}</span>
</code></pre></div>
<blockquote><p>此处源码位于 <code>underscore.js#L1615-L1619</code></p></blockquote>
<blockquote><p>这里通过<code>_(obj)</code> 的方式把数据进行了包装，并返回了一个对象，结构如下：</p></blockquote>
<div class="language- extra-class"><pre class="language-text"><code>{
    _chain: true,
    _wrapped: [...],
    __proto__:  ...
}
</code></pre></div>
<blockquote><p>返回的对象的隐式原型可以访问到 <code>Undersocre</code> 提供的很多方法，如下图：</p></blockquote>
<p><img alt="" src="https://s.poetries.top/gitee/2020/07/125.png"></p>
<blockquote><p>这个 <code>chain</code> 方法的作用就是创建一个包裹了 <code>obj</code> 的 <code>Underscore</code> 实例对象，并标记该实例是使用链模式，最后返回这个包装好的链式化实例（叫链式化是因为可以继续调用 <code>underscore</code> 上的方法）。</p></blockquote>
<p>我们一起看看 <code>sort</code> 方法是如何实现的：</p>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">chainResult</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> instance<span class="token punctuation">.</span>_chain <span class="token operator">?</span> <span class="token function">_</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> obj<span class="token punctuation">;</span>  <span class="token comment">// 这里 _chain 为 true</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

_<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'pop'</span><span class="token punctuation">,</span> <span class="token string">'push'</span><span class="token punctuation">,</span> <span class="token string">'reverse'</span><span class="token punctuation">,</span> <span class="token string">'shift'</span><span class="token punctuation">,</span> <span class="token string">'sort'</span><span class="token punctuation">,</span> <span class="token string">'splice'</span><span class="token punctuation">,</span> <span class="token string">'unshift'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> method <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">_</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_wrapped<span class="token punctuation">;</span>
        <span class="token function">method</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 执行方法</span>
      
        <span class="token keyword">return</span> <span class="token function">chainResult</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<blockquote><p>此处源码位于 <code>underscore.js#L1649-L1657</code></p></blockquote>
<ul><li><code>sort</code> 方法执行之后，把结果重新放在 <code>_wrapped</code> 里，并执行 <code>chainResult</code> 方法，这个方法里由于 <code>_chain</code> 之前已经置为 <code>true</code>，因此会继续对结果调用 <code>chain()</code> 方法，包装成链式化实例并返回。</li> <li>最后的这个<code>_.value</code> 方法比较简单，就是返回链式化实例的<code>_wrapped</code> 值：</li></ul>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">_</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">value</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_wrapped<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div>
<blockquote><p>此处源码位于 <code>underscore.js#L1668-L1670</code></p></blockquote>
<blockquote><p>总结一下，只要一开始调用了 <code>chain</code> 方法， <code>_chain</code> 这个标志位就会被置为 <code>true</code>，在类似的方法中，返回的值都用 <code>chainResult</code> 包裹一遍，并判断这个 <code>_chain</code> 这个标志位，为 <code>true</code> 则返回链式化实例，供给下一次方法调用，由此形成了链式化调用</p></blockquote>
<h3 id="中间件"><a href="#中间件" class="header-anchor">#</a> 中间件</h3>
<blockquote><p>中间件 （Middleware），又称中介层，是提供系统软件和应用软件之间连接的软件，以便于软件各部件之间的沟通，特别是应用软件对于系统软件的集中的逻辑。中间件在企业架构中表示各种软件套件，有助于抽象底层机制，比如操作系统 API、网络通信、内存管理等，开发者只需要关注应用中的业务模块。</p></blockquote>
<p>从更广义的角度来看，中间件也可以定义为链接底层服务和应用的软件层。后文我们主要使用 Node.js 里最近很热门的框架 Koa2 里的中间件概念为例，并且自己实现一个中间件来加深理解。</p>
<p><strong>1. 什么是中间件</strong></p>
<ul><li>在 <code>Express</code>、<code>Koa2</code> 中，中间件代表一系列以管道形式被连接起来，以处理 <code>HTTP</code> 请求和响应的函数。换句话说，中间件其实就是一个函数，一个执行特定逻辑的函数。前端中类似的概念还有拦截器、<code>Vue</code> 中的过滤器、<code>vue-router</code> 中的路由守卫等。</li> <li>工作原理就是进入具体业务之前，先对其进行预处理（在这一点上有点类似于装饰器模式），或者在进行业务之后，对其进行后处理。</li></ul>
<p>示意图如下：</p>
<p><img alt="" src="https://s.poetries.top/gitee/2020/07/126.png"></p>
<blockquote><p>当接受到一个请求，对这个请求的处理过程可以看作是一个串联的管道，比如对于每个请求，我们都想插入一些相同的逻辑比如权限验证、数据过滤、日志统计、参数验证、异常处理等功能。对于开发者而言，自然不希望对于每个请求都特殊处理，因此引入中间件来简化和隔离这些基础设施与业务逻辑之间的细节，让开发者能够关注在业务的开发上，以达到提升开发效率的目的。</p></blockquote>
<p><strong>2. Koa 里的中间件</strong> <strong>2.1 Koa2 里的中间件使用</strong></p>
<p><code>Koa2</code> 中的中间件形式为：</p>
<div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">middleware</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
    <span class="token comment">// ... 前处理</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment">// 下一个中间件</span>
    <span class="token comment">// ... 后处理</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div>
<ul><li>其中第一个参数 <code>context</code> 作为上下文封装了 <code>request</code> 和 <code>response</code> 信息，我们可以通过它来访问 <code>request</code> 和 <code>response</code>；<code>next</code> 是下一个中间件，当一个中间件处理完毕，调用 next() 就可以执行下一个中间件，下一个中间件处理完- 再使用 <code>next()</code>，从而实现中间件的管道化，对消息的依次处理。</li></ul>
<blockquote><p>一般中间件模式都约定有个 <code>use</code> 方法来注册中间件，<code>Koa2</code> 也是如此。千言万语不及一行代码，这里写一个简单的中间件：</p></blockquote>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>      <span class="token comment">// 没错，这就是中间件</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in 中间件1'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">10001</span><span class="token punctuation">)</span>

<span class="token comment">// 输出： in 中间件1</span>
</code></pre></div>
<p><strong>Koa2 中的中间件有多种类型：</strong></p>
<ul><li>应用级中间件；</li> <li>路由级中间件；</li> <li>错误处理中间件；</li> <li>第三方中间件；</li></ul>
<blockquote><p>除了使用第三方中间件比如 <code>koa-router</code>、<code>koa-bodyparser</code>、<code>koa-static</code>、<code>koa-logger</code> 等提供一些通用的路由、序列化、反序列化、日志记录等功能外，我们还可以编写自己的应用级中间件，来完成业务相关的逻辑。</p></blockquote>
<p><strong>通过引入各种功能各异的中间件，可以完成很多业务相关的功能：</strong></p>
<ul><li><code>equest</code> 和 <code>response</code> 的解析和处理；</li> <li>生成访问日志；</li> <li>管理 <code>session</code>、<code>cookie</code> 等；</li> <li>提供网络安全防护；</li></ul>
<p><strong>2.2 洋葱模型</strong></p>
<p>在使用多个中间件时，引用一张著名的洋葱模型图：</p>
<p><img alt="" src="https://s.poetries.top/gitee/2020/07/127.png"></p>
<p>正如上面的洋葱图所示，请求在进入业务逻辑时，会依次经过一系列中间件，对数据进行有序处理，业务逻辑之后，又像栈的先入后出一样，倒序经过之前的中间件。洋葱模型允许当应用执行完主要逻辑之后进行一些后处理，再将响应返回给用户。</p>
<p>使用如下：</p>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 中间件1</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in 中间件1'</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'out 中间件1'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 中间件2</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in 中间件2'</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'out 中间件2'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// response</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'Hello World'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">10001</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'app started at port http://localhost:10001'</span><span class="token punctuation">)</span>

<span class="token comment">// 输出：  in  中间件1</span>
<span class="token comment">// 输出：  in  中间件2</span>
<span class="token comment">// 输出：  out 中间件2</span>
<span class="token comment">// 输出：  out 中间件1</span>
</code></pre></div>
<blockquote><p>我们可以引入 <code>setTimeout</code> 来模拟异步请求的过程：</p></blockquote>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 中间件1</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in 中间件1'</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'out 中间件1'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 中间件2</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in 中间件2'</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          ctx<span class="token punctuation">.</span>zjj_start2 <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> duration <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> ctx<span class="token punctuation">.</span>zjj_start2
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'out 中间件2 耗时：'</span> <span class="token operator">+</span> duration <span class="token operator">+</span> <span class="token string">'ms'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 中间件3</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in 中间件3'</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          ctx<span class="token punctuation">.</span>zjj_start3 <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> duration <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> ctx<span class="token punctuation">.</span>zjj_start3
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'out 中间件3 耗时：'</span> <span class="token operator">+</span> duration <span class="token operator">+</span> <span class="token string">'ms'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// response</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">' ... 业务逻辑处理过程 ... '</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">10001</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'app started at port http://localhost:10001'</span><span class="token punctuation">)</span>
</code></pre></div>
<blockquote><p>在使用多个中间件时，特别是存在异步的场景，一般要 <code>await</code> 来调用 <code>next</code> 来保证在异步场景中，中间件仍按照洋葱模型的顺序来执行，因此别忘了 <code>next</code> 也要通过 <code>await</code> 调用。</p></blockquote>
</div>