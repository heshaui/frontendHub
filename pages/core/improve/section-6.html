<!-- Section: # 六、Vue -->
<div class="section-content" data-section-id="六、vue">
<h2 id="六、vue"><a href="#六、vue" class="header-anchor">#</a> 六、Vue</h2>
<h3 id="_1-vue-响应式原理"><a href="#_1-vue-响应式原理" class="header-anchor">#</a> 1 Vue 响应式原理</h3>
<blockquote><p>Vue 的响应式原理是核心是通过 ES5 的保护对象的 <code>Object.defindeProperty</code> 中的访问器属性中的 get 和 set 方法，data 中声明的属性都被添加了访问器属性，当读取 data 中的数据时自动调用 get 方法，当修改 data 中的数据时，自动调用 set 方法，检测到数据的变化，会通知观察者 Wacher，观察者 Wacher自动触发重新render 当前组件（子组件不会重新渲染）,生成新的虚拟 DOM 树，Vue 框架会遍历并对比新虚拟 DOM 树和旧虚拟 DOM 树中每个节点的差别，并记录下来，最后，加载操作，将所有记录的不同点，局部修改到真实 DOM树上。</p></blockquote>
<p><img alt="" src="https://s.poetries.top/gitee/2021/01/15.png"></p>
<ul><li>虚拟DOM (Virtaul DOM): 用 js 对象模拟的，保存当前视图内所有 DOM 节点对象基本描述属性和节点间关系的树结构。用 js 对象，描述每个节点，及其父子关系，形成虚拟 DOM 对象树结构。</li> <li>因为只要在 <code>data</code> 中声明的基本数据类型的数据，基本不存在数据不响应问题，所以重点介绍数组和对象在<code>vue</code>中的数据响应问题，vue可以检测对象属性的修改，但无法监听数组的所有变动及对象的新增和删除，只能使用数组变异方法及<code>$set</code>方法。</li></ul>
<p><img alt="" src="https://s.poetries.top/gitee/2021/01/16.png"></p>
<blockquote><p>可以看到，<code>arrayMethods</code> 首先继承了 <code>Array</code>，然后对数组中所有能改变数组自身的方法，如 <code>push</code>、<code>pop</code> 等这些方法进行重写。重写后的方法会先执行它们本身原有的逻辑，并对能增加数组长度的 3 个方法 <code>push</code>、<code>unshift</code>、<code>splice</code> 方法做了判断，获取到插入的值，然后把新添加的值变成一个响应式对象，并且再调用 <code>ob.dep.notify()</code> 手动触发依赖通知，这就很好地解释了用 <code>vm.items.splice</code>(<code>newLength</code>) 方法可以检测到变化</p></blockquote>
<blockquote><p>总结：Vue 采用数据劫持结合发布—订阅模式的方法，通过 <code>Object.defineProperty()</code> 来劫持各个属性的 setter，getter，在数据变动时发布消息给订阅者，触发相应的监听回调。</p></blockquote>
<p><img alt="" src="https://s.poetries.top/gitee/20190922/vue.jpeg"></p>
<ul><li><code>Observer</code> 遍历数据对象，给所有属性加上 <code>setter</code> 和 <code>getter</code>，监听数据的变化</li> <li><code>compile</code> 解析模板指令，将模板中的变量替换成数据，然后初始化渲染页面视图，并将每个指令对应的节点绑定更新函数，添加监听数据的订阅者，一旦数据有变动，收到通知，更新视图</li></ul>
<blockquote><p><code>Watcher</code> 订阅者是 <code>Observer</code> 和 <code>Compile</code> 之间通信的桥梁，主要做的事情</p></blockquote>
<ul><li>在自身实例化时往属性订阅器 (<code>dep</code>) 里面添加自己</li> <li>待属性变动 <code>dep.notice()</code> 通知时，调用自身的 <code>update()</code> 方法，并触发 <code>Compile</code> 中绑定的回调</li></ul>
<p><strong>Object.defineProperty()</strong>，那么它的用法是什么，以及优缺点是什么呢？</p>
<ul><li>可以检测对象中数据发生的修改</li> <li>对于复杂的对象，层级很深的话，是不友好的，需要经行深度监听，这样子就需要递归到底，这也是它的缺点。</li> <li>对于一个对象中，如果你新增加属性，删除属性，**Object.defineProperty()**是不能观测到的，那么应该如何解决呢？可以通过<code>Vue.set()</code>和<code>Vue.delete()</code>来实现。</li></ul>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 模拟 Vue 中的 data 选项 </span>
<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'hello'</span>
<span class="token punctuation">}</span>
<span class="token comment">// 模拟 Vue 的实例 </span>
<span class="token keyword">let</span> vm <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token comment">// 数据劫持:当访问或者设置 vm 中的成员的时候，做一些干预操作</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'msg'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// 可枚举(可遍历)</span>
  <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token comment">// 可配置(可以使用 delete 删除，可以通过 defineProperty 重新定义) </span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token comment">// 当获取值的时候执行 </span>
  <span class="token function">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get: '</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>msg<span class="token punctuation">)</span>
    <span class="token keyword">return</span> data<span class="token punctuation">.</span>msg 
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 当设置值的时候执行 </span>
  <span class="token function">set</span> <span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'set: '</span><span class="token punctuation">,</span> newValue<span class="token punctuation">)</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">===</span> data<span class="token punctuation">.</span>msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    data<span class="token punctuation">.</span>msg <span class="token operator">=</span> newValue
    <span class="token comment">// 数据更改，更新 DOM 的值 </span>
    document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> data<span class="token punctuation">.</span>msg
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 测试</span>
vm<span class="token punctuation">.</span>msg <span class="token operator">=</span> <span class="token string">'Hello World'</span> 
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>msg<span class="token punctuation">)</span>
</code></pre></div>
<p><strong>Vue3.x响应式数据原理</strong></p>
<blockquote><p><code>Vue3.x</code>改用<code>Proxy</code>替代<code>Object.defineProperty</code>。因为<code>Proxy</code>可以直接监听<code>对象和数组</code>的变化，并且有多达13种拦截方法。并且作为新标准将受到浏览器厂商重点持续的性能优化。</p></blockquote>
<p><code>Proxy</code>只会代理对象的第一层，那么<code>Vue3</code>又是怎样处理这个问题的呢？</p>
<blockquote><p>判断当前<code>Reflect.get的</code>返回值是否为<code>Object</code>，如果是则再通过<code>reactive</code>方法做代理， 这样就实现了深度观测。</p></blockquote>
<p><strong>监测数组的时候可能触发多次get/set，那么如何防止触发多次呢？</strong></p>
<blockquote><p>我们可以判断<code>key</code>是否为当前被代理对象<code>target</code>自身属性，也可以判断旧值与新值是否相等，只有满足以上两个条件之一时，才有可能执行<code>trigger</code></p></blockquote>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 模拟 Vue 中的 data 选项 </span>
<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'hello'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">0</span> 
<span class="token punctuation">}</span>
<span class="token comment">// 模拟 Vue 实例</span>
<span class="token keyword">let</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// 当访问 vm 的成员会执行</span>
  <span class="token function">get</span> <span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get, key: '</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 当设置 vm 的成员会执行</span>
  <span class="token function">set</span> <span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'set, key: '</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newValue
    document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 测试</span>
vm<span class="token punctuation">.</span>msg <span class="token operator">=</span> <span class="token string">'Hello World'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>msg<span class="token punctuation">)</span>
</code></pre></div>
<p><strong>Proxy 相比于 defineProperty 的优势</strong></p>
<ul><li>数组变化也能监听到</li> <li>不需要深度遍历监听</li></ul>
<blockquote><p><code>Proxy</code> 是 <code>ES6</code> 中新增的功能，可以用来自定义对象中的操作</p></blockquote>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// `target` 代表需要添加代理的对象</span>
<span class="token comment">// `handler` 用来自定义对象中的操作</span>
<span class="token comment">// 可以很方便的使用 Proxy 来实现一个数据绑定和监听</span>

<span class="token keyword">let</span> <span class="token function-variable function">onWatch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> setBind<span class="token punctuation">,</span> getLogger</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">getLogger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">)</span>
      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setBind</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token keyword">let</span> value
<span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token function">onWatch</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  value <span class="token operator">=</span> v
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> property</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Get '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>property<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>target<span class="token punctuation">[</span>property<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">// bind `value` to `2`</span>
p<span class="token punctuation">.</span>a <span class="token comment">// -&gt; Get 'a' = 2</span>

</code></pre></div>
<p><strong>总结</strong></p>
<p><img alt="" src="https://s.poetries.top/images/20210408091523.png"></p>
<ul><li>Vue
<ul><li>记录传入的选项，设置 <code>$data/$el</code></li> <li>把 <code>data</code> 的成员注入到 <code>Vue</code> 实例</li> <li>负责调用 <code>Observer</code> 实现数据响应式处理(数据劫持)</li> <li>负责调用 <code>Compiler</code> 编译指令/插值表达式等</li></ul></li> <li><code>Observer</code> <ul><li>数据劫持
<ul><li>负责把 <code>data</code> 中的成员转换成 <code>getter/setter</code></li> <li>负责把多层属性转换成 <code>getter/setter</code></li> <li>如果给属性赋值为新对象，把新对象的成员设置为 <code>getter/setter</code></li></ul></li> <li>添加 <code>Dep</code> 和 <code>Watcher</code> 的依赖关系</li> <li>数据变化发送通知</li></ul></li> <li><code>Compiler</code> <ul><li>负责编译模板，解析指令/插值表达式</li> <li>负责页面的首次渲染过程</li> <li>当数据变化后重新渲染</li></ul></li> <li><code>Dep</code> <ul><li>收集依赖，添加订阅者(<code>watcher</code>)</li> <li>通知所有订阅者</li></ul></li> <li><code>Watcher</code> <ul><li>自身实例化的时候往<code>dep</code>对象中添加自己</li> <li>当数据变化<code>dep</code>通知所有的 <code>Watcher</code> 实例更新视图</li></ul></li></ul>
<h3 id="_2-发布订阅模式和观察者模式"><a href="#_2-发布订阅模式和观察者模式" class="header-anchor">#</a> 2 发布订阅模式和观察者模式</h3>
<p><strong>1. 发布/订阅模式</strong></p>
<ul><li><strong>发布/订阅模式</strong> <ul><li>订阅者</li> <li>发布者</li> <li>信号中心</li></ul></li></ul>
<blockquote><p>我们假定，存在一个"信号中心"，某个任务执行完成，就向信号中心"发布"(publish)一个信 号，其他任务可以向信号中心"订阅"(subscribe)这个信号，从而知道什么时候自己可以开始执 行。这就叫做"发布/订阅模式"(publish-subscribe pattern)</p></blockquote>
<blockquote><p>Vue 的自定义事件</p></blockquote>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
vm<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span><span class="token string">'dataChange'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'dataChange'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
vm<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span><span class="token string">'dataChange'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'dataChange1'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> 
vm<span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'dataChange'</span><span class="token punctuation">)</span>
</code></pre></div>
<p>兄弟组件通信过程</p>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// eventBus.js</span>
<span class="token comment">// 事件中心</span>
<span class="token keyword">let</span> eventHub <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// ComponentA.vue</span>
<span class="token comment">// 发布者</span>
<span class="token function-variable function">addTodo</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 发布消息(事件)</span>
  eventHub<span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'add-todo'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>newTodoText <span class="token punctuation">}</span><span class="token punctuation">)</span> 
  <span class="token keyword">this</span><span class="token punctuation">.</span>newTodoText <span class="token operator">=</span> <span class="token string">''</span>
<span class="token punctuation">}</span>
<span class="token comment">// ComponentB.vue</span>
<span class="token comment">// 订阅者</span>
<span class="token function-variable function">created</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 订阅消息(事件)</span>
  eventHub<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span><span class="token string">'add-todo'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>addTodo<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div>
<blockquote><p>模拟 Vue 自定义事件的实现</p></blockquote>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">EventEmitter</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// { eventType: [ handler1, handler2 ] }</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 订阅通知</span>
  <span class="token function">$on</span><span class="token punctuation">(</span><span class="token parameter">eventType<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">[</span>eventType<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">[</span>eventType<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">[</span>eventType<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 发布通知</span>
  <span class="token function">$emit</span><span class="token punctuation">(</span><span class="token parameter">eventType</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">[</span>eventType<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">[</span>eventType<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token operator">=&gt;</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 测试</span>
<span class="token keyword">var</span> bus <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 注册事件</span>
bus<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

bus<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'click1'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 触发事件 </span>
bus<span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span>
</code></pre></div>
<p><strong>2. 观察者模式</strong></p>
<ul><li>观察者(订阅者) -- <code>Watcher</code> <ul><li><code>update()</code>:当事件发生时，具体要做的事情</li></ul></li> <li>目标(发布者) -- <code>Dep</code> <ul><li><code>subs</code> 数组:存储所有的观察者</li> <li><code>addSub()</code>:添加观察者</li> <li><code>notify()</code>:当事件发生，调用所有观察者的 <code>update()</code> 方法</li></ul></li> <li>没有事件中心</li></ul>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 目标(发布者) </span>
<span class="token comment">// Dependency</span>
<span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 存储所有的观察者</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 添加观察者</span>
  <span class="token function">addSub</span> <span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sub <span class="token operator">&amp;&amp;</span> sub<span class="token punctuation">.</span>update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 通知所有观察者</span>
  <span class="token function">notify</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">sub</span> <span class="token operator">=&gt;</span> sub<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 观察者(订阅者)</span>
<span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
  <span class="token function">update</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'update'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 测试</span>
<span class="token keyword">let</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> watcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span>watcher<span class="token punctuation">)</span> 
dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div>
<p><strong>3. 总结</strong></p>
<ul><li><strong>观察者模式</strong>是由具体目标调度，比如当事件触发，<code>Dep</code> 就会去调用观察者的方法，所以观察者模
式的订阅者与发布者之间是存在依赖的</li> <li><strong>发布/订阅模式</strong>由统一调度中心调用，因此发布者和订阅者不需要知道对方的存在</li></ul>
<p><img alt="" src="https://s.poetries.top/images/20210328214834.png"></p>
<h3 id="_3-为什么使用-virtual-dom"><a href="#_3-为什么使用-virtual-dom" class="header-anchor">#</a> 3 为什么使用 Virtual DOM</h3>
<ul><li>手动操作 <code>DOM</code> 比较麻烦，还需要考虑浏览器兼容性问题，虽然有 <code>jQuery</code> 等库简化 <code>DOM</code> 操作，但是随着项目的复杂 DOM 操作复杂提升</li> <li>为了简化 <code>DOM</code> 的复杂操作于是出现了各种 <code>MVVM</code> 框架，<code>MVVM</code> 框架解决了视图和状态的同步问题</li> <li>为了简化视图的操作我们可以使用模板引擎，但是模板引擎没有解决跟踪状态变化的问题，于是<code>Virtual DOM</code> 出现了</li> <li><code>Virtual DOM</code> 的好处是当状态改变时不需要立即更新 DOM，只需要创建一个虚拟树来描述<code>DOM</code>，<code>Virtual DOM</code> 内部将弄清楚如何有效(<code>diff</code>)的更新 <code>DOM</code></li> <li>虚拟 <code>DOM</code> 可以维护程序的状态，跟踪上一次的状态</li> <li>通过比较前后两次状态的差异更新真实 <code>DOM</code></li></ul>
<p><strong>虚拟 DOM 的作用</strong></p>
<ul><li>维护视图和状态的关系</li> <li>复杂视图情况下提升渲染性能</li> <li>除了渲染 <code>DOM</code> 以外，还可以实现 <code>SSR(Nuxt.js/Next.js)</code>、原生应用(<code>Weex/React Native</code>)、小程序(<code>mpvue/uni-app</code>)等</li></ul>
<p><img alt="img" src="https://s.poetries.top/images/20210328112610.png"></p>
<h3 id="_4-vdom-三个-part"><a href="#_4-vdom-三个-part" class="header-anchor">#</a> 4 VDOM：三个 part</h3>
<ul><li>虚拟节点类，将真实 <code>DOM</code>节点用 <code>js</code> 对象的形式进行展示，并提供 <code>render</code> 方法，将虚拟节点渲染成真实 <code>DOM</code></li> <li>节点 <code>diff</code> 比较：对虚拟节点进行 <code>js</code> 层面的计算，并将不同的操作都记录到 <code>patch</code> 对象</li> <li><code>re-render</code>：解析 <code>patch</code> 对象，进行 <code>re-render</code></li></ul>
<p><strong>补充1��VDOM 的必要性？</strong></p>
<ul><li><strong>创建真实DOM的代价高</strong>：真实的 <code>DOM</code> 节点 <code>node</code> 实现的属性很多，而 <code>vnode</code> 仅仅实现一些必要的属性，相比起来，创建一个 <code>vnode</code> 的成本比较低。</li> <li><strong>触发多次浏览器重绘及回流</strong>：使用 <code>vnode</code> ，相当于加了一个缓冲，让一次数据变动所带来的所有 <code>node</code> 变化，先在 <code>vnode</code> 中进行修改，然后 <code>diff</code> 之后对所有产生差异的节点集中一次对 <code>DOM tree</code> 进行修改，以减少浏览器的重绘及回流。</li></ul>
<p><strong>补充2：vue 为什么采用 vdom？</strong></p>
<blockquote><p>引入 <code>Virtual DOM</code> 在性能方面的考量仅仅是一方面。</p></blockquote>
<ul><li>性能受场景的影响是非常大的，不同的场景可能造成不同实现方案之间成倍的性能差距，所以依赖细粒度绑定及 <code>Virtual DOM</code> 哪个的性能更好还真不是一个容易下定论的问题。</li> <li><code>Vue</code> 之所以引入了 <code>Virtual DOM</code>，更重要的原因是为了解耦 <code>HTML</code>依赖，这带来两个非常重要的好处是：</li></ul>
<blockquote><ul><li>不再依赖 <code>HTML</code> 解析器进行模版解析，可以进行更多的 <code>AOT</code> 工作提高运行时效率：通过模版 <code>AOT</code> 编译，<code>Vue</code> 的运行时体积可以进一步压缩，运行时效率可以进一步提升；</li> <li>可以渲染到 <code>DOM</code> 以外的平台，实现 <code>SSR</code>、同构渲染这些高级特性，<code>Weex</code>等框架应用的就是这一特性。</li></ul></blockquote>
<blockquote><p>综上，<code>Virtual DOM</code> 在性能上的收益并不是最主要的，更重要的是它使得 <code>Vue</code> 具备了现代框架应有的高级特性。</p></blockquote>
<h3 id="_5-vue-和-react技术选型"><a href="#_5-vue-和-react技术选型" class="header-anchor">#</a> 5 vue 和 react技术选型</h3>
<p><strong>相同点：</strong></p>
<ol><li>数据驱动页面，提供响应式的视图组件</li> <li>都有virtual DOM,组件化的开发，通过props参数进行父子之间组件传递数据，都实现了webComponents规范</li> <li>数据流动单向，都支持服务器的渲染SSR</li> <li>都有支持native的方法，react有React native， vue有wexx</li></ol>
<p><strong>不同点：</strong></p>
<ol><li>数据绑定：Vue实现了双向的数据绑定v-mdoel，底层本质上还是单向数据流（v-model 隐藏了背后 :value 和 @input 的细节）</li> <li>数据渲染：大规模的数据渲染，react更快</li> <li>使用场景：React配合Redux架构适合大规模多人协作复杂项目，Vue适合小快的项目</li> <li>开发风格：react推荐做法jsx + inline style把html和css都写在js了</li></ol>
<blockquote><p>vue是采用webpack +vue-loader单文件组件格式，html, js, css同一个文件</p></blockquote>
<h3 id="_6-nexttick"><a href="#_6-nexttick" class="header-anchor">#</a> 6 nextTick</h3>
<blockquote><p><code>nextTick</code> 可以让我们在下次 <code>DOM</code> 更新循环结束之后执行延迟回调，用于获得更新后的 <code>DOM</code></p></blockquote>
<p><code>nextTick</code>主要使用了宏任务和微任务。根据执行环境分别尝试采用</p>
<ul><li><code>Promise</code></li> <li><code>MutationObserver</code></li> <li><code>setImmediate</code></li> <li>如果以上都不行则采用<code>setTimeout</code></li></ul>
<blockquote><p>定义了一个异步方法，多次调用<code>nextTick</code>会将方法存入队列中，通过这个异步方法清空当前队列</p></blockquote>
<h3 id="_7-生命周期"><a href="#_7-生命周期" class="header-anchor">#</a> 7 生命周期</h3>
<p><img alt="" src="https://s.poetries.top/images/20210408093135.png"></p>
<p><strong><em>init</em></strong></p>
<ul><li><code>initLifecycle/Event</code>，往vm上挂载各种属性</li> <li><code>callHook: beforeCreated</code>: 实例刚创建</li> <li><code>initInjection/initState</code>: 初始化注入和 <code>data</code> 响应性</li> <li><code>created: 创建完成，属性已经绑定， 但还未生成真实</code>dom`</li> <li>进行元素的挂载： <code>$el / vm.$mount()</code></li> <li>是否有<code>template</code>: 解析成 <code>render function</code> <ul><li><code>*.vue</code>文件: <code>vue-loader</code>会将<code>&lt;template&gt;</code>编译成<code>render function</code></li></ul></li> <li><code>beforeMount</code>: 模板编译/挂载之前</li> <li>执行<code>render function</code>，生成真实的<code>dom</code>，并替换到<code>dom tree</code>中</li> <li><code>mounted</code>: 组件已挂载</li></ul>
<p><strong>update</strong></p>
<ul><li>执行<code>diff</code>算法，比对改变是否需要触发<code>UI</code>更新</li> <li><code>flushScheduleQueue</code></li> <li><code>watcher.before</code>: 触发<code>beforeUpdate</code>钩子	- <code>watcher.run()</code>: 执行<code>watcher</code>中的 <code>notify</code>，通知所有依赖项更新UI</li> <li>触发<code>updated</code>钩子: 组件已更新</li> <li><code>actived / deactivated(keep-alive)</code>: 不销毁，缓存，组件激活与失活</li> <li><code>destroy</code> <ul><li><code>beforeDestroy</code>: 销毁开始</li> <li>销毁自身且递归销毁子组件以及事件监听
<ul><li><code>remove()</code>: 删除节点</li> <li><code>watcher.teardown()</code>: 清空依赖</li> <li><code>vm.$off()</code>: 解绑监听</li></ul></li> <li><code>destroyed</code>: 完成后触发钩子</li></ul></li></ul>
<table><thead><tr><th style="text-align:left;">Vue2</th> <th style="text-align:left;">Vue3</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>beforeCreate</code></td> <td style="text-align:left;">❌<code>setup</code>(替代)</td></tr> <tr><td style="text-align:left;"><code>created</code></td> <td style="text-align:left;">❌<code>setup</code>(替代)</td></tr> <tr><td style="text-align:left;"><code>beforeMount</code></td> <td style="text-align:left;"><code>onBeforeMount</code></td></tr> <tr><td style="text-align:left;"><code>mounted</code></td> <td style="text-align:left;"><code>onMounted</code></td></tr> <tr><td style="text-align:left;"><code>beforeUpdate</code></td> <td style="text-align:left;"><code>onBeforeUpdate</code></td></tr> <tr><td style="text-align:left;"><code>updated</code></td> <td style="text-align:left;"><code>nUpdated</code></td></tr> <tr><td style="text-align:left;"><code>beforeDestroy</code></td> <td style="text-align:left;"><code>onBeforeUnmount</code></td></tr> <tr><td style="text-align:left;"><code>destroyed</code></td> <td style="text-align:left;"><code>onUnmounted</code></td></tr> <tr><td style="text-align:left;"><code>errorCaptured</code></td> <td style="text-align:left;"><code>onErrorCaptured</code></td></tr> <tr><td style="text-align:left;">-</td> <td style="text-align:left;">🎉<code>onRenderTracked</code></td></tr> <tr><td style="text-align:left;">-</td> <td style="text-align:left;">🎉<code>onRenderTriggered</code></td></tr></tbody></table>
<blockquote><p>上面是vue的声明周期的简单梳理，接下来我们直接以代码的形式来完成vue的初始化</p></blockquote>
<div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 初始化Vue实例</span>
<span class="token keyword">function</span> <span class="token function">_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	 <span class="token comment">// 挂载属性</span>
    <span class="token function">initLifeCycle</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> 
    <span class="token comment">// 初始化事件系统，钩子函数等</span>
    <span class="token function">initEvent</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> 
    <span class="token comment">// 编译slot、vnode</span>
    <span class="token function">initRender</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> 
    <span class="token comment">// 触发钩子</span>
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeCreate'</span><span class="token punctuation">)</span>
    <span class="token comment">// 添加inject功能</span>
    <span class="token function">initInjection</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
    <span class="token comment">// 完成数据响应性 props/data/watch/computed/methods</span>
    <span class="token function">initState</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
    <span class="token comment">// 添加 provide 功能</span>
    <span class="token function">initProvide</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
    <span class="token comment">// 触发钩子</span>
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'created'</span><span class="token punctuation">)</span>
		
	 <span class="token comment">// 挂载节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vm<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 挂载节点实现</span>
<span class="token keyword">function</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	 <span class="token comment">// 获取 render function</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// template to render</span>
        <span class="token comment">// Vue.compile = compileToFunctions</span>
        <span class="token keyword">let</span> <span class="token punctuation">{</span> render <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">compileToFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
        <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>render <span class="token operator">=</span> render
    <span class="token punctuation">}</span>
    <span class="token comment">// 触发钩子</span>
    <span class="token function">callHook</span><span class="token punctuation">(</span><span class="token string">'beforeMounte'</span><span class="token punctuation">)</span>
    <span class="token comment">// 初始化观察者</span>
    <span class="token comment">// render 渲染 vdom， </span>
    vdom <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// update: 根据 diff 出的 patchs 挂载成真实的 dom </span>
    vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vdom<span class="token punctuation">)</span>
    <span class="token comment">// 触发钩子  </span>
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'mounted'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 更新节点实现</span>
funtion <span class="token function">queueWatcher</span><span class="token punctuation">(</span><span class="token parameter">watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">nextTick</span><span class="token punctuation">(</span>flushScheduleQueue<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 清空队列</span>
<span class="token keyword">function</span> <span class="token function">flushScheduleQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	 <span class="token comment">// 遍历队列中所有修改</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	    <span class="token comment">// beforeUpdate</span>
        watcher<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         
        <span class="token comment">// 依赖局部更新节点</span>
        watcher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
        <span class="token function">callHook</span><span class="token punctuation">(</span><span class="token string">'updated'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 销毁实例实现</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$destory</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	 <span class="token comment">// 触发钩子</span>
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeDestory'</span><span class="token punctuation">)</span>
    <span class="token comment">// 自身及子节点</span>
    <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token comment">// 删除依赖</span>
    watcher<span class="token punctuation">.</span><span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token comment">// 删除监听</span>
    vm<span class="token punctuation">.</span><span class="token function">$off</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token comment">// 触发钩子</span>
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'destoryed'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div>
<h3 id="_8-vue-router"><a href="#_8-vue-router" class="header-anchor">#</a> 8 vue-router</h3>
<p><strong>mode</strong></p>
<ul><li><code>hash</code></li> <li><code>history</code></li></ul>
<p><strong>跳转</strong></p>
<ul><li><code>this.$router.push()</code></li> <li><code>&lt;router-link to=""&gt;&lt;/router-link&gt;</code></li></ul>
<p><strong>占位</strong></p>
<div class="language- extra-class"><pre class="language-text"><code>&lt;router-view&gt;&lt;/router-view&gt;
</code></pre></div>
<p><strong>vue-router源码实现</strong></p>
<ul><li>作为一个插件存在:实现<code>VueRouter</code>类和<code>install</code>方法</li> <li>实现两个全局组件:<code>router-view</code>用于显示匹配组件内容，<code>router-link</code>用于跳转</li> <li>监控<code>url</code>变化:监听<code>hashchange</code>或<code>popstate</code>事件</li> <li>响应最新<code>url</code>:创建一个响应式的属性<code>current</code>，当它改变时获取对应组件并显示</li></ul>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 我们的插件：</span>
<span class="token comment">// 1.实现一个Router类并挂载期实例</span>
<span class="token comment">// 2.实现两个全局组件router-link和router-view</span>
<span class="token keyword">let</span> Vue<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">VueRouter</span> <span class="token punctuation">{</span>
  <span class="token comment">// 核心任务：</span>
  <span class="token comment">// 1.监听url变化</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$options <span class="token operator">=</span> options<span class="token punctuation">;</span>

    <span class="token comment">// 缓存path和route映射关系</span>
    <span class="token comment">// 这样找组件更快</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>routeMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>routeMap<span class="token punctuation">[</span>route<span class="token punctuation">.</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> route
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 数据响应式</span>
    <span class="token comment">// 定义一个响应式的current，则如果他变了，那么使用它的组件会rerender</span>
    Vue<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'current'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>

    <span class="token comment">// 请确保onHashChange中this指向当前实例</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'hashchange'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onHashChange</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onHashChange</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">onHashChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.log(window.location.hash);</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'/'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 插件需要实现install方法</span>
<span class="token comment">// 接收一个参数，Vue构造函数，主要用于数据响应式</span>
VueRouter<span class="token punctuation">.</span><span class="token function-variable function">install</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">_Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 保存Vue构造函数在VueRouter中使用</span>
  Vue <span class="token operator">=</span> _Vue

  <span class="token comment">// 任务1：使用混入来做router挂载这件事情</span>
  Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">beforeCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 只有根实例才有router选项</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router
      <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 任务2：实现两个全局组件</span>
  <span class="token comment">// router-link: 生成一个a标签，在url后面添加#</span>
  <span class="token comment">// &lt;a href="#/about"&gt;aaaa&lt;/a&gt;</span>
  <span class="token comment">// &lt;router-link to="/about"&gt;aaa&lt;/router-link&gt;</span>
  Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'router-link'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">to</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span>
        <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// h(tag, props, children)</span>
      <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token literal-property property">attrs</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">href</span><span class="token operator">:</span> <span class="token string">'#'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>to <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">.</span>default
      <span class="token punctuation">)</span>
      <span class="token comment">// 使用jsx</span>
      <span class="token comment">// return &lt;a href={'#'+this.to}&gt;{this.$slots.default}&lt;/a&gt;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'router-view'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 根据current获取组件并render</span>
      <span class="token comment">// current怎么获取?</span>
      <span class="token comment">// console.log('render',this.$router.current);</span>
      <span class="token comment">// 获取要渲染的组件</span>
      <span class="token keyword">let</span> component <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> routeMap<span class="token punctuation">,</span> current <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$router
      <span class="token keyword">if</span> <span class="token punctuation">(</span>routeMap<span class="token punctuation">[</span>current<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        component <span class="token operator">=</span> routeMap<span class="token punctuation">[</span>current<span class="token punctuation">]</span><span class="token punctuation">.</span>component
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> VueRouter
</code></pre></div>
<h3 id="_9-vuex"><a href="#_9-vuex" class="header-anchor">#</a> 9 vuex</h3>
<blockquote><p>Vuex 集中式存储管理应用的所有组件的状态，并以相应的规则保证状态以可预测的方式发生变化</p></blockquote>
<p><strong>核心概念</strong></p>
<ul><li><code>state</code>: 状态中心</li> <li><code>mutations</code>: 更改状态</li> <li><code>actions</code>: 异步更改状态</li> <li><code>getters</code>: 获取状态</li> <li><code>modules</code>: 将<code>state</code>分成多个<code>modules</code>，便于管理</li></ul>
<ol><li>状态 <strong>- state</strong></li></ol>
<p>state保存应用状态</p>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">counter</span><span class="token operator">:</span><span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div>
<ol><li>状态变更 <strong>- mutations</strong></li></ol>
<blockquote><p><code>mutations</code>用于修改状态，<code>store.js</code></p></blockquote>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">mutations</span><span class="token operator">:</span>
    <span class="token punctuation">{</span>
      <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        state<span class="token punctuation">.</span>counter<span class="token operator">++</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div>
<ol><li>派生状态 <strong>- getters</strong></li></ol>
<blockquote><p>从state派生出新状态，类似计算属性</p></blockquote>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">getters</span><span class="token operator">:</span>
    <span class="token punctuation">{</span>
      <span class="token function">doubleCounter</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 计算剩余数量 return state.counter * 2;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div>
<ol><li>动作 <strong>- actions</strong></li></ol>
<p>加业务逻辑，类似于<code>controller</code></p>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">actions</span><span class="token operator">:</span>
    <span class="token punctuation">{</span>
      <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
        commit
      <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div>
<p>测试代码:</p>
<div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$store.commit(<span class="token punctuation">'</span>add<span class="token punctuation">'</span>)<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>counter: {{$store.state.counter}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$store.dispatch(<span class="token punctuation">'</span>add<span class="token punctuation">'</span>)<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>async counter: {{$store.state.counter}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>double:{{$store.getters.doubleCounter}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
</code></pre></div>
<p><strong>vuex原理解析</strong></p>
<ul><li>实现一个插件:声明<code>Store</code>类，挂载<code>$store</code></li> <li><code>Store</code>具体实现:
<ul><li>创建响应式的<code>state</code>，保存<code>mutations</code>、<code>actions</code>和<code>getters</code></li> <li>实现<code>commit</code>根据用户传入<code>type</code>执行对应<code>mutation</code></li> <li>实现<code>dispatch</code>根据用户传入<code>type</code>执行对应<code>action</code>，同时传递上下文</li> <li>实现<code>getters</code>，按照<code>getters</code>定义对<code>state</code>做派生</li></ul></li></ul>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 目标1：实现Store类，管理state（响应式的），commit方法和dispatch方法</span>
<span class="token comment">// 目标2：封装一个插件，使用更容易使用</span>
<span class="token keyword">let</span> Vue<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Store</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 定义响应式的state</span>
    <span class="token comment">// this.$store.state.xx</span>
    <span class="token comment">// 借鸡生蛋</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">$state</span><span class="token operator">:</span> options<span class="token punctuation">.</span>state
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token keyword">this</span><span class="token punctuation">.</span>_mutations <span class="token operator">=</span> options<span class="token punctuation">.</span>mutations
    <span class="token keyword">this</span><span class="token punctuation">.</span>_actions <span class="token operator">=</span> options<span class="token punctuation">.</span>actions

    <span class="token comment">// 绑定this指向</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>commit <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dispatch <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 只读</span>
  <span class="token keyword">get</span> <span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_vm<span class="token punctuation">.</span>_data<span class="token punctuation">.</span>$state
  <span class="token punctuation">}</span>

  <span class="token keyword">set</span> <span class="token function">state</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'不能直接赋值呀，请换别的方式！！天王盖地虎！！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 实现commit方法，可以修改state</span>
  <span class="token function">commit</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 拿出mutations中的处理函数执行它</span>
    <span class="token keyword">const</span> entry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_mutations<span class="token punctuation">[</span>type<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'未知mutaion类型'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token function">entry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> entry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_actions<span class="token punctuation">[</span>type<span class="token punctuation">]</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'未知action类型'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 上下文可以传递当前store实例进去即可</span>
    <span class="token function">entry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">install</span><span class="token punctuation">(</span><span class="token parameter">_Vue</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  Vue <span class="token operator">=</span> _Vue

  <span class="token comment">// 混入store实例</span>
  Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">beforeCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>store<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$store <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>store
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// { Store, install }相当于Vuex</span>
<span class="token comment">// 它必须实现install方法</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span> Store<span class="token punctuation">,</span> install <span class="token punctuation">}</span>
</code></pre></div>
<h3 id="_10-vue3带来的新特性-亮点"><a href="#_10-vue3带来的新特性-亮点" class="header-anchor">#</a> 10 vue3带来的新特性/亮点</h3>
<p><strong>1. 压缩包体积更小</strong></p>
<blockquote><p>当前最小化并被压缩的 Vue 运行时大小约为 20kB（2.6.10 版为 22.8kB）。Vue 3.0捆绑包的大小大约会减少一半，即只有10kB！</p></blockquote>
<p><strong>2. Object.defineProperty -&gt; Proxy</strong></p>
<ul><li><code>Object.defineProperty</code>是一个相对比较昂贵的操作，因为它直接操作对象的属性，颗粒度比较小。将它替换为es6的<code>Proxy</code>，在目标对象之上架了一层拦截，代理的是对象而不是对象的属性。这样可以将原本对对象属性的操作变为对整个对象的操作，颗粒度变大。</li> <li>javascript引擎在解析的时候希望对象的结构越稳定越好，如果对象一直在变，可优化性降低，proxy不需要对原始对象做太多操作。</li></ul>
<p><strong>3. Virtual DOM 重构</strong></p>
<blockquote><p>vdom的本质是一个抽象层，用javascript描述界面渲染成什么样子。react用jsx，没办法检测出可以优化的动态代码，所以做时间分片，vue中足够快的话可以不用时间分片</p></blockquote>
<ul><li><p><strong>传统vdom的性能瓶颈：</strong></p> <ul><li>虽然 Vue 能够保证触发更新的组件最小化，但在单个组件内部依然需要遍历该组件的整个 vdom 树。</li> <li>传统 vdom 的性能跟模版大小正相关，跟动态节点的数量无关。在一些组件整个模版内只有少量动态节点的情况下，这些遍历都是性能的浪费。</li> <li>JSX 和手写的 render function 是完全动态的，过度的灵活性导致运行时可以用于优化的信息不足</li></ul></li> <li><p><strong>那为什么不直接抛弃vdom呢？</strong></p> <ul><li>高级场景下手写 <code>render function</code> 获得更强的表达力</li> <li>生成的代码更简洁</li> <li>兼容2.x</li></ul></li></ul>
<blockquote><p>vue的特点是底层为Virtual DOM，上层包含有大量静态信息的模版。为了兼容手写 render function，最大化利用模版静态信息，<code>vue3.0采用了动静结合的解决方案</code>，将vdom的操作颗粒度变小，每次触发更新不再以组件为单位进行遍历，主要更改如下</p></blockquote>
<ul><li>将模版基于动态节点指令切割为嵌套的区块</li> <li>每个区块内部的节点结构是固定的</li> <li>每个区块只需要以一个 <code>Array</code> 追踪自身包含的动态节点</li></ul>
<blockquote><p>vue3.0将 vdom 更新性能由与模版整体大小相关提升为与动态内容的数量相关</p></blockquote>
<p><strong>Vue 3.0 动静结合的 Dom diff</strong></p>
<blockquote><ul><li>Vue3.0 提出动静结合的 DOM diff 思想，动静结合的 DOM diff其实是在预编译阶段进行了优化。之所以能够做到预编译优化，是因为 Vue core 可以静态分析 template，在解析模版时，整个 parse 的过程是利用正则表达式顺序解析模板，当解析到开始标签、闭合标签和文本的时候都会分别执行对应的回调函数，来达到构造 AST 树的目的。</li> <li>借助预编译过程，Vue 可以做到的预编译优化就很强大了。比如在预编译时标记出模版中可能变化的组件节点，再次进行渲染前 diff 时就可以跳过“永远不会变化的节点”，而只需要对比“可能会变化的动态节点”。这也就是动静结合的 DOM diff 将 diff 成本与模版大小正相关优化到与动态节点正相关的理论依据。</li></ul></blockquote>
<p><strong>4. Performance</strong></p>
<blockquote><p>vue3在性能方面比vue2快了2倍。</p></blockquote>
<ul><li>重写了虚拟DOM的实现</li> <li>运行时编译</li> <li>update性能提高</li> <li>SSR速度提高</li></ul>
<p><strong>5. Tree-shaking support</strong></p>
<blockquote><p>vue3中的核心api都支持了tree-shaking，这些api都是通过包引入的方式而不是直接在实例化时就注入，只会对使用到的功能或特性进行打包（按需打包），这意味着更多的功能和更小的体积。</p></blockquote>
<p><strong>6. Composition API</strong></p>
<blockquote><p>vue2中，我们一般会采用mixin来复用逻辑代码，用倒是挺好用的，不过也存在一些问题：例如代码来源不清晰、方法属性等冲突。基于此在vue3中引入了Composition API（组合API），使用纯函数分隔复用代码。和React中的<code>hooks</code>的概念很相似</p></blockquote>
<ul><li>更好的逻辑复用和代码组织</li> <li>更好的类型推导</li></ul>
<div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>X: {{ x }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>Y: {{ y }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> onMounted<span class="token punctuation">,</span> onUnmounted<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"vue"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">useMouseMove</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> y <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">move</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        x<span class="token punctuation">.</span>value <span class="token operator">=</span> e<span class="token punctuation">.</span>clientX<span class="token punctuation">;</span>
        y<span class="token punctuation">.</span>value <span class="token operator">=</span> e<span class="token punctuation">.</span>clientY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"mousemove"</span><span class="token punctuation">,</span> move<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">onUnmounted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">"mousemove"</span><span class="token punctuation">,</span> move<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useMouseMove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div>
<p><strong>7. 新增的三个组件Fragment、Teleport、Suspense</strong></p>
<p><strong>Fragment</strong></p>
<blockquote><p>在书写vue2时，由于组件必须只有一个根节点，很多时候会添加一些没有意义的节点用于包裹。Fragment组件就是用于解决这个问题的（这和React中的Fragment组件是一样的）。</p></blockquote>
<p>这意味着现在可以这样写组件了。</p>
<div class="language-html extra-class"><pre class="language-html"><code>/* App.vue */
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>header</span><span class="token punctuation">&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>header</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>main</span> <span class="token attr-name">v-bind</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$attrs<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>main</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>footer</span><span class="token punctuation">&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>footer</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div>
<p>或者这样</p>
<div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> h<span class="token punctuation">,</span> Fragment <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>Fragment<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
            <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'header'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'...'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'main'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'...'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'footer'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'...'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p><strong>Teleport</strong></p>
<blockquote><p>Teleport其实就是React中的Portal。Portal 提供了一种将子节点渲染到存在于父组件以外的 DOM 节点的优秀的方案。</p></blockquote>
<p>一个 portal 的典型用例是当父组件有 overflow: hidden 或 z-index 样式时，但你需要子组件能够在视觉上“跳出”其容器。例如，对话框、悬浮卡以及提示框。</p>
<div class="language-html extra-class"><pre class="language-html"><code>/* App.vue */
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>123<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Teleport</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#container<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        Teleport
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Teleport</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"vue"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

/* index.html */
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div>
<p><img alt="" src="https://s.poetries.top/images/20210407162653.png"></p>
<p><strong>Suspense</strong></p>
<p>同样的，这和React中的Supense是一样的。</p>
<blockquote><p><code>Suspense</code> 让你的组件在渲染之前进行“等待”，并在等待时显示 fallback 的内容</p></blockquote>
<div class="language-html extra-class"><pre class="language-html"><code>// App.vue
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Suspense</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">#default</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AsyncComponent</span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">#fallback</span><span class="token punctuation">&gt;</span></span>
            Loading...
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Suspense</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ts<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"vue"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> AsyncComponent <span class="token keyword">from</span> <span class="token string">'./AsyncComponent.vue'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"App"</span><span class="token punctuation">,</span>
    
    <span class="token literal-property property">components</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        AsyncComponent
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

// AsyncComponent.vue
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>Async Component<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ts<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"vue"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div>
<p><strong>8. Better TypeScript support</strong></p>
<blockquote><p>在vue2中使用过TypesScript的童鞋应该有过体会，写起来实在是有点难受。vue3则是使用ts进行了重写，开发者使用vue3时拥有更好的类型支持和更好的编写体验。</p></blockquote>
<h3 id="_11-compositon-api"><a href="#_11-compositon-api" class="header-anchor">#</a> 11 Compositon api</h3>
<p><code>Composition API</code>也叫组合式API，是Vue3.x的新特性。</p>
<blockquote><p>通过创建 Vue 组件，我们可以将接口的可重复部分及其功能提取到可重用的代码段中。仅此一项就可以使我们的应用程序在可维护性和灵活性方面走得更远。然而，我们的经验已经证明，光靠这一点可能是不够的，尤其是当你的应用程序变得非常大的时候——想想几百个组件。在处理如此大的应用程序时，共享和重用代码变得尤为重要</p></blockquote>
<ul><li>Vue2.0中，随着功能的增加，组件变得越来越复杂，越来越难维护，而难以维护的根本原因是Vue的API设计迫使开发者使用<code>watch，computed，methods</code>选项组织代码，而不是实际的业务逻辑。</li> <li>另外Vue2.0缺少一种较为简洁的低成本的机制来完成逻辑复用，虽然可以<code>minxis</code>完成逻辑复用，但是当<code>mixin</code>变多的时候，会使得难以找到对应的<code>data、computed</code>或者<code>method</code>来源于哪个<code>mixin</code>，使得类型推断难以进行。</li> <li>所以<code>Composition API</code>的出现，主要是也是为了解决Option API带来的问题，第一个是代码组织问题，<code>Compostion API</code>可以让开发者根据业务逻辑组织自己的代码，让代码具备更好的可读性和可扩展性，也就是说当下一个开发者接触这一段不是他自己写的代码时，他可以更好的利用代码的组织反推出实际的业务逻辑，或者根据业务逻辑更好的理解代码。</li> <li>第二个是实现代码的逻辑提取与复用，当然<code>mixin</code>也可以实现逻辑提取与复用，但是像前面所说的，多个<code>mixin</code>作用在同一个组件时，很难看出<code>property</code>是来源于哪个<code>mixin</code>，来源不清楚，另外，多个<code>mixin</code>的<code>property</code>存在变量命名冲突的风险。而<code>Composition API</code>刚好解决了这两个问题。</li></ul>
<p><strong>通俗的讲：</strong></p>
<p>没有<code>Composition API</code>之前vue相关业务的代码需要配置到option的特定的区域，中小型项目是没有问题的，但是在大型项目中会导致后期的维护性比较复杂，同时代码可复用性不高。Vue3.x中的composition-api就是为了解决这个问题而生的</p>
<p><strong>compositon api提供了以下几个函数：</strong></p>
<ul><li><code>setup</code></li> <li><code>ref</code></li> <li><code>reactive</code></li> <li><code>watchEffect</code></li> <li><code>watch</code></li> <li><code>computed</code></li> <li><code>toRefs</code></li> <li>生命周期的<code>hooks</code></li></ul>
<p><strong>都说Composition API与React Hook很像，说说区别</strong></p>
<blockquote><p>从React Hook的实现角度看，React Hook是根据useState调用的顺序来确定下一次重渲染时的state是来源于哪个useState，所以出现了以下限制</p></blockquote>
<ul><li>不能在循环、条件、嵌套函数中调用Hook</li> <li>必须确保总是在你的React函数的顶层调用Hook</li> <li><code>useEffect、useMemo</code>等函数必须手动确定依赖关系</li></ul>
<blockquote><p>而Composition API是基于Vue的响应式系统实现的，与React Hook的相比</p></blockquote>
<ul><li>声明在<code>setup</code>函数内，一次组件实例化只调用一次<code>setup</code>，而React Hook每次重渲染都需要调用Hook，使得React的GC比Vue更有压力，性能也相对于Vue来说也较慢</li> <li><code>Compositon API</code>的调用不需要顾虑调用顺序，也可以在循环、条件、嵌套函数中使用</li> <li>响应式系统自动实现了依赖收集，进而组件的部分的性能优化由Vue内部自己完成，而<code>React Hook</code>需要手动传入依赖，而且必须必须保证依赖的顺序，让<code>useEffect</code>、<code>useMemo</code>等函数正确的捕获依赖变量，否则会由于依赖不正确使得组件性能下降。</li></ul>
<blockquote><p>虽然<code>Compositon API</code>看起来比<code>React Hook</code>好用，但是其设计思想也是借鉴<code>React Hook</code>的。</p></blockquote>
<h3 id="_12-computed-的实现原理"><a href="#_12-computed-的实现原理" class="header-anchor">#</a> 12 computed 的实现原理</h3>
<blockquote><p><code>computed</code> 本质是一个惰性求值的观察者<code>computed watcher</code>。其内部通过 <code>this.dirty</code> 属性标记计算属性是否需要重新求值。</p></blockquote>
<ul><li>当 computed 的依赖状态发生改变时,就会通知这个惰性的 watcher,<code>computed watcher</code> 通过 <code>this.dep.subs.length</code> 判断有没有订阅者,</li> <li>有的话,会重新计算,然后对比新旧值,如果变化了,会重新渲染。 (Vue 想确保不仅仅是计算属性依赖的值发生变化，而是当计算属性<code>最终计算的值</code>发生变化时才会<code>触发渲染 watcher</code> 重新渲染，本质上是一种优化。)</li> <li>没有的话,仅仅把 <code>this.dirty = true</code> (当计算属性依赖于其他数据时，属性并不会立即重新计算，只有之后其他地方需要读取属性的时候，它才会真正计算，即具备 lazy（懒计算）特性。)</li></ul>
<h3 id="_13-watch-的理解"><a href="#_13-watch-的理解" class="header-anchor">#</a> 13 watch 的理解</h3>
<p><code>watch</code>没有缓存性，更多的是观察的作用，可以监听某些数据执行回调。当我们需要<code>深度监听对象中</code>的属性时，可以打开deep：true选项，这样便会对对象中的每一项进行监听。这样会带来性能问题，优化的话可以使用字符串形式监听</p>
<blockquote><p>注意：Watcher : 观察者对象 , 实例分为<code>渲染 watcher</code> (render watcher),<code>计算属性 watcher</code> (computed watcher),<code>侦听器 watcher</code>（user watcher）三种</p></blockquote>
<h3 id="_14-vue-渲染过程"><a href="#_14-vue-渲染过程" class="header-anchor">#</a> 14 vue 渲染过程</h3>
<p><img alt="" src="https://s.poetries.top/images/20210504211204.png"></p>
<ul><li>调用 <code>compile</code> 函数,生成 render 函数字符串 ,编译过程如下:
<ul><li>parse 使用大量的正则表达式对template字符串进行解析，将标签、指令、属性等转化为抽象语法树AST。<code>模板 -&gt; AST （最消耗性能）</code></li> <li>optimize 遍历AST，找到其中的一些静态节点并进行标记，方便在页面重渲染的时候进行diff比较时，直接跳过这一些静态节点，<code>优化runtime的性能</code></li> <li>generate 将最终的AST转化为render函数字符串</li></ul></li> <li>调用 <code>new Watcher</code> 函数,监听数据的变化,当数据发生变化时，Render 函数执行生成 vnode 对象</li> <li>调用 <code>patch</code> 方法,对比新旧 vnode 对象,通过 DOM diff 算法,添加、修改、删除真正的 DOM 元素</li></ul>
<h3 id="_15-说一说keep-alive实现原理"><a href="#_15-说一说keep-alive实现原理" class="header-anchor">#</a> 15 说一说keep-alive实现原理</h3>
<blockquote><p>keep-alive<code>组件接受三个属性参数：</code>include<code>、</code>exclude<code>、</code>max</p></blockquote>
<ul><li><code>include</code> 指定需要缓存的<code>组件name</code>集合，参数格式支持<code>String, RegExp, Array。</code>当为字符串的时候，多个组件名称以逗号隔开。</li> <li><code>exclude</code> 指定不需要缓存的<code>组件name</code>集合，参数格式和include一样。</li> <li><code>max</code> 指定最多可缓存组件的数量,超过数量删除第一个。参数格式支持String、Number。</li></ul>
<p><strong>原理</strong></p>
<p><code>keep-alive</code>实例会缓存对应组件的<code>VNode</code>,如果命中缓存，直接从缓存对象返回对应<code>VNode</code></p>
<p><code>LRU（Least recently used）</code> 算法根据数据的历史访问记录来进行淘汰数据，其核心思想是“如果数据最近被访问过，那么将来被访问的几率也更高”。(墨菲定律：越担心的事情越会发生)</p>
<h3 id="_16-为什么访问data属性不需要带data"><a href="#_16-为什么访问data属性不需要带data" class="header-anchor">#</a> 16 为什么访问data属性不需要带data</h3>
<blockquote><p>vue中访问属性代理 <code>this.data.xxx</code> 转换 <code>this.xxx</code> 的实现</p></blockquote>
<div class="language-js extra-class"><pre class="language-js"><code> <span class="token comment">/** 将 某一个对象的属性 访问 映射到 对象的某一个属性成员上 */</span>
<span class="token keyword">function</span> <span class="token function">proxy</span><span class="token punctuation">(</span> <span class="token parameter">target<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> key</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span> target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> target<span class="token punctuation">[</span> prop <span class="token punctuation">]</span><span class="token punctuation">[</span> key <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span> <span class="token punctuation">(</span> newVal <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      target<span class="token punctuation">[</span> prop <span class="token punctuation">]</span><span class="token punctuation">[</span> key <span class="token punctuation">]</span> <span class="token operator">=</span> newVal<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<h3 id="_17-template预编译是什么"><a href="#_17-template预编译是什么" class="header-anchor">#</a> 17 template预编译是什么</h3>
<p>对于 Vue 组件来说，模板编译只会在组件实例化的时候编译一次，生成渲染函数之后在也不会进行编译。因此，编译对组件的 runtime 是一种性能损耗。</p>
<blockquote><p>而模板编译的目的仅仅是将template转化为render function，这个过程，正好可以在项目构建的过程中完成，这样可以让实际组件在 runtime 时直接跳过模板渲染，进而提升性能，这个在项目构建的编译template的过程，就是预编译。</p></blockquote>
<h3 id="_18-介绍一下vue中的diff算法"><a href="#_18-介绍一下vue中的diff算法" class="header-anchor">#</a> 18 介绍一下Vue中的Diff算法</h3>
<p>在新老虚拟DOM对比时</p>
<ul><li>首先，对比节点本身，判断是否为同一节点，如果不为相同节点，则删除该节点重新创建节点进行替换</li> <li>如果为相同节点，进行patchVnode，判断如何对该节点的子节点进行处理，先判断一方有子节点一方没有子节点的情况(如果新的children没有子节点，将旧的子节点移除)</li> <li>比较如果都有子节点，则进行updateChildren，判断如何对这些新老节点的子节点进行操作（diff核心）。
匹配时，找到相同的子节点，递归比较子节点</li></ul>
<blockquote><p>在diff中，只对同层的子节点进行比较，放弃跨级的节点比较，使得时间复杂从O(n^3)降低值O(n)，也就是说，只有当新旧children都为多个子节点时才需要用核心的Diff算法进行同层级比较。</p></blockquote>
<h3 id="_19-说说vue2-0和vue3-0有什么区别"><a href="#_19-说说vue2-0和vue3-0有什么区别" class="header-anchor">#</a> 19 说说Vue2.0和Vue3.0有什么区别</h3>
<ul><li>重构响应式系统，使用<code>Proxy</code>替换<code>Object.defineProperty</code>，使用<code>Proxy</code>优势：
<ul><li>可直接监听数组类型的数据变化</li> <li>监听的目标为对象本身，不需要像<code>Object.defineProperty</code>一样遍历每个属性，有一定的性能提升</li> <li>可拦截<code>apply、ownKeys、has</code>等13种方法，而<code>Object.defineProperty</code>不行</li> <li>直接实现对象属性的新增/删除</li></ul></li> <li>新增<code>Composition API</code>，更好的逻辑复用和代码组织</li> <li>重构 <code>Virtual DOM</code> <ul><li>模板编译时的优化，将一些静态节点编译成常量</li> <li><code>slot</code>优化，将<code>slot</code>编译为<code>lazy</code>函数，将<code>slot</code>的渲染的决定权交给子组件</li> <li>模板中内联事件的提取并重用（原本每次渲染都重新生成内联函数）</li></ul></li> <li>代码结构调整，更便于Tree shaking，使得体积更小</li> <li>使用Typescript替换Flow</li></ul>
</div>